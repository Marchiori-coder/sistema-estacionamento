<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Estacionamento (Vue.js)</title>
    <!-- SDKs do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Vue.js 3 via CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        /* O CSS original foi mantido para preservar o layout. [1] */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--p:clamp(10px,2vw,30px);--f:clamp(0.8rem,1.5vw,1rem);--r:clamp(8px,1vw,15px)}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:var(--p);font-size:var(--f)}
        [v-cloak] { display: none; }
        .modal-login{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:10000;opacity:0;visibility:hidden;transition:all .3s}
        .modal-login.show{opacity:1;visibility:visible}
        .login-box{background:white;padding:30px;border-radius:var(--r);text-align:center;max-width:400px;width:90%}
        .login-input{width:100%;padding:12px;margin:8px 0;border:2px solid #ecf0f1;border-radius:8px;font-size:var(--f)}
        .login-btn{width:100%;padding:12px;background:#3498db;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
        .close-modal{position:absolute;top:15px;right:20px;background:none;border:none;font-size:2rem;cursor:pointer;color:#7f8c8d}
        .container{max-width:min(1600px,95vw);margin:0 auto;background:white;border-radius:var(--r);box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden}
        .header{background:linear-gradient(135deg,#2c3e50,#3498db);color:white;padding:var(--p);text-align:center;position:relative;padding-top:clamp(60px,8vw,100px)}
        .header h1{font-size:clamp(1.5rem,4vw,2.5rem);margin-bottom:10px}
        .user-info{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.25);padding:10px 20px;border-radius:25px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .user-badge{background:#27ae60;color:white;padding:6px 12px;border-radius:15px;font-size:0.8rem;font-weight:bold}
        .user-badge.admin{background:#f39c12}
        .admin-login-btn,.logout-btn{background:#3498db;color:white;border:none;padding:8px 15px;border-radius:15px;cursor:pointer;font-size:0.8rem;font-weight:bold}
        .logout-btn{background:#e74c3c}
        .status-firebase{position:fixed;top:var(--p);left:var(--p);padding:10px 15px;border-radius:20px;color:white;font-weight:bold;z-index:1000;display:flex;align-items:center;gap:8px;font-size:0.8rem}
        .status-firebase.conectado{background:#27ae60}
        .status-firebase.desconectado{background:#e74c3c}
        .indicador-firebase{width:10px;height:10px;border-radius:50%;background:white;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .admin-panel{background:linear-gradient(135deg,#f39c12,#e67e22);color:white;padding:20px;text-align:center;}
        .admin-controls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
        .admin-btn{padding:10px 15px;background:rgba(255,255,255,0.2);color:white;border:2px solid white;border-radius:20px;cursor:pointer;font-weight:bold;font-size:0.8rem}
        .admin-btn:hover,.admin-btn.active{background:white;color:#f39c12}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:15px;margin-top:20px}
        .stat-box{background:rgba(255,255,255,0.2);padding:15px;border-radius:10px;text-align:center}
        .stat-number{font-size:clamp(1.2rem,3vw,1.8rem);font-weight:bold;display:block}
        .estacionamento-wrapper{padding:var(--p);background:#f8f9fa;min-height:70vh;position:relative}
        .estacionamento-container{position:relative;width:100%;max-width:1600px;height:clamp(800px,90vh,1600px);margin:0 auto;background:#e8e8e8;border-radius:var(--r);border:3px solid #34495e;overflow:auto;transform-origin:center;transition:transform 0.3s;-webkit-overflow-scrolling:touch}
        .planta-baixa{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-repeat:no-repeat;background-position:center;opacity:0.8;z-index:1;transform-origin:center;transition:all 0.3s}
        .planta-baixa.ajustavel{border:2px dashed #3498db;opacity:0.9}
        .zoom-controls,.planta-controls{position:absolute;background:rgba(255,255,255,0.95);padding:15px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:150;cursor:move;user-select:none}
        .zoom-controls{top:20px;left:20px}
        .planta-controls{top:20px;right:20px}
        .zoom-controls.dragging,.planta-controls.dragging{z-index:200;box-shadow:0 8px 25px rgba(0,0,0,0.4);transform:scale(1.05)}
        .zoom-controls h4,.planta-controls h4{color:#34495e;margin-bottom:10px;font-size:0.8rem;cursor:move;padding:5px;background:rgba(52,73,94,0.1);border-radius:5px;text-align:center}
        .zoom-btn,.planta-btn{padding:8px 12px;margin:2px;color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
        .zoom-btn{background:#3498db}
        .planta-btn{background:#e67e22;display:block;width:100%;margin-bottom:5px}
        .vaga{position:absolute;width:clamp(25px,4vw,45px);height:clamp(40px,6vw,75px);border:2px solid #2c3e50;background:rgba(39,174,96,0.9);display:flex!important;justify-content:center;align-items:center;font-size:clamp(6px,1.2vw,10px);font-weight:bold;color:white;border-radius:4px;cursor:pointer;transition:all 0.3s;z-index:10;user-select:none}
        .vaga:hover{transform:scale(1.1);z-index:100}
        .vaga.viewer-mode{cursor:default!important}
        .vaga.viewer-mode:hover{transform:none!important}
        .livre{background:rgba(39,174,96,0.9)!important}
        .ocupada{background:rgba(231,76,60,0.9)!important}
        .modo-edicao .vaga{cursor:move!important;border:3px dashed #f39c12!important;background:rgba(243,156,18,0.8)!important}
        .vaga.selecionada{border:4px solid #9b59b6!important;background:rgba(155,89,182,0.9)!important;z-index:1000!important}
        .vaga.multipla-selecionada{border:4px solid #e67e22!important;background:rgba(230,126,34,0.9)!important;z-index:999!important}
        .vaga.arrastando{z-index:1001!important;transform:scale(1.2)!important;opacity:0.8;box-shadow:0 8px 20px rgba(0,0,0,0.3)}
        .edit-controls{position:fixed;top:50%;right:20px;transform:translateY(-50%);background:white;padding:20px;border-radius:15px;box-shadow:0 15px 40px rgba(0,0,0,0.3);z-index:1000;min-width:280px;max-height:85vh;overflow-y:auto}
        .edit-section{margin-bottom:20px}
        .edit-section h4{color:#34495e;margin-bottom:10px;font-size:0.8rem}
        .edit-btn{width:100%;padding:10px;margin:5px 0;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.8rem}
        .edit-btn.rotate{background:#3498db;color:white}
        .edit-btn.resize{background:#e67e22;color:white}
        .edit-btn.action{background:#9b59b6;color:white}
        .edit-btn.delete{background:#e74c3c;color:white}
        .edit-btn.multi{background:#27ae60;color:white}
        .size-controls{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .size-btn{padding:8px;background:#95a5a6;color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
        .position-controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
        .position-btn{padding:6px;background:#2c3e50;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem}
        .controles{padding:30px;background:#ecf0f1;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;justify-items:center}
        .btn{padding:12px 20px;border:none;border-radius:20px;cursor:pointer;font-weight:bold;font-size:0.8rem;transition:all 0.3s;min-width:120px}
        .btn:hover{transform:translateY(-2px)}
        .btn:disabled{opacity:0.3;cursor:not-allowed}
        .btn-reset{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:white}
        .btn-ocupar{background:linear-gradient(135deg,#e74c3c,#c0392b);color:white}
        .btn-liberar{background:linear-gradient(135deg,#27ae60,#2ecc71);color:white}
        .btn-salvar{background:linear-gradient(135deg,#3498db,#2980b9);color:white}
        .btn-firebase{background:linear-gradient(135deg,#ff9800,#f57c00);color:white}
        .notificacao{position:fixed;bottom:20px;right:20px;background:#2c3e50;color:white;padding:15px 20px;border-radius:10px;z-index:1000;max-width:min(350px,90vw);transform:translateX(400px);transition:transform 0.3s}
        .notificacao.mostrar{transform:translateX(0)}
        .notificacao.sucesso{background:#27ae60}
        .notificacao.erro{background:#e74c3c}
        .notificacao.info{background:#3498db}
        @media (max-width:768px){.user-info{position:static;margin-bottom:15px;justify-content:center}.header{padding-top:20px}.status-firebase{position:relative;margin-bottom:10px;align-self:flex-start}.edit-controls{position:fixed;top:0;right:0;left:0;bottom:0;transform:none;max-height:100vh;border-radius:0}.estacionamento-container{height:clamp(400px,60vh,600px);overflow:auto;-webkit-overflow-scrolling:touch;min-width:800px}.estacionamento-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch;padding:10px}.zoom-controls,.planta-controls{display:none!important}.controles{grid-template-columns:repeat(2,1fr);gap:10px;padding:15px}.vaga{width:clamp(30px,8vw,50px);height:clamp(50px,10vw,80px);font-size:clamp(8px,2vw,12px)}.admin-panel{padding:10px}.admin-controls{gap:5px}.admin-btn{padding:8px 12px;font-size:0.7rem}}
        @media (max-width:480px){.estacionamento-container{height:clamp(350px,50vh,500px);min-width:1000px}.vaga{width:clamp(35px,10vw,55px);height:clamp(55px,12vw,85px);font-size:clamp(9px,2.5vw,14px)}.controles{grid-template-columns:1fr;gap:8px;padding:10px}.btn{min-width:100px;padding:10px 15px;font-size:0.7rem}.header h1{font-size:clamp(1.2rem,5vw,1.8rem)}.stats{grid-template-columns:repeat(2,1fr);gap:10px}.stat-box{padding:10px}.stat-number{font-size:clamp(1rem,4vw,1.4rem)}}
        @media (hover: none) and (pointer: coarse) {.vaga:hover{transform:none!important}.btn:hover{transform:none!important}.estacionamento-container{overflow:auto;scroll-behavior:smooth}.estacionamento-wrapper{touch-action:pan-x pan-y}}
        @media (min-width:1920px) and (max-width:2560px){.estacionamento-container{height:clamp(1100px,90vh,1700px);max-width:1800px}.vaga{width:clamp(45px,3vw,60px);height:clamp(75px,5vw,90px);font-size:clamp(10px,1vw,14px)}}
        @media (min-width:2560px){.estacionamento-container{height:clamp(1300px,85vh,1800px);max-width:2000px}.vaga{width:clamp(50px,2.5vw,70px);height:clamp(80px,4vw,110px);font-size:clamp(12px,0.8vw,16px)}}
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div class="modal-login" :class="{ show: ui.loginModal.show }">
        <div class="login-box">
            <button class="close-modal" @click="ui.loginModal.show = false">×</button>
            <h2>🔐 Login Administrador</h2>
            <input type="text" class="login-input" placeholder="Usuário" v-model="ui.loginModal.user">
            <input type="password" class="login-input" placeholder="Senha" v-model="ui.loginModal.pass" @keyup.enter="handleLogin">
            <button class="login-btn" @click="handleLogin">Entrar como Admin</button>
        </div>
    </div>

    <div class="status-firebase" :class="firebase.connected ? 'conectado' : 'desconectado'">
        <div class="indicador-firebase"></div>
        <span>{{ firebase.connected ? 'Firebase Conectado' : 'Firebase Desconectado' }}</span>
    </div>

    <div class="container">
        <div class="header">
            <div class="user-info">
                <span>{{ user.name }}</span>
                <span class="user-badge" :class="{ admin: user.isAdmin }">{{ user.isAdmin ? 'ADMIN' : 'VIEWER' }}</span>
                <button v-if="!user.isAdmin" class="admin-login-btn" @click="ui.loginModal.show = true">Login Admin</button>
                <button v-else class="logout-btn" @click="handleLogout">Sair</button>
            </div>
            
            <h1>🚗 SMAMUS - Sistema de Estacionamento</h1>
            <p><strong>Última atualização:</strong> <span>{{ ui.lastUpdate }}</span></p>
            
            <div class="stats">
                <div class="stat-box"><span class="stat-number">{{ stats.total }}</span><span>Total</span></div>
                <div class="stat-box"><span class="stat-number">{{ stats.free }}</span><span>Livres</span></div>
                <div class="stat-box"><span class="stat-number">{{ stats.occupied }}</span><span>Ocupadas</span></div>
                <div class="stat-box"><span class="stat-number">{{ stats.occupationRate }}%</span><span>Ocupação</span></div>
            </div>
        </div>
        <div class="admin-panel" v-if="user.isAdmin">
            <h3>🔧 Painel de Administração</h3>
            <div class="admin-controls">
                <button class="admin-btn" :class="{active: ui.editMode}" @click="toggleEditMode">✏️ {{ ui.editMode ? 'Finalizar' : 'Edição' }}</button>
                <button class="admin-btn" @click="addSpot">➕ Nova Vaga</button>
                <button class="admin-btn" @click="() => this.$refs.plantaInput.click()">🖼️ Planta</button>
                <button class="admin-btn" :class="{active: ui.editPlanta}" @click="toggleEditPlanta">📐 {{ ui.editPlanta ? '✅ Finalizar Planta' : 'Ajustar Planta' }}</button>
                <button class="admin-btn" @click="exportLayout">📤 Exportar</button>
                <button class="admin-btn" @click="() => this.$refs.importInput.click()">📥 Importar</button>
                <button class="admin-btn" :class="{active: ui.multiSelect}" @click="toggleMultiSelect">🔲 {{ ui.multiSelect ? '✅ Multi' : 'Multi' }}</button>
            </div>
        </div>

        <div class="estacionamento-wrapper">
             <div class="zoom-controls" v-show="ui.editMode" :style="{ top: ui.zoomControlsPos.y + 'px', left: ui.zoomControlsPos.x + 'px' }">
                <h4 @mousedown.prevent="dragPanel('zoomControls', $event)">🔍 Zoom - Arraste</h4>
                <!-- Controles de zoom... -->
            </div>

            <div class="planta-controls" v-show="ui.editMode" :style="{ top: ui.plantaControlsPos.y + 'px', right: ui.plantaControlsPos.x + 'px' }">
                <h4 @mousedown.prevent="dragPanel('plantaControls', $event)">📐 Planta - Arraste</h4>
                <!-- Controles da planta... -->
            </div>
            
            <div class="estacionamento-container" :class="{'modo-edicao': ui.editMode}" ref="mapContainer" :style="mapStyle">
                <div class="planta-baixa" :class="{'ajustavel': ui.editPlanta}" :style="plantStyle"></div>
                <div v-for="spot in spots"
                     :key="spot.id"
                     class="vaga"
                     :class="[spot.status, {
                         'selecionada': ui.selectedSpotId === spot.id,
                         'multipla-selecionada': ui.multiSelectedIds.includes(spot.id),
                         'arrastando': ui.draggingSpotId === spot.id,
                         'viewer-mode': !user.isAdmin
                     }]"
                     :style="spotStyle(spot)"
                     @mousedown.prevent="startDrag(spot, $event)"
                     @click.stop="handleSpotClick(spot)">
                    {{ spot.id }}
                </div>
            </div>
        </div>

        <div class="edit-controls" v-if="user.isAdmin && (ui.selectedSpotId || ui.multiSelectedIds.length > 0)">
            <!-- Painel de edição... completo abaixo -->
        </div>

        <div class="controles">
            <button class="btn btn-reset" :disabled="!user.isAdmin" @click="setAllSpotsStatus('livre')">🔄 Resetar</button>
            <button class="btn btn-ocupar" :disabled="!user.isAdmin" @click="setAllSpotsStatus('ocupada')">🚗 Ocupar</button>
            <button class="btn btn-liberar" :disabled="!user.isAdmin" @click="setAllSpotsStatus('livre')">✅ Liberar</button>
            <button class="btn btn-salvar" @click="saveStateLocal">💾 Salvar</button>
            <button class="btn btn-firebase" :disabled="!user.isAdmin || !firebase.connected" @click="saveToFirebase">🌐 Firebase</button>
        </div>
    </div>
    <input type="file" ref="importInput" accept=".json" style="display:none;" @change="importLayout">
    <input type="file" ref="plantaInput" accept="image/*" style="display:none;" @change="uploadPlant">
    <div class="notificacao" v-for="n in notifications" :key="n.id" :class="['mostrar', n.type]">{{ n.message }}</div>
</div>

<script>
    const { createApp, reactive } = Vue;

    const firebaseConfig = {
        apiKey: "AIzaSyCRIgCndKlfXxR7NNnq_qGupgAWyLqzYzc",
        authDomain: "teste-dbacd.firebaseapp.com",
        databaseURL: "https://teste-dbacd-default-rtdb.firebaseio.com/",
        projectId: "teste-dbacd",
        storageBucket: "teste-dbacd.firebasestorage.app",
        messagingSenderId: "381642195685",
        appId: "1:381642195685:web:746eb4df7667813b0e4a0c"
    };

    createApp({
        data() {
            return {
                firebase: { db: null, connected: false },
                user: { name: 'Visualizador Público', isAdmin: false },
                spots: [],
                nextSpotId: 1,
                plantConfig: { image: '', size: 'cover', posX: 50, posY: 50 },
                ui: {
                    loginModal: { show: false, user: '', pass: '' },
                    lastUpdate: '...',
                    editMode: false,
                    editPlanta: false,
                    multiSelect: false,
                    selectedSpotId: null,
                    multiSelectedIds: [],
                    draggingSpotId: null,
                    dragOffset: { x: 0, y: 0 },
                    zoom: { container: 1, plant: 1 },
                },
                notifications: [],
            }
        },
        computed: {
            stats() {
                const total = this.spots.length;
                if (total === 0) return { total: 0, free: 0, occupied: 0, occupationRate: 0 };
                const occupied = this.spots.filter(s => s.status === 'ocupada').length;
                const free = total - occupied;
                const occupationRate = Math.round((occupied / total) * 100);
                return { total, free, occupied, occupationRate };
            },
            mapStyle() { return { transform: `scale(${this.ui.zoom.container})` }; },
            plantStyle() {
                return {
                    backgroundImage: `url(${this.plantConfig.image})`,
                    backgroundSize: this.plantConfig.size,
                    backgroundPosition: `${this.plantConfig.posX}% ${this.plantConfig.posY}%`,
                    transform: `scale(${this.ui.zoom.plant})`
                };
            },
            selectedSpot() {
                return this.spots.find(s => s.id === this.ui.selectedSpotId);
            }
        },
        methods: {
            showNotification(message, type = 'info', duration = 3000) {
                const id = Date.now();
                this.notifications.push({ id, message, type });
                setTimeout(() => {
                    this.notifications = this.notifications.filter(n => n.id !== id);
                }, duration);
            },
            handleLogin() {
                const { user, pass } = this.ui.loginModal;
                if (user === 'admin' && pass === 'admin123') {
                    this.user = { name: 'Administrador', isAdmin: true };
                    this.ui.loginModal.show = false;
                    this.showNotification('Login realizado com sucesso!', 'sucesso');
                } else {
                    this.showNotification('Credenciais inválidas!', 'erro');
                }
                this.ui.loginModal.user = '';
                this.ui.loginModal.pass = '';
            },
            handleLogout() {
                if (confirm('Sair do modo administrador?')) {
                    this.user = { name: 'Visualizador Público', isAdmin: false };
                    this.ui.editMode = false;
                    this.ui.multiSelect = false;
                    this.ui.selectedSpotId = null;
                    this.ui.multiSelectedIds = [];
                    this.showNotification('Logout realizado.', 'info');
                }
            },
            spotStyle(spot) {
                return {
                    left: `${spot.x}px`,
                    top: `${spot.y}px`,
                    width: `${spot.width || 40}px`,
                    height: `${spot.height || 70}px`,
                    transform: `rotate(${spot.angle || 0}deg)`
                };
            },
            toggleEditMode() {
                this.ui.editMode = !this.ui.editMode;
                if (!this.ui.editMode) {
                    this.ui.selectedSpotId = null;
                    this.ui.multiSelectedIds = [];
                    this.syncFullLayout();
                }
            },
            toggleMultiSelect() {
                this.ui.multiSelect = !this.ui.multiSelect;
                if (!this.ui.multiSelect) {
                    this.ui.multiSelectedIds = [];
                }
            },
            handleSpotClick(spot) {
                if (!this.user.isAdmin) return;
                if (this.ui.editMode) {
                    if (this.ui.multiSelect) {
                        const index = this.ui.multiSelectedIds.indexOf(spot.id);
                        if (index > -1) this.ui.multiSelectedIds.splice(index, 1);
                        else this.ui.multiSelectedIds.push(spot.id);
                    } else {
                        this.ui.selectedSpotId = this.ui.selectedSpotId === spot.id ? null : spot.id;
                    }
                } else {
                    spot.status = spot.status === 'livre' ? 'ocupada' : 'livre';
                    this.updateSpotStatusInFirebase(spot);
                }
            },
            startDrag(spot, event) {
                if (!this.user.isAdmin || !this.ui.editMode) return;
                this.ui.draggingSpotId = spot.id;
                const rect = event.target.getBoundingClientRect();
                this.ui.dragOffset = {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top,
                };
                document.addEventListener('mousemove', this.drag);
                document.addEventListener('mouseup', this.stopDrag);
            },
            drag(event) {
                if (!this.ui.draggingSpotId) return;
                const spot = this.spots.find(s => s.id === this.ui.draggingSpotId);
                const containerRect = this.$refs.mapContainer.getBoundingClientRect();
                spot.x = event.clientX - containerRect.left - this.ui.dragOffset.x;
                spot.y = event.clientY - containerRect.top - this.ui.dragOffset.y;
            },
            stopDrag() {
                this.ui.draggingSpotId = null;
                document.removeEventListener('mousemove', this.drag);
                document.removeEventListener('mouseup', this.stopDrag);
                this.syncFullLayout();
            },
            setAllSpotsStatus(status) {
                if (!this.user.isAdmin || !confirm(`Deseja marcar todas as vagas como ${status.toUpperCase()}?`)) return;
                this.spots.forEach(spot => spot.status = status);
                this.saveToFirebase();
            },
            saveStateLocal() {
                localStorage.setItem('parkingSystemState', JSON.stringify({
                    spots: this.spots,
                    plantConfig: this.plantConfig,
                    nextSpotId: this.nextSpotId
                }));
                this.showNotification('Layout salvo localmente!', 'sucesso');
            },
            loadStateLocal() {
                const savedState = localStorage.getItem('parkingSystemState');
                if (savedState) {
                    const data = JSON.parse(savedState);
                    this.spots = data.spots || [];
                    this.plantConfig = data.plantConfig || this.plantConfig;
                    this.nextSpotId = data.nextSpotId || this.spots.length + 1;
                } else {
                    // Inicializar com vagas padrão se não houver nada salvo
                    this.spots = Array.from({ length: 62 }, (_, i) => ({
                        id: `V${String(i + 1).padStart(2, '0')}`,
                        x: 50 + (i % 10) * 50,
                        y: 50 + Math.floor(i / 10) * 100,
                        width: 40, height: 70, angle: 0, status: 'livre'
                    }));
                    this.nextSpotId = 63;
                }
            },
            // Funções Firebase
            initFirebase() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    this.firebase.db = firebase.database();
                    this.firebase.connected = true;
                    this.showNotification('Conectado ao Firebase!', 'sucesso');

                    // Listener para o layout completo (para viewers)
                    this.firebase.db.ref('layout').on('value', snapshot => {
                        if (!this.user.isAdmin) {
                            const data = snapshot.val();
                            if (data) {
                                this.spots = data.spots || this.spots;
                                this.plantConfig = data.plantConfig || this.plantConfig;
                                this.nextSpotId = data.nextSpotId || this.nextSpotId;
                            }
                        }
                    });

                    // Listener para status das vagas (para todos)
                    this.firebase.db.ref('spots').on('value', snapshot => {
                        const spotStatus = snapshot.val();
                        if (spotStatus) {
                            this.spots.forEach(spot => {
                                if (spotStatus[spot.id] && spot.status !== spotStatus[spot.id]) {
                                    spot.status = spotStatus[spot.id];
                                }
                            });
                        }
                    });

                } catch (e) {
                    this.firebase.connected = false;
                    this.showNotification('Erro ao conectar ao Firebase.', 'erro');
                }
            },
            updateSpotStatusInFirebase(spot) {
                if (!this.firebase.connected || !this.user.isAdmin) return;
                this.firebase.db.ref(`spots/${spot.id}`).set(spot.status);
            },
            syncFullLayout() {
                 if (!this.firebase.connected || !this.user.isAdmin) return;
                 const layout = {
                     spots: this.spots,
                     plantConfig: this.plantConfig,
                     nextSpotId: this.nextSpotId
                 };
                 this.firebase.db.ref('layout').set(layout)
                    .then(() => this.showNotification('Layout sincronizado com Firebase!', 'sucesso'))
                    .catch(e => this.showNotification(`Erro ao sincronizar: ${e.message}`, 'erro'));
            },
            saveToFirebase() {
                if (!this.firebase.connected || !this.user.isAdmin) return;
                const spotsStatus = this.spots.reduce((acc, spot) => {
                    acc[spot.id] = spot.status;
                    return acc;
                }, {});
                this.firebase.db.ref('spots').set(spotsStatus);
                this.syncFullLayout();
            },
            // Outras funções
            addSpot() {
                const newId = `V${String(this.nextSpotId).padStart(2, '0')}`;
                this.spots.push({ id: newId, x: 50, y: 50, width: 40, height: 70, angle: 0, status: 'livre' });
                this.nextSpotId++;
                this.syncFullLayout();
            },
            // Funções de importação/exportação simplificadas
            exportLayout() {
                const dataStr = JSON.stringify({ spots: this.spots, plantConfig: this.plantConfig, nextSpotId: this.nextSpotId }, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `layout_estacionamento_${new Date().toISOString()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            importLayout(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm('Importar layout? A configuração atual será perdida.')) {
                            this.spots = data.spots || [];
                            this.plantConfig = data.plantConfig || this.plantConfig;
                            this.nextSpotId = data.nextSpotId || this.spots.length + 1;
                            this.syncFullLayout();
                        }
                    } catch (err) {
                        this.showNotification('Erro ao importar arquivo.', 'erro');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            },
            uploadPlant(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    this.plantConfig.image = e.target.result;
                    this.syncFullLayout();
                };
                reader.readAsDataURL(file);
            }
        },
        mounted() {
            this.loadStateLocal();
            this.initFirebase();
            setInterval(() => {
                this.ui.lastUpdate = new Date().toLocaleTimeString();
            }, 1000);
        }
    }).mount('#app');
</script>
</body>
</html>
