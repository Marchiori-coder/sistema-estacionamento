<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0, minimum-scale=0.5">
    <title>Sistema de Estacionamento</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--p:clamp(10px,2vw,30px);--f:clamp(0.8rem,1.5vw,1rem);--r:clamp(8px,1vw,15px)}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:var(--p);font-size:var(--f)}
        .modal-login{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;z-index:10000}
        .modal-login.show{display:flex!important}
        .login-box{background:white;padding:30px;border-radius:var(--r);text-align:center;max-width:400px;width:90%}
        .login-input{width:100%;padding:12px;margin:8px 0;border:2px solid #ecf0f1;border-radius:8px;font-size:var(--f)}
        .login-btn{width:100%;padding:12px;background:#3498db;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
        .close-modal{position:absolute;top:15px;right:20px;background:none;border:none;font-size:2rem;cursor:pointer;color:#7f8c8d}
        .container{max-width:min(1600px,95vw);margin:0 auto;background:white;border-radius:var(--r);box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden}
        .header{background:linear-gradient(135deg,#2c3e50,#3498db);color:white;padding:var(--p);text-align:center;position:relative;padding-top:clamp(60px,8vw,100px)}
        .header h1{font-size:clamp(1.5rem,4vw,2.5rem);margin-bottom:10px}
        .user-info{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.25);padding:10px 20px;border-radius:25px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .user-badge{background:#27ae60;color:white;padding:6px 12px;border-radius:15px;font-size:0.8rem;font-weight:bold}
        .user-badge.admin{background:#f39c12}
        .admin-login-btn,.logout-btn{background:#3498db;color:white;border:none;padding:8px 15px;border-radius:15px;cursor:pointer;font-size:0.8rem;font-weight:bold}
        .logout-btn{background:#e74c3c}
        .status-firebase{position:fixed;top:var(--p);left:var(--p);padding:10px 15px;border-radius:20px;color:white;font-weight:bold;z-index:1000;display:flex;align-items:center;gap:8px;font-size:0.8rem}
        .status-firebase.conectado{background:#27ae60}
        .status-firebase.desconectado{background:#e74c3c}
        .indicador-firebase{width:10px;height:10px;border-radius:50%;background:white;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .admin-panel{background:linear-gradient(135deg,#f39c12,#e67e22);color:white;padding:20px;text-align:center;display:none}
        .admin-panel.show{display:block!important}
        .admin-controls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
        .admin-btn{padding:10px 15px;background:rgba(255,255,255,0.2);color:white;border:2px solid white;border-radius:20px;cursor:pointer;font-weight:bold;font-size:0.8rem}
        .admin-btn:hover,.admin-btn.active{background:white;color:#f39c12}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:15px;margin-top:20px}
        .stat-box{background:rgba(255,255,255,0.2);padding:15px;border-radius:10px;text-align:center}
        .stat-number{font-size:clamp(1.2rem,3vw,1.8rem);font-weight:bold;display:block}
        .estacionamento-wrapper{padding:var(--p);background:#f8f9fa;min-height:70vh;position:relative}
        .estacionamento-container{position:relative;width:100%;max-width:1600px;height:clamp(800px,90vh,1600px);margin:0 auto;background:#e8e8e8;border-radius:var(--r);border:3px solid #34495e;overflow:auto;transform-origin:center;transition:transform 0.3s;-webkit-overflow-scrolling:touch}
        .planta-baixa{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-repeat:no-repeat;background-position:center;opacity:0.8;z-index:1;transform-origin:center;transition:all 0.3s}
        .planta-baixa.ajustavel{border:2px dashed #3498db;opacity:0.9}
        .zoom-controls,.planta-controls{position:absolute;background:rgba(255,255,255,0.95);padding:15px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:150;display:none;cursor:move;user-select:none}
        .zoom-controls{top:20px;left:20px}
        .planta-controls{top:20px;right:20px}
        .zoom-controls.dragging,.planta-controls.dragging{z-index:200;box-shadow:0 8px 25px rgba(0,0,0,0.4);transform:scale(1.05)}
        .zoom-controls h4,.planta-controls h4{color:#34495e;margin-bottom:10px;font-size:0.8rem;cursor:move;padding:5px;background:rgba(52,73,94,0.1);border-radius:5px;text-align:center}
        .zoom-btn,.planta-btn{padding:8px 12px;margin:2px;color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
        .zoom-btn{background:#3498db}
        .planta-btn{background:#e67e22;display:block;width:100%;margin-bottom:5px}
        .vaga{position:absolute;width:clamp(25px,4vw,45px);height:clamp(40px,6vw,75px);border:2px solid #2c3e50;background:rgba(39,174,96,0.9);display:flex!important;justify-content:center;align-items:center;font-size:clamp(6px,1.2vw,10px);font-weight:bold;color:white;border-radius:4px;cursor:pointer;transition:all 0.3s;z-index:10;user-select:none}
        .vaga:hover{transform:scale(1.1);z-index:100}
        .vaga.viewer-mode{cursor:default!important}
        .vaga.viewer-mode:hover{transform:none!important}
        .livre{background:rgba(39,174,96,0.9)!important}
        .ocupada{background:rgba(231,76,60,0.9)!important}
        .modo-edicao .vaga{cursor:move!important;border:3px dashed #f39c12!important;background:rgba(243,156,18,0.8)!important}
        .vaga.selecionada{border:4px solid #9b59b6!important;background:rgba(155,89,182,0.9)!important;z-index:1000!important}
        .vaga.multipla-selecionada{border:4px solid #e67e22!important;background:rgba(230,126,34,0.9)!important;z-index:999!important}
        .vaga.arrastando{z-index:1001!important;transform:scale(1.2)!important;opacity:0.8;box-shadow:0 8px 20px rgba(0,0,0,0.3)}
        .edit-controls{position:fixed;top:50%;right:20px;transform:translateY(-50%);background:white;padding:20px;border-radius:15px;box-shadow:0 15px 40px rgba(0,0,0,0.3);display:none;z-index:1000;min-width:280px;max-height:85vh;overflow-y:auto}
        .edit-controls.show{display:block!important}
        .edit-section{margin-bottom:20px}
        .edit-section h4{color:#34495e;margin-bottom:10px;font-size:0.8rem}
        .edit-btn{width:100%;padding:10px;margin:5px 0;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.8rem}
        .edit-btn.rotate{background:#3498db;color:white}
        .edit-btn.resize{background:#e67e22;color:white}
        .edit-btn.action{background:#9b59b6;color:white}
        .edit-btn.delete{background:#e74c3c;color:white}
        .edit-btn.multi{background:#27ae60;color:white}
        .size-controls{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .size-btn{padding:8px;background:#95a5a6;color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
        .position-controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
        .position-btn{padding:6px;background:#2c3e50;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem}
        .controles{padding:30px;background:#ecf0f1;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;justify-items:center}
        .btn{padding:12px 20px;border:none;border-radius:20px;cursor:pointer;font-weight:bold;font-size:0.8rem;transition:all 0.3s;min-width:120px}
        .btn:hover{transform:translateY(-2px)}
        .btn:disabled{opacity:0.3;cursor:not-allowed}
        .btn-reset{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:white}
        .btn-ocupar{background:linear-gradient(135deg,#e74c3c,#c0392b);color:white}
        .btn-liberar{background:linear-gradient(135deg,#27ae60,#2ecc71);color:white}
        .btn-salvar{background:linear-gradient(135deg,#3498db,#2980b9);color:white}
        .btn-firebase{background:linear-gradient(135deg,#ff9800,#f57c00);color:white}
        .notificacao{position:fixed;bottom:20px;right:20px;background:#2c3e50;color:white;padding:15px 20px;border-radius:10px;z-index:1000;max-width:min(350px,90vw);transform:translateX(400px);transition:transform 0.3s}
        .notificacao.mostrar{transform:translateX(0)}
        .notificacao.sucesso{background:#27ae60}
        .notificacao.erro{background:#e74c3c}
        .notificacao.info{background:#3498db}
        
        /* MELHORIAS ESPEC√çFICAS PARA MOBILE COM ZOOM */
        @media (max-width:768px){
            .user-info{position:static;margin-bottom:15px;justify-content:center}
            .header{padding-top:20px}
            .status-firebase{position:relative;margin-bottom:10px;align-self:flex-start}
            .edit-controls{position:fixed;top:0;right:0;left:0;bottom:0;transform:none;max-height:100vh;border-radius:0}
            .estacionamento-wrapper{overflow:hidden;padding:5px;position:relative}
            .estacionamento-container{
                height:clamp(500px,70vh,800px);
                width:100%;
                max-width:none;
                overflow:visible;
                transform-origin:0 0;
                transition:transform 0.2s ease-out;
                touch-action:pan-x pan-y pinch-zoom;
                position:relative;
                background-size:contain;
                background-repeat:no-repeat;
                background-position:center;
            }
            .zoom-controls,.planta-controls{display:none!important}
            .controles{grid-template-columns:repeat(2,1fr);gap:10px;padding:15px}
            .vaga{
                width:clamp(25px,6vw,40px);
                height:clamp(40px,8vw,60px);
                font-size:clamp(7px,1.8vw,11px);
                border-width:1px;
            }
            .admin-panel{padding:10px}
            .admin-controls{gap:5px}
            .admin-btn{padding:8px 12px;font-size:0.7rem}
            
            /* Controles de zoom mobile */
            .mobile-zoom-controls{
                position:absolute;
                bottom:20px;
                right:20px;
                background:rgba(255,255,255,0.9);
                border-radius:10px;
                padding:10px;
                box-shadow:0 4px 15px rgba(0,0,0,0.2);
                z-index:100;
                display:flex;
                flex-direction:column;
                gap:5px;
            }
            .mobile-zoom-btn{
                width:40px;
                height:40px;
                border:none;
                border-radius:8px;
                background:#3498db;
                color:white;
                font-size:18px;
                font-weight:bold;
                cursor:pointer;
                display:flex;
                align-items:center;
                justify-content:center;
            }
            .mobile-zoom-btn:active{background:#2980b9}
            
            /* Indicador de zoom */
            .zoom-indicator{
                position:absolute;
                top:20px;
                left:50%;
                transform:translateX(-50%);
                background:rgba(0,0,0,0.7);
                color:white;
                padding:8px 15px;
                border-radius:20px;
                font-size:12px;
                z-index:100;
                opacity:0;
                transition:opacity 0.3s;
            }
            .zoom-indicator.show{opacity:1}
        }
        
        @media (max-width:480px){
            .estacionamento-container{height:clamp(400px,60vh,600px)}
            .vaga{
                width:clamp(20px,7vw,35px);
                height:clamp(35px,9vw,55px);
                font-size:clamp(6px,2vw,10px);
            }
            .controles{grid-template-columns:1fr;gap:8px;padding:10px}
            .btn{min-width:100px;padding:10px 15px;font-size:0.7rem}
            .header h1{font-size:clamp(1.2rem,5vw,1.8rem)}
            .stats{grid-template-columns:repeat(2,1fr);gap:10px}
            .stat-box{padding:10px}
            .stat-number{font-size:clamp(1rem,4vw,1.4rem)}
            .mobile-zoom-controls{bottom:15px;right:15px;padding:8px}
            .mobile-zoom-btn{width:35px;height:35px;font-size:16px}
        }
        
        /* MELHORIAS ADICIONAIS PARA NAVEGA√á√ÉO TOUCH */
        @media (hover: none) and (pointer: coarse) {
            .vaga:hover{transform:none!important}
            .btn:hover{transform:none!important}
            .estacionamento-container{
                overflow:visible;
                scroll-behavior:smooth;
                -webkit-overflow-scrolling:touch;
            }
            .estacionamento-wrapper{
                touch-action:manipulation;
                -webkit-user-select:none;
                user-select:none;
            }
        }
        
        @media (min-width:1920px) and (max-width:2560px){
            .estacionamento-container{height:clamp(1100px,90vh,1700px);max-width:1800px}
            .vaga{width:clamp(45px,3vw,60px);height:clamp(75px,5vw,90px);font-size:clamp(10px,1vw,14px)}
        }
        
        @media (min-width:2560px){
            .estacionamento-container{height:clamp(1300px,85vh,1800px);max-width:2000px}
            .vaga{width:clamp(50px,2.5vw,70px);height:clamp(80px,4vw,110px);font-size:clamp(12px,0.8vw,16px)}
        }
    </style>
</head>
<body>
    <div class="modal-login" id="modal-login">
        <div class="login-box">
            <button class="close-modal" onclick="fecharModalLogin()">√ó</button>
            <h2>üîê Login Administrador</h2>
            <input type="text" class="login-input" id="username" placeholder="Usu√°rio">
            <input type="password" class="login-input" id="password" placeholder="Senha">
            <button class="login-btn" onclick="fazerLoginAdmin()">Entrar como Admin</button>
        </div>
    </div>

    <div class="status-firebase" id="status-firebase">
        <div class="indicador-firebase"></div>
        <span id="texto-firebase">Sistema Inicializado</span>
    </div>

    <div class="container">
        <div class="header">
            <div class="user-info">
                <span id="user-name">Visualizador P√∫blico</span>
                <span class="user-badge" id="user-badge">VIEWER</span>
                <button class="admin-login-btn" id="admin-login-btn" onclick="mostrarModalLogin()">Login Admin</button>
                <button class="logout-btn" id="logout-btn" onclick="logout()" style="display:none;">Sair</button>
            </div>
            
            <h1>üöó SMAMUS - Sistema de Estacionamento 2025 </h1>
            <p><strong>√öltima atualiza√ß√£o:</strong> <span id="ultima-atualizacao">Agora</span></p>
            
            <div class="stats">
                <div class="stat-box"><span class="stat-number" id="total-vagas">62</span><span>Total</span></div>
                <div class="stat-box"><span class="stat-number" id="vagas-livres">62</span><span>Livres</span></div>
                <div class="stat-box"><span class="stat-number" id="vagas-ocupadas">0</span><span>Ocupadas</span></div>
                <div class="stat-box"><span class="stat-number" id="taxa-ocupacao">0%</span><span>Ocupa√ß√£o</span></div>
            </div>
        </div>

        <div class="admin-panel" id="admin-panel">
            <h3>üîß Painel de Administra√ß√£o</h3>
            <div class="admin-controls">
                <button class="admin-btn" id="btn-edit-mode" onclick="toggleEditMode()">‚úèÔ∏è Edi√ß√£o</button>
                <button class="admin-btn" onclick="adicionarNovaVaga()">‚ûï Nova Vaga</button>
                <button class="admin-btn" onclick="carregarPlantaBaixa()">üñºÔ∏è Planta</button>
                <button class="admin-btn" id="btn-edit-planta" onclick="toggleEditPlanta()">üìê Ajustar Planta</button>
                <button class="admin-btn" onclick="exportarLayout()">üì§ Exportar</button>
                <button class="admin-btn" onclick="importarLayout()">üì• Importar</button>
                <button class="admin-btn" id="btn-multi-select" onclick="toggleSelecaoMultipla()">üî≤ Multi</button>
            </div>
        </div>

        <div class="estacionamento-wrapper">
            <div class="zoom-controls" id="zoom-controls">
                <h4>üîç Zoom - Arraste para mover</h4>
                <div>
                    <button class="zoom-btn" onclick="ajustarZoom('container',0.1)">üîç+</button>
                    <button class="zoom-btn" onclick="ajustarZoom('container',-0.1)">üîç-</button>
                    <button class="zoom-btn" onclick="resetarZoom('container')">‚ü≤</button>
                </div>
                <div style="margin-top:8px;">
                    <button class="zoom-btn" onclick="ajustarZoom('planta',0.1)">üñºÔ∏è+</button>
                    <button class="zoom-btn" onclick="ajustarZoom('planta',-0.1)">üñºÔ∏è-</button>
                    <button class="zoom-btn" onclick="resetarZoom('planta')">‚ü≤üñºÔ∏è</button>
                </div>
                <div style="font-size:0.8em;color:#7f8c8d;margin-top:5px;text-align:center;">
                    Container: <span id="zoom-container">100%</span><br>
                    Planta: <span id="zoom-planta">100%</span>
                </div>
            </div>

            <div class="planta-controls" id="planta-controls">
                <h4>üìê Planta Baixa - Arraste para mover</h4>
                <button class="planta-btn" onclick="ajustarPlanta('cover')">üìè Cobrir √Årea</button>
                <button class="planta-btn" onclick="ajustarPlanta('contain')">üìê Ajustar</button>
                <button class="planta-btn" onclick="ajustarPlanta('fill')">üîÑ Preencher</button>
                <button class="planta-btn" onclick="centralizarPlanta()">‚åñ Centralizar</button>
                <button class="planta-btn" onclick="resetarPlanta()">‚ü≤ Reset</button>
            </div>

            <!-- Indicador de zoom para mobile -->
            <div class="zoom-indicator" id="zoom-indicator">Zoom: 100%</div>

            <!-- Controles de zoom mobile -->
            <div class="mobile-zoom-controls" id="mobile-zoom-controls" style="display:none;">
                <button class="mobile-zoom-btn" onclick="ajustarZoomMobile(0.2)">+</button>
                <button class="mobile-zoom-btn" onclick="ajustarZoomMobile(-0.2)">-</button>
                <button class="mobile-zoom-btn" onclick="resetarZoomMobile()" style="font-size:14px;">‚ü≤</button>
            </div>

            <div class="estacionamento-container" id="mapa-estacionamento">
                <div class="planta-baixa" id="planta-baixa"></div>
            </div>
        </div>

        <div class="edit-controls" id="edit-controls">
            <div style="text-align:center;margin-bottom:15px;color:#2c3e50;font-weight:bold;">
                üîß Editando: <span id="vaga-selecionada">-</span>
            </div>
            
            <div id="multi-selection-info" style="display:none;background:#e67e22;color:white;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;">
                <span id="multi-count">0</span> vagas selecionadas
            </div>

            <div class="edit-section" id="multi-actions" style="display:none;">
                <h4>üî≤ A√ß√µes em Lote</h4>
                <button class="edit-btn multi" onclick="aplicarRotacaoMultipla(-90)">‚Ü∂ -90¬∞</button>
                <button class="edit-btn multi" onclick="aplicarRotacaoMultipla(90)">‚Ü∑ +90¬∞</button>
                <button class="edit-btn multi" onclick="redimensionarMultiplas('width',5)">üìè Largura +</button>
                <button class="edit-btn multi" onclick="redimensionarMultiplas('height',5)">üìè Altura +</button>
                <button class="edit-btn multi" onclick="alinharVagasMultiplas('horizontal')">‚ÜîÔ∏è Alinhar H</button>
                <button class="edit-btn multi" onclick="alinharVagasMultiplas('vertical')">‚ÜïÔ∏è Alinhar V</button>
                <button class="edit-btn delete" onclick="excluirVagasMultiplas()">üóëÔ∏è Excluir</button>
                <button class="edit-btn action" onclick="limparSelecaoMultipla()">‚ùå Limpar</button>
            </div>
            
            <div class="edit-section">
                <h4>üìç Posi√ß√£o</h4>
                <div class="position-controls">
                    <button class="position-btn" onclick="moverVaga(-10,-10)">‚Üñ</button>
                    <button class="position-btn" onclick="moverVaga(0,-10)">‚Üë</button>
                    <button class="position-btn" onclick="moverVaga(10,-10)">‚Üó</button>
                    <button class="position-btn" onclick="moverVaga(-10,0)">‚Üê</button>
                    <button class="position-btn" onclick="centralizarVaga()">‚åñ</button>
                    <button class="position-btn" onclick="moverVaga(10,0)">‚Üí</button>
                    <button class="position-btn" onclick="moverVaga(-10,10)">‚Üô</button>
                    <button class="position-btn" onclick="moverVaga(0,10)">‚Üì</button>
                    <button class="position-btn" onclick="moverVaga(10,10)">‚Üò</button>
                </div>
            </div>
            
            <div class="edit-section">
                <h4>üîÑ Rota√ß√£o</h4>
                <button class="edit-btn rotate" onclick="rotacionarVaga(-90)">‚Ü∂ -90¬∞</button>
                <button class="edit-btn rotate" onclick="rotacionarVaga(90)">‚Ü∑ +90¬∞</button>
                <button class="edit-btn rotate" onclick="resetarRotacao()">‚ü≤ Reset</button>
            </div>
            
            <div class="edit-section">
                <h4>üìè Tamanho</h4>
                <div class="size-controls">
                    <button class="size-btn" onclick="redimensionarVaga('width',-5)">Largura -</button>
                    <button class="size-btn" onclick="redimensionarVaga('width',5)">Largura +</button>
                    <button class="size-btn" onclick="redimensionarVaga('height',-5)">Altura -</button>
                    <button class="size-btn" onclick="redimensionarVaga('height',5)">Altura +</button>
                </div>
                <button class="edit-btn resize" onclick="resetarTamanho()">üìè Padr√£o</button>
            </div>
            
            <div class="edit-section">
                <h4>üé® A√ß√µes</h4>
                <button class="edit-btn action" onclick="duplicarVaga()">üìã Duplicar</button>
                <button class="edit-btn action" onclick="renomearVaga()">‚úèÔ∏è Renomear</button>
                <button class="edit-btn delete" onclick="excluirVaga()">üóëÔ∏è Excluir</button>
            </div>
        </div>

        <div class="controles">
            <button class="btn btn-reset" onclick="resetarTodasVagas()" id="btn-reset" disabled>üîÑ Resetar</button>
            <button class="btn btn-ocupar" onclick="ocuparTodasVagas()" id="btn-ocupar" disabled>üöó Ocupar</button>
            <button class="btn btn-liberar" onclick="liberarTodasVagas()" id="btn-liberar" disabled>‚úÖ Liberar</button>
            <button class="btn btn-salvar" onclick="salvarEstadoLocal()">üíæ Salvar</button>
            <button class="btn btn-firebase" onclick="salvarNoFirebase()">üåê Firebase</button>
        </div>
    </div>

    <input type="file" id="import-input" accept=".json" style="display:none;" onchange="processarImportacao(event)">
    <input type="file" id="planta-input" accept="image/*" style="display:none;" onchange="processarPlantaBaixa(event)">

    <script>
        // Prote√ß√£o contra erros de extens√µes do navegador
        (function() {
            'use strict';
            
            if (typeof window.ethereum !== 'undefined') {
                console.log('Carteira crypto detectada - ignorando conflitos');
            }
            
            if (typeof chrome !== 'undefined' && chrome.runtime) {
                const originalAddListener = chrome.runtime.onMessage.addListener;
                chrome.runtime.onMessage.addListener = function(callback) {
                    try {
                        return originalAddListener.call(this, function(message, sender, sendResponse) {
                            if (chrome.runtime.lastError) {
                                console.log('Runtime error suprimido:', chrome.runtime.lastError.message);
                                return;
                            }
                            return callback(message, sender, sendResponse);
                        });
                    } catch (e) {
                        console.log('Erro de extens√£o ignorado:', e.message);
                    }
                };
            }
            
            window.addEventListener('error', function(e) {
                if (e.message.includes('ERR_BLOCKED_BY_CLIENT') || 
                    e.message.includes('adsbygoogle') ||
                    e.message.includes('Cannot redefine property')) {
                    e.preventDefault();
                    console.log('Erro de bloqueador/extens√£o ignorado:', e.message);
                }
            });
        })();

        var firebaseConfig = {
            apiKey: "AIzaSyCRIgCndKlfXxR7NNnq_qGupgAWyLqzYzc",
            authDomain: "teste-dbacd.firebaseapp.com",
            databaseURL: "https://teste-dbacd-default-rtdb.firebaseio.com/",
            projectId: "teste-dbacd",
            storageBucket: "teste-dbacd.firebasestorage.app",
            messagingSenderId: "381642195685",
            appId: "1:381642195685:web:746eb4df7667813b0e4a0c"
        };

        var estadoVagas = {};
        var posicaoVagas = {};
        var firebaseConectado = false;
        var database = null;
        var totalVagas = 62;
        var usuarioAtual = 'viewer';
        var tipoUsuario = 'viewer';
        var modoEdicao = false;
        var proximoIdVaga = 63;
        var vagaSelecionada = null;
        var vagaArrastando = null;
        var offsetX = 0;
        var offsetY = 0;
        var zoomContainer = 1;
        var zoomPlanta = 1;
        var selecaoMultipla = false;
        var vagasMultiplasSelecao = [];
        var editandoPlanta = false;
        var plantaConfig = {size: 'cover', posX: 50, posY: 50};
        var painelArrastando = null;
        var offsetPainelX = 0;
        var offsetPainelY = 0;
        
        // Vari√°veis para zoom mobile
        var zoomMobile = 1;
        var isMobile = window.innerWidth <= 768;
        var touchStartDistance = 0;
        var touchStartZoom = 1;

        // Fun√ß√µes de zoom mobile
        function ajustarZoomMobile(incremento) {
            zoomMobile = Math.max(0.5, Math.min(3, zoomMobile + incremento));
            aplicarZoomMobile();
            mostrarIndicadorZoom();
        }

        function resetarZoomMobile() {
            zoomMobile = 1;
            aplicarZoomMobile();
            mostrarIndicadorZoom();
        }

        function aplicarZoomMobile() {
            if (isMobile) {
                var container = document.getElementById('mapa-estacionamento');
                container.style.transform = 'scale(' + zoomMobile + ')';
                container.style.transformOrigin = 'center center';
            }
        }

        function mostrarIndicadorZoom() {
            var indicator = document.getElementById('zoom-indicator');
            indicator.textContent = 'Zoom: ' + Math.round(zoomMobile * 100) + '%';
            indicator.classList.add('show');
            setTimeout(function() {
                indicator.classList.remove('show');
            }, 1500);
        }

        // Gestos de pinch para zoom
        function inicializarGestosTouch() {
            if (!isMobile) return;
            
            var container = document.getElementById('mapa-estacionamento');
            
            container.addEventListener('touchstart', function(e) {
                if (e.touches.length === 2) {
                    var touch1 = e.touches[0];
                    var touch2 = e.touches[1];
                    touchStartDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    touchStartZoom = zoomMobile;
                    e.preventDefault();
                }
            });

            container.addEventListener('touchmove', function(e) {
                if (e.touches.length === 2) {
                    var touch1 = e.touches[0];
                    var touch2 = e.touches[1];
                    var currentDistance = Math.sqrt(
                        Math.pow(touch2.clientX - touch1.clientX, 2) +
                        Math.pow(touch2.clientY - touch1.clientY, 2)
                    );
                    
                    var scale = currentDistance / touchStartDistance;
                    zoomMobile = Math.max(0.5, Math.min(3, touchStartZoom * scale));
                    aplicarZoomMobile();
                    e.preventDefault();
                }
            });

            container.addEventListener('touchend', function(e) {
                if (e.touches.length < 2) {
                    mostrarIndicadorZoom();
                }
            });
        }

        function mostrarModalLogin() {
            document.getElementById('modal-login').classList.add('show');
        }

        function fecharModalLogin() {
            document.getElementById('modal-login').classList.remove('show');
        }
        
        function fazerLoginAdmin() {
            var u = document.getElementById('username').value.trim();
            var p = document.getElementById('password').value.trim();
            if (u === 'admin' && p === 'admin123') {
                usuarioAtual = 'admin';
                tipoUsuario = 'admin';
                fecharModalLogin();
                document.getElementById('user-name').textContent = 'Administrador';
                document.getElementById('user-badge').textContent = 'ADMIN';
                document.getElementById('user-badge').className = 'user-badge admin';
                document.getElementById('admin-login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'inline-block';
                document.getElementById('admin-panel').classList.add('show');
                habilitarControlesAdmin();
                aplicarModoVisualizacao();
                mostrarNotificacao('üîß Login realizado!', 'sucesso');
            } else {
                mostrarNotificacao('‚ùå Credenciais inv√°lidas', 'erro');
            }
        }

        function logout() {
            if (confirm('Sair do modo administrador?')) {
                usuarioAtual = 'viewer';
                tipoUsuario = 'viewer';
                modoEdicao = false;
                selecaoMultipla = false;
                editandoPlanta = false;
                document.getElementById('user-name').textContent = 'Visualizador P√∫blico';
                document.getElementById('user-badge').textContent = 'VIEWER';
                document.getElementById('user-badge').className = 'user-badge';
                document.getElementById('admin-login-btn').style.display = 'inline-block';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('admin-panel').classList.remove('show');
                document.getElementById('edit-controls').style.display = 'none';
                document.getElementById('zoom-controls').style.display = 'none';
                document.getElementById('planta-controls').style.display = 'none';
                document.getElementById('mapa-estacionamento').classList.remove('modo-edicao');
                document.getElementById('planta-baixa').classList.remove('ajustavel');
                limparSelecaoMultipla();
                desabilitarControlesAdmin();
                aplicarModoVisualizacao();
                mostrarNotificacao('üëã Logout realizado', 'info');
            }
        }

        function aplicarModoVisualizacao() {
            var vagas = document.querySelectorAll('.vaga');
            vagas.forEach(function(vaga) {
                if (tipoUsuario === 'viewer') {
                    vaga.classList.add('viewer-mode');
                    vaga.style.cursor = 'default';
                } else {
                    vaga.classList.remove('viewer-mode');
                    vaga.style.cursor = 'pointer';
                }
            });
        }

        function habilitarControlesAdmin() {
            ['btn-reset', 'btn-ocupar', 'btn-liberar'].forEach(function(id) {
                var btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            });
        }

        function desabilitarControlesAdmin() {
            ['btn-reset', 'btn-ocupar', 'btn-liberar'].forEach(function(id) {
                var btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = true;
                    btn.style.opacity = '0.3';
                }
            });
        }

        function toggleEditPlanta() {
            if (tipoUsuario !== 'admin') return;
            editandoPlanta = !editandoPlanta;
            var btn = document.getElementById('btn-edit-planta');
            var planta = document.getElementById('planta-baixa');
            if (editandoPlanta) {
                btn.classList.add('active');
                btn.textContent = '‚úÖ Finalizar Planta';
                planta.classList.add('ajustavel');
                mostrarNotificacao('üìê Modo ajuste de planta ativado', 'info');
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üìê Ajustar Planta';
                planta.classList.remove('ajustavel');
                mostrarNotificacao('‚úÖ Ajuste de planta finalizado', 'info');
                salvarLocal();
                sincronizarLayoutCompleto();
            }
        }

        function ajustarPlanta(tipo) {
            if (tipoUsuario !== 'admin') return;
            var planta = document.getElementById('planta-baixa');
            plantaConfig.size = tipo;
            planta.style.backgroundSize = tipo;
            if (tipo === 'cover') {
                planta.style.backgroundPosition = 'center';
            } else if (tipo === 'contain') {
                planta.style.backgroundPosition = 'center';
                planta.style.backgroundSize = 'contain';
            } else if (tipo === 'fill') {
                planta.style.backgroundSize = '100% 100%';
            }
            salvarLocal();
            sincronizarLayoutCompleto();
            mostrarNotificacao('üìê Planta ajustada: ' + tipo, 'info');
        }

        function centralizarPlanta() {
            if (tipoUsuario !== 'admin') return;
            var planta = document.getElementById('planta-baixa');
            plantaConfig.posX = 50;
            plantaConfig.posY = 50;
            planta.style.backgroundPosition = '50% 50%';
            salvarLocal();
            sincronizarLayoutCompleto();
            mostrarNotificacao('‚åñ Planta centralizada', 'info');
        }

        function resetarPlanta() {
            if (tipoUsuario !== 'admin') return;
            var planta = document.getElementById('planta-baixa');
            plantaConfig = {size: 'cover', posX: 50, posY: 50};
            planta.style.backgroundSize = 'cover';
            planta.style.backgroundPosition = 'center';
            planta.style.transform = 'scale(1)';
            zoomPlanta = 1;
            document.getElementById('zoom-planta').textContent = '100%';
            salvarLocal();
            sincronizarLayoutCompleto();
            mostrarNotificacao('‚ü≤ Planta resetada', 'info');
        }

        function ajustarZoom(tipo, incremento) {
            if (tipoUsuario !== 'admin') return;
            if (tipo === 'container') {
                zoomContainer = Math.max(0.3, Math.min(3, zoomContainer + incremento));
                document.getElementById('mapa-estacionamento').style.transform = 'scale(' + zoomContainer + ')';
                document.getElementById('zoom-container').textContent = Math.round(zoomContainer * 100) + '%';
            } else if (tipo === 'planta') {
                zoomPlanta = Math.max(0.3, Math.min(3, zoomPlanta + incremento));
                document.getElementById('planta-baixa').style.transform = 'scale(' + zoomPlanta + ')';
                document.getElementById('zoom-planta').textContent = Math.round(zoomPlanta * 100) + '%';
            }
        }

        function resetarZoom(tipo) {
            if (tipoUsuario !== 'admin') return;
            if (tipo === 'container') {
                zoomContainer = 1;
                document.getElementById('mapa-estacionamento').style.transform = 'scale(1)';
                document.getElementById('zoom-container').textContent = '100%';
            } else if (tipo === 'planta') {
                zoomPlanta = 1;
                document.getElementById('planta-baixa').style.transform = 'scale(1)';
                document.getElementById('zoom-planta').textContent = '100%';
            }
        }

        function toggleEditMode() {
            if (tipoUsuario !== 'admin') return;
            modoEdicao = !modoEdicao;
            var container = document.getElementById('mapa-estacionamento');
            var btn = document.getElementById('btn-edit-mode');
            var zoomControls = document.getElementById('zoom-controls');
            var plantaControls = document.getElementById('planta-controls');
            if (modoEdicao) {
                container.classList.add('modo-edicao');
                btn.classList.add('active');
                btn.textContent = '‚úÖ Finalizar';
                if (window.innerWidth > 768) {
                    zoomControls.style.display = 'block';
                    plantaControls.style.display = 'block';
                }
                mostrarNotificacao('‚úèÔ∏è Modo edi√ß√£o ativado - Arraste vagas livremente!', 'info');
            } else {
                container.classList.remove('modo-edicao');
                btn.classList.remove('active');
                btn.textContent = '‚úèÔ∏è Edi√ß√£o';
                document.getElementById('edit-controls').style.display = 'none';
                zoomControls.style.display = 'none';
                plantaControls.style.display = 'none';
                if (vagaSelecionada) {
                    vagaSelecionada.classList.remove('selecionada');
                    vagaSelecionada = null;
                }
                limparSelecaoMultipla();
                salvarLocal();
                sincronizarLayoutCompleto();
                mostrarNotificacao('‚úÖ Modo edi√ß√£o finalizado', 'info');
            }
        }

        function toggleSelecaoMultipla() {
            if (tipoUsuario !== 'admin') return;
            selecaoMultipla = !selecaoMultipla;
            var btn = document.getElementById('btn-multi-select');
            if (selecaoMultipla) {
                btn.classList.add('active');
                btn.textContent = '‚úÖ Multi';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üî≤ Multi';
                limparSelecaoMultipla();
            }
        }

        function limparSelecaoMultipla() {
            vagasMultiplasSelecao.forEach(function(vaga) {
                vaga.classList.remove('multipla-selecionada');
            });
            vagasMultiplasSelecao = [];
            atualizarInterfaceSelecaoMultipla();
        }

        function adicionarVagaSelecaoMultipla(vaga) {
            if (!selecaoMultipla || tipoUsuario !== 'admin') return;
            var index = vagasMultiplasSelecao.indexOf(vaga);
            if (index > -1) {
                vagasMultiplasSelecao.splice(index, 1);
                vaga.classList.remove('multipla-selecionada');
            } else {
                vagasMultiplasSelecao.push(vaga);
                vaga.classList.add('multipla-selecionada');
            }
            atualizarInterfaceSelecaoMultipla();
        }

        function atualizarInterfaceSelecaoMultipla() {
            var count = vagasMultiplasSelecao.length;
            var multiInfo = document.getElementById('multi-selection-info');
            var multiActions = document.getElementById('multi-actions');
            if (count > 0) {
                multiInfo.style.display = 'block';
                multiActions.style.display = 'block';
                document.getElementById('multi-count').textContent = count;
                document.getElementById('edit-controls').style.display = 'block';
            } else {
                multiInfo.style.display = 'none';
                multiActions.style.display = 'none';
                if (!vagaSelecionada) {
                    document.getElementById('edit-controls').style.display = 'none';
                }
            }
        }

        function aplicarRotacaoMultipla(graus) {
            if (vagasMultiplasSelecao.length === 0 || tipoUsuario !== 'admin') return;
            vagasMultiplasSelecao.forEach(function(vaga) {
                var vagaId = vaga.id;
                var novoAngulo = ((posicaoVagas[vagaId].angle || 0) + graus) % 360;
                posicaoVagas[vagaId].angle = novoAngulo;
                vaga.style.transform = 'rotate(' + novoAngulo + 'deg)';
            });
            sincronizarLayoutCompleto();
        }

        function redimensionarMultiplas(dimensao, valor) {
            if (vagasMultiplasSelecao.length === 0 || tipoUsuario !== 'admin') return;
            vagasMultiplasSelecao.forEach(function(vaga) {
                var vagaId = vaga.id;
                if (!posicaoVagas[vagaId].width) posicaoVagas[vagaId].width = 40;
                if (!posicaoVagas[vagaId].height) posicaoVagas[vagaId].height = 70;
                if (dimensao === 'width') {
                    posicaoVagas[vagaId].width = Math.max(15, posicaoVagas[vagaId].width + valor);
                    vaga.style.width = posicaoVagas[vagaId].width + 'px';
                } else {
                    posicaoVagas[vagaId].height = Math.max(20, posicaoVagas[vagaId].height + valor);
                    vaga.style.height = posicaoVagas[vagaId].height + 'px';
                }
            });
            sincronizarLayoutCompleto();
        }

        function alinharVagasMultiplas(tipo) {
            if (vagasMultiplasSelecao.length < 2 || tipoUsuario !== 'admin') return;
            var referencia = vagasMultiplasSelecao[0];
            var refPos = posicaoVagas[referencia.id];
            vagasMultiplasSelecao.slice(1).forEach(function(vaga) {
                var vagaId = vaga.id;
                if (tipo === 'horizontal') {
                    posicaoVagas[vagaId].y = refPos.y;
                    vaga.style.top = refPos.y + 'px';
                } else {
                    posicaoVagas[vagaId].x = refPos.x;
                    vaga.style.left = refPos.x + 'px';
                }
            });
            sincronizarLayoutCompleto();
        }

        function excluirVagasMultiplas() {
            if (vagasMultiplasSelecao.length === 0 || tipoUsuario !== 'admin') return;
            if (confirm('Excluir ' + vagasMultiplasSelecao.length + ' vagas?')) {
                vagasMultiplasSelecao.forEach(function(vaga) {
                    var vagaId = vaga.id;
                    delete estadoVagas[vagaId];
                    delete posicaoVagas[vagaId];
                    vaga.remove();
                    totalVagas--;
                });
                vagasMultiplasSelecao = [];
                atualizarInterfaceSelecaoMultipla();
                atualizarEstatisticas();
                sincronizarLayoutCompleto();
            }
        }

        function selecionarVaga(vaga) {
            if (!modoEdicao || tipoUsuario !== 'admin') return;
            if (selecaoMultipla) {
                adicionarVagaSelecaoMultipla(vaga);
                return;
            }
            if (vagaSelecionada) {
                vagaSelecionada.classList.remove('selecionada');
            }
            vagaSelecionada = vaga;
            vaga.classList.add('selecionada');
            document.getElementById('edit-controls').style.display = 'block';
            document.getElementById('vaga-selecionada').textContent = vaga.id;
        }

        function moverVaga(deltaX, deltaY) {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var vagaId = vagaSelecionada.id;
            var novoX = (posicaoVagas[vagaId].x || 0) + deltaX;
            var novoY = (posicaoVagas[vagaId].y || 0) + deltaY;
            var container = document.getElementById('mapa-estacionamento');
            novoX = Math.max(0, Math.min(novoX, container.offsetWidth - 40));
            novoY = Math.max(0, Math.min(novoY, container.offsetHeight - 70));
            posicaoVagas[vagaId].x = novoX;
            posicaoVagas[vagaId].y = novoY;
            vagaSelecionada.style.left = novoX + 'px';
            vagaSelecionada.style.top = novoY + 'px';
        }

        function centralizarVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var container = document.getElementById('mapa-estacionamento');
            var vagaId = vagaSelecionada.id;
            var centroX = (container.offsetWidth - 40) / 2;
            var centroY = (container.offsetHeight - 70) / 2;
            posicaoVagas[vagaId].x = centroX;
            posicaoVagas[vagaId].y = centroY;
            vagaSelecionada.style.left = centroX + 'px';
            vagaSelecionada.style.top = centroY + 'px';
        }

        function rotacionarVaga(graus) {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var vagaId = vagaSelecionada.id;
            var novoAngulo = ((posicaoVagas[vagaId].angle || 0) + graus) % 360;
            posicaoVagas[vagaId].angle = novoAngulo;
            vagaSelecionada.style.transform = 'rotate(' + novoAngulo + 'deg)';
        }

        function resetarRotacao() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            posicaoVagas[vagaSelecionada.id].angle = 0;
            vagaSelecionada.style.transform = 'rotate(0deg)';
        }

        function redimensionarVaga(dimensao, valor) {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var vagaId = vagaSelecionada.id;
            if (!posicaoVagas[vagaId].width) posicaoVagas[vagaId].width = 40;
            if (!posicaoVagas[vagaId].height) posicaoVagas[vagaId].height = 70;
            if (dimensao === 'width') {
                posicaoVagas[vagaId].width = Math.max(15, posicaoVagas[vagaId].width + valor);
                vagaSelecionada.style.width = posicaoVagas[vagaId].width + 'px';
            } else {
                posicaoVagas[vagaId].height = Math.max(20, posicaoVagas[vagaId].height + valor);
                vagaSelecionada.style.height = posicaoVagas[vagaId].height + 'px';
            }
        }

        function resetarTamanho() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var vagaId = vagaSelecionada.id;
            posicaoVagas[vagaId].width = 40;
            posicaoVagas[vagaId].height = 70;
            vagaSelecionada.style.width = '40px';
            vagaSelecionada.style.height = '70px';
        }

        function duplicarVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var novoId = 'V' + (proximoIdVaga < 10 ? '0' + proximoIdVaga : proximoIdVaga);
            proximoIdVaga++;
            var novaVaga = criarVaga(novoId, parseInt(vagaSelecionada.style.left) + 50, parseInt(vagaSelecionada.style.top) + 50);
            posicaoVagas[novoId] = Object.assign({}, posicaoVagas[vagaSelecionada.id]);
            posicaoVagas[novoId].x += 50;
            posicaoVagas[novoId].y += 50;
            totalVagas++;
            atualizarEstatisticas();
            sincronizarLayoutCompleto();
        }

        function renomearVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var novoNome = prompt('Novo nome:', vagaSelecionada.id);
            if (novoNome && novoNome !== vagaSelecionada.id) {
                if (document.getElementById(novoNome)) {
                    mostrarNotificacao('‚ùå Nome j√° existe', 'erro');
                    return;
                }
                var vagaAntiga = vagaSelecionada.id;
                estadoVagas[novoNome] = estadoVagas[vagaAntiga];
                posicaoVagas[novoNome] = posicaoVagas[vagaAntiga];
                delete estadoVagas[vagaAntiga];
                delete posicaoVagas[vagaAntiga];
                vagaSelecionada.id = novoNome;
                vagaSelecionada.textContent = novoNome;
                document.getElementById('vaga-selecionada').textContent = novoNome;
                sincronizarLayoutCompleto();
            }
        }

        function excluirVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            if (confirm('Excluir vaga ' + vagaSelecionada.id + '?')) {
                var vagaId = vagaSelecionada.id;
                delete estadoVagas[vagaId];
                delete posicaoVagas[vagaId];
                vagaSelecionada.remove();
                vagaSelecionada = null;
                totalVagas--;
                document.getElementById('edit-controls').style.display = 'none';
                atualizarEstatisticas();
                sincronizarLayoutCompleto();
            }
        }

        function adicionarNovaVaga() {
            if (tipoUsuario !== 'admin') return;
            var novoId = 'V' + (proximoIdVaga < 10 ? '0' + proximoIdVaga : proximoIdVaga);
            proximoIdVaga++;
            var novaVaga = criarVaga(novoId, 100, 100);
            totalVagas++;
            atualizarEstatisticas();
            if (modoEdicao) selecionarVaga(novaVaga);
            sincronizarLayoutCompleto();
        }

        // Sistema de arraste melhorado para movimento livre
        function iniciarArraste(e) {
            if (!modoEdicao || tipoUsuario !== 'admin') return;
            
            if (selecaoMultipla && e.ctrlKey) {
                adicionarVagaSelecaoMultipla(e.target);
                e.preventDefault();
                return;
            }
            
            vagaArrastando = e.target;
            selecionarVaga(vagaArrastando);
            vagaArrastando.classList.add('arrastando');
            
            var rect = vagaArrastando.getBoundingClientRect();
                       var containerRect = document.getElementById('mapa-estacionamento').getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            e.preventDefault();
            e.stopPropagation();
            document.body.style.cursor = 'move';
            vagaArrastando.style.pointerEvents = 'none';
        }

        function arrastar(e) {
            if (painelArrastando) {
                arrastarPainel(e);
                return;
            }
            if (!vagaArrastando || !modoEdicao || tipoUsuario !== 'admin') return;
            var containerRect = document.getElementById('mapa-estacionamento').getBoundingClientRect();
            var x = e.clientX - containerRect.left - offsetX;
            var y = e.clientY - containerRect.top - offsetY;
            x = Math.max(0, Math.min(x, containerRect.width - vagaArrastando.offsetWidth));
            y = Math.max(0, Math.min(y, containerRect.height - vagaArrastando.offsetHeight));
            vagaArrastando.style.left = x + 'px';
            vagaArrastando.style.top = y + 'px';
            posicaoVagas[vagaArrastando.id].x = x;
            posicaoVagas[vagaArrastando.id].y = y;
        }

        function finalizarArraste() {
            if (vagaArrastando && tipoUsuario === 'admin') {
                vagaArrastando.classList.remove('arrastando');
                vagaArrastando.style.pointerEvents = 'auto';
                document.body.style.cursor = 'default';
                vagaArrastando = null;
                salvarLocal();
                sincronizarLayoutCompleto();
            }
            finalizarArrastePainel();
        }

        function iniciarArrastePainel(e) {
            if (tipoUsuario !== 'admin' || !modoEdicao || window.innerWidth <= 768) return;
            var target = e.target;
            while (target && !target.classList.contains('zoom-controls') && !target.classList.contains('planta-controls')) {
                target = target.parentElement;
            }
            if (!target) return;
            painelArrastando = target;
            painelArrastando.classList.add('dragging');
            var rect = painelArrastando.getBoundingClientRect();
            offsetPainelX = e.clientX - rect.left;
            offsetPainelY = e.clientY - rect.top;
            e.preventDefault();
            e.stopPropagation();
        }

        function arrastarPainel(e) {
            if (!painelArrastando) return;
            var wrapper = document.querySelector('.estacionamento-wrapper');
            var wrapperRect = wrapper.getBoundingClientRect();
            var x = Math.max(0, Math.min(e.clientX - wrapperRect.left - offsetPainelX, wrapperRect.width - painelArrastando.offsetWidth));
            var y = Math.max(0, Math.min(e.clientY - wrapperRect.top - offsetPainelY, wrapperRect.height - painelArrastando.offsetHeight));
            painelArrastando.style.left = x + 'px';
            painelArrastando.style.top = y + 'px';
            painelArrastando.style.right = 'auto';
        }

        function finalizarArrastePainel() {
            if (painelArrastando) {
                painelArrastando.classList.remove('dragging');
                painelArrastando = null;
            }
        }

        // --- FIM DAS FUN√á√ïES DE INTERA√á√ÉO DAS VAGAS ---

        function exportarLayout() {
            if (tipoUsuario !== 'admin') return;
            var dados = {
                timestamp: new Date().toISOString(),
                vagas: estadoVagas,
                posicoes: posicaoVagas,
                plantaBaixa: document.getElementById('planta-baixa').style.backgroundImage,
                plantaConfig: plantaConfig,
                totalVagas: totalVagas,
                proximoId: proximoIdVaga,
                zoomContainer: zoomContainer,
                zoomPlanta: zoomPlanta
            };
            var blob = new Blob([JSON.stringify(dados, null, 2)], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'layout_estacionamento_' + new Date().toISOString().slice(0, 16).replace('T', '_') + '.json';
            a.click();
            URL.revokeObjectURL(url);
            mostrarNotificacao('üì§ Layout exportado!', 'sucesso');
        }

        function importarLayout() {
            if (tipoUsuario !== 'admin') return;
            document.getElementById('import-input').click();
        }

        function carregarPlantaBaixa() {
            if (tipoUsuario !== 'admin') return;
            document.getElementById('planta-input').click();
        }

        function processarImportacao(event) {
            if (tipoUsuario !== 'admin') return;
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var dados = JSON.parse(e.target.result);
                    if (confirm('Importar layout? Isso substituir√° tudo!')) {
                        document.querySelectorAll('.vaga').forEach(function(vaga) {
                            vaga.remove();
                        });
                        if (dados.vagas) estadoVagas = dados.vagas;
                        if (dados.posicoes) posicaoVagas = dados.posicoes;
                        if (dados.totalVagas) totalVagas = dados.totalVagas;
                        if (dados.proximoId) proximoIdVaga = dados.proximoId;
                        if (dados.plantaBaixa) {
                            document.getElementById('planta-baixa').style.backgroundImage = dados.plantaBaixa;
                        }
                        if (dados.plantaConfig) {
                            plantaConfig = dados.plantaConfig;
                            var planta = document.getElementById('planta-baixa');
                            planta.style.backgroundSize = plantaConfig.size;
                            planta.style.backgroundPosition = plantaConfig.posX + '% ' + plantaConfig.posY + '%';
                        }
                        if (dados.zoomContainer) {
                            zoomContainer = dados.zoomContainer;
                            document.getElementById('mapa-estacionamento').style.transform = 'scale(' + zoomContainer + ')';
                            document.getElementById('zoom-container').textContent = Math.round(zoomContainer * 100) + '%';
                        }
                        if (dados.zoomPlanta) {
                            zoomPlanta = dados.zoomPlanta;
                            document.getElementById('planta-baixa').style.transform = 'scale(' + zoomPlanta + ')';
                            document.getElementById('zoom-planta').textContent = Math.round(zoomPlanta * 100) + '%';
                        }
                        for (var vagaId in posicaoVagas) {
                            var pos = posicaoVagas[vagaId];
                            var vaga = criarVaga(vagaId, pos.x, pos.y);
                            if (pos.width) vaga.style.width = pos.width + 'px';
                            if (pos.height) vaga.style.height = pos.height + 'px';
                            if (pos.angle) vaga.style.transform = 'rotate(' + pos.angle + 'deg)';
                            if (estadoVagas[vagaId]) {
                                vaga.classList.remove('livre', 'ocupada');
                                vaga.classList.add(estadoVagas[vagaId]);
                            }
                        }
                        atualizarEstatisticas();
                        salvarLocal();
                        aplicarModoVisualizacao();
                        sincronizarLayoutCompleto();
                        mostrarNotificacao('üì• Layout importado!', 'sucesso');
                    }
                } catch (error) {
                    mostrarNotificacao('‚ùå Erro ao importar: ' + error.message, 'erro');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- FIM DAS FUN√á√ïES DE IMPORTA√á√ÉO/EXPORTA√á√ÉO ---

        // Inicializa√ß√£o do sistema
        document.addEventListener('DOMContentLoaded', function() {
            carregarLocal();
            inicializarVagas();
            inicializarFirebase();
            document.addEventListener('mousemove', arrastar);
            document.addEventListener('mouseup', finalizarArraste);

            // Zoom mobile
            if (isMobile) {
                document.getElementById('mobile-zoom-controls').style.display = 'flex';
                aplicarZoomMobile();
                inicializarGestosTouch();
            }

            var zoomControls = document.getElementById('zoom-controls');
            var plantaControls = document.getElementById('planta-controls');
            if (zoomControls) zoomControls.addEventListener('mousedown', iniciarArrastePainel);
            if (plantaControls) plantaControls.addEventListener('mousedown', iniciarArrastePainel);

            document.getElementById('mapa-estacionamento').addEventListener('click', function() {
                if (vagaSelecionada && modoEdicao && tipoUsuario === 'admin') {
                    vagaSelecionada.classList.remove('selecionada');
                    vagaSelecionada = null;
                    document.getElementById('edit-controls').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>

