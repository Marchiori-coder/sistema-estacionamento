<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Estacionamento</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--p:clamp(10px,2vw,30px);--f:clamp(0.8rem,1.5vw,1rem);--r:clamp(8px,1vw,15px)}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:var(--p);font-size:var(--f);-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;touch-action:manipulation}
        .modal-login{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;z-index:10000}
        .modal-login.show{display:flex!important}
        .login-box{background:white;padding:30px;border-radius:var(--r);text-align:center;max-width:400px;width:90%}
        .login-input{width:100%;padding:12px;margin:8px 0;border:2px solid #ecf0f1;border-radius:8px;font-size:var(--f)}
        .login-btn{width:100%;padding:12px;background:#3498db;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
        .close-modal{position:absolute;top:15px;right:20px;background:none;border:none;font-size:2rem;cursor:pointer;color:#7f8c8d}
        .container{max-width:min(1600px,95vw);margin:0 auto;background:white;border-radius:var(--r);box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden}
        .header{background:linear-gradient(135deg,#2c3e50,#3498db);color:white;padding:var(--p);text-align:center;position:relative;padding-top:clamp(60px,8vw,100px)}
        .header h1{font-size:clamp(1.5rem,4vw,2.5rem);margin-bottom:10px}
        .user-info{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.25);padding:10px 20px;border-radius:25px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .user-badge{background:#27ae60;color:white;padding:6px 12px;border-radius:15px;font-size:0.8rem;font-weight:bold}
        .user-badge.admin{background:#f39c12}
        .admin-login-btn,.logout-btn{background:#3498db;color:white;border:none;padding:8px 15px;border-radius:15px;cursor:pointer;font-size:0.8rem;font-weight:bold}
        .logout-btn{background:#e74c3c}
        .status-firebase{position:fixed;top:var(--p);left:var(--p);padding:10px 15px;border-radius:20px;color:white;font-weight:bold;z-index:1000;display:flex;align-items:center;gap:8px;font-size:0.8rem}
        .status-firebase.conectado{background:#27ae60}
        .status-firebase.desconectado{background:#e74c3c}
        .indicador-firebase{width:10px;height:10px;border-radius:50%;background:white;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .admin-panel{background:linear-gradient(135deg,#f39c12,#e67e22);color:white;padding:20px;text-align:center;display:none}
        .admin-panel.show{display:block!important}
        .admin-controls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
        .admin-btn{padding:10px 15px;background:rgba(255,255,255,0.2);color:white;border:2px solid white;border-radius:20px;cursor:pointer;font-weight:bold;font-size:0.8rem}
        .admin-btn:hover,.admin-btn.active{background:white;color:#f39c12}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:15px;margin-top:20px}
        .stat-box{background:rgba(255,255,255,0.2);padding:15px;border-radius:10px;text-align:center}
        .stat-number{font-size:clamp(1.2rem,3vw,1.8rem);font-weight:bold;display:block}
        .estacionamento-wrapper{padding:var(--p);background:#f8f9fa;min-height:70vh;position:relative}
        .estacionamento-container{position:relative;width:100%;max-width:1600px;height:clamp(800px,90vh,1600px);margin:0 auto;background:#e8e8e8;border-radius:var(--r);border:3px solid #34495e;overflow:auto;transform-origin:top left;transition:transform 0.3s;-webkit-overflow-scrolling:touch}
        .planta-baixa{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-repeat:no-repeat;background-position:center;opacity:0.8;z-index:1;transform-origin:center;transition:all 0.3s}
        .planta-baixa.ajustavel{border:2px dashed #3498db;opacity:0.9}
        .zoom-controls,.planta-controls{position:absolute;background:rgba(255,255,255,0.95);padding:15px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:150;display:none;cursor:move;user-select:none}
        .zoom-controls{top:20px;left:20px}
        .planta-controls{top:20px;right:20px}
        .zoom-controls.dragging,.planta-controls.dragging{z-index:200;box-shadow:0 8px 25px rgba(0,0,0,0.4);transform:scale(1.05)}
        .zoom-controls h4,.planta-controls h4{color:#34495e;margin-bottom:10px;font-size:0.8rem;cursor:move;padding:5px;background:rgba(52,73,94,0.1);border-radius:5px;text-align:center}
        .zoom-btn,.planta-btn{padding:8px 12px;margin:2px;color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
        .zoom-btn{background:#3498db}
        .planta-btn{background:#e67e22;display:block;width:100%;margin-bottom:5px}
        
        .vaga{position:absolute;width:clamp(35px,6vw,55px);height:clamp(25px,4vw,40px);display:flex!important;justify-content:center;align-items:center;font-size:clamp(6px,1vw,9px);font-weight:bold;color:white;cursor:pointer;transition:all 0.4s ease;z-index:10;user-select:none;border-radius:12px;overflow:visible;padding:3px}
        .vaga:hover{transform:scale(1.15);z-index:100}
        .vaga.viewer-mode{cursor:default!important}
        .vaga.viewer-mode:hover{transform:none!important}
        
        .car-icon{width:100%;height:100%;transition:all 0.4s ease;filter:drop-shadow(0 3px 8px rgba(0,0,0,0.4))}
        .car-text{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:clamp(8px,1.2vw,10px);font-weight:bold;color:#2c3e50;background:rgba(255,255,255,0.95);padding:2px 6px;border-radius:4px;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
        
        .livre{background:radial-gradient(circle,rgba(39,174,96,0.9),rgba(39,174,96,0.6));box-shadow:0 0 20px rgba(39,174,96,0.8),inset 0 0 15px rgba(255,255,255,0.3);border:2px solid rgba(39,174,96,0.9)}
        .livre .car-icon{fill:#27ae60;filter:drop-shadow(0 3px 8px rgba(39,174,96,0.6)) drop-shadow(0 0 12px rgba(39,174,96,0.4))}
        .livre:hover{box-shadow:0 0 30px rgba(39,174,96,1),inset 0 0 20px rgba(255,255,255,0.4);background:radial-gradient(circle,rgba(39,174,96,1),rgba(39,174,96,0.8))}
        
        .ocupada{background:radial-gradient(circle,rgba(231,76,60,0.9),rgba(231,76,60,0.6));box-shadow:0 0 20px rgba(231,76,60,0.8),inset 0 0 15px rgba(255,255,255,0.3);border:2px solid rgba(231,76,60,0.9)}
        .ocupada .car-icon{fill:#e74c3c;filter:drop-shadow(0 3px 8px rgba(231,76,60,0.6)) drop-shadow(0 0 12px rgba(231,76,60,0.4))}
        .ocupada:hover{box-shadow:0 0 30px rgba(231,76,60,1),inset 0 0 20px rgba(255,255,255,0.4);background:radial-gradient(circle,rgba(231,76,60,1),rgba(231,76,60,0.8))}
        
        .modo-edicao .vaga{border:3px dashed #f39c12!important;background:radial-gradient(circle,rgba(243,156,18,0.8),rgba(243,156,18,0.4))!important;box-shadow:0 0 25px rgba(243,156,18,0.9),inset 0 0 15px rgba(255,255,255,0.4)!important}
        .vaga.selecionada{border:4px solid #9b59b6!important;background:radial-gradient(circle,rgba(155,89,182,0.9),rgba(155,89,182,0.6))!important;box-shadow:0 0 35px rgba(155,89,182,1),inset 0 0 20px rgba(255,255,255,0.5)!important;z-index:1000!important;transform:scale(1.1)!important}
        .vaga.multipla-selecionada{border:4px solid #e67e22!important;background:radial-gradient(circle,rgba(230,126,34,0.9),rgba(230,126,34,0.6))!important;box-shadow:0 0 35px rgba(230,126,34,1),inset 0 0 20px rgba(255,255,255,0.5)!important;z-index:999!important}
        .vaga.arrastando{z-index:1001!important;transform:scale(1.3)!important;opacity:0.9;box-shadow:0 12px 30px rgba(0,0,0,0.5),0 0 40px rgba(52,152,219,0.8)!important}
        
        .vaga-handles{position:absolute;display:none;pointer-events:none}
        .vaga.selecionada .vaga-handles{display:block!important;pointer-events:auto}
        .handle{position:absolute;width:10px;height:10px;background:#9b59b6;border:3px solid white;border-radius:50%;cursor:pointer;z-index:1002;box-shadow:0 2px 6px rgba(0,0,0,0.3);transition:all 0.3s}
        .handle:hover{transform:scale(1.3);background:#8e44ad;box-shadow:0 4px 12px rgba(0,0,0,0.4)}
        .handle.nw{top:-8px;left:-8px;cursor:nw-resize}
        .handle.ne{top:-8px;right:-8px;cursor:ne-resize}
        .handle.sw{bottom:-8px;left:-8px;cursor:sw-resize}
        .handle.se{bottom:-8px;right:-8px;cursor:se-resize}
        .handle.n{top:-8px;left:50%;transform:translateX(-50%);cursor:n-resize}
        .handle.s{bottom:-8px;left:50%;transform:translateX(-50%);cursor:s-resize}
        .handle.w{top:50%;left:-8px;transform:translateY(-50%);cursor:w-resize}
        .handle.e{top:50%;right:-8px;transform:translateY(-50%);cursor:e-resize}
        .handle.rotate{top:-25px;left:50%;transform:translateX(-50%);background:#e74c3c;cursor:crosshair;border-radius:4px;width:16px;height:8px}
        
        .quick-toolbar{position:absolute;top:-40px;left:0;background:rgba(52,73,94,0.95);padding:6px;border-radius:6px;display:none;white-space:nowrap;z-index:1003;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .vaga.selecionada .quick-toolbar{display:block!important}
        .quick-btn{padding:4px 8px;margin:0 2px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;transition:all 0.3s}
        .quick-btn:hover{background:#2980b9;transform:scale(1.1)}
        .quick-btn.delete{background:#e74c3c}
        .quick-btn.duplicate{background:#27ae60}
        
        .edit-controls{position:fixed;top:50%;right:20px;transform:translateY(-50%);background:white;padding:20px;border-radius:15px;box-shadow:0 15px 40px rgba(0,0,0,0.3);display:none;z-index:1000;min-width:280px;max-height:85vh;overflow-y:auto}
        .edit-controls.show{display:block!important}
        .edit-section{margin-bottom:20px}
        .edit-section h4{color:#34495e;margin-bottom:10px;font-size:0.8rem}
        .edit-btn{width:100%;padding:10px;margin:5px 0;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.8rem}
        .edit-btn.rotate{background:#3498db;color:white}
        .edit-btn.resize{background:#e67e22;color:white}
        .edit-btn.action{background:#9b59b6;color:white}
        .edit-btn.delete{background:#e74c3c;color:white}
        .edit-btn.multi{background:#27ae60;color:white}
        .size-controls{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .size-btn{padding:8px;background:#95a5a6;color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
        .position-controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
        .position-btn{padding:6px;background:#2c3e50;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem}
        .controles{padding:30px;background:#ecf0f1;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;justify-items:center}
        .btn{padding:12px 20px;border:none;border-radius:20px;cursor:pointer;font-weight:bold;font-size:0.8rem;transition:all 0.3s;min-width:120px}
        .btn:hover{transform:translateY(-2px)}
        .btn:disabled{opacity:0.3;cursor:not-allowed}
        .btn-reset{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:white}
        .btn-ocupar{background:linear-gradient(135deg,#e74c3c,#c0392b);color:white}
        .btn-liberar{background:linear-gradient(135deg,#27ae60,#2ecc71);color:white}
        .btn-salvar{background:linear-gradient(135deg,#3498db,#2980b9);color:white}
        .btn-firebase{background:linear-gradient(135deg,#ff9800,#f57c00);color:white}
        .notificacao{position:fixed;bottom:20px;right:20px;background:#2c3e50;color:white;padding:15px 20px;border-radius:10px;z-index:1000;max-width:min(350px,90vw);transform:translateX(400px);transition:transform 0.3s}
        .notificacao.mostrar{transform:translateX(0)}
        .notificacao.sucesso{background:#27ae60}
        .notificacao.erro{background:#e74c3c}
        .notificacao.info{background:#3498db}
        
        .edit-hint{position:fixed;bottom:20px;left:20px;background:rgba(52,73,94,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:0.8rem;z-index:1000;display:none}
        .modo-edicao .edit-hint{display:block!important}
        
        @keyframes glow-pulse{0%,100%{box-shadow:0 0 20px rgba(39,174,96,0.8),inset 0 0 15px rgba(255,255,255,0.3)}50%{box-shadow:0 0 35px rgba(39,174,96,1),inset 0 0 25px rgba(255,255,255,0.5)}}
        @keyframes glow-pulse-red{0%,100%{box-shadow:0 0 20px rgba(231,76,60,0.8),inset 0 0 15px rgba(255,255,255,0.3)}50%{box-shadow:0 0 35px rgba(231,76,60,1),inset 0 0 25px rgba(255,255,255,0.5)}}
        
        .livre:active{animation:glow-pulse 0.6s ease-in-out}
        .ocupada:active{animation:glow-pulse-red 0.6s ease-in-out}
        
        @media (max-width:768px){
            body{padding:5px;overflow-x:hidden}
            .container{border-radius:0;margin:0;width:100vw;max-width:100vw}
            .header{padding:10px;padding-top:15px}
            .user-info{position:static;margin-bottom:15px;justify-content:center;padding:8px 12px;font-size:0.7rem}
            .user-badge{padding:4px 8px;font-size:0.7rem}
            .admin-login-btn,.logout-btn{padding:6px 10px;font-size:0.7rem}
            .status-firebase{position:relative;margin-bottom:10px;align-self:flex-start;font-size:0.7rem;padding:8px 12px}
            .admin-panel{padding:8px}
            .admin-controls{gap:5px;justify-content:space-around}
            .admin-btn{padding:8px 10px;font-size:0.7rem;min-width:auto;flex:1;margin:2px}
            .stats{grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
            .stat-box{padding:8px}
            .stat-number{font-size:clamp(0.9rem,3vw,1.2rem)}
            .estacionamento-wrapper{padding:5px;overflow:hidden}
            .estacionamento-container{height:calc(100vh - 280px);min-height:400px;overflow:auto;-webkit-overflow-scrolling:touch;border-radius:8px;border-width:2px}
            .edit-controls{position:fixed;top:0;right:0;left:0;bottom:0;transform:none;max-height:100vh;border-radius:0;padding:15px;width:100vw;height:100vh;overflow-y:auto}
            .edit-controls .edit-section{margin-bottom:15px}
            .edit-controls h4{font-size:0.9rem}
            .edit-btn{padding:12px;font-size:0.9rem;margin:3px 0}
            .size-controls{gap:10px}
            .size-btn{padding:10px;font-size:0.9rem}
            .position-controls{gap:8px}
            .position-btn{padding:8px;font-size:0.9rem}
            .zoom-controls,.planta-controls{display:none!important}
            .controles{grid-template-columns:repeat(2,1fr);gap:8px;padding:10px}
            .btn{min-width:auto;padding:12px 8px;font-size:0.8rem}
            .vaga{width:clamp(45px,12vw,65px);height:clamp(30px,8vw,45px);touch-action:manipulation}
            .vaga:active{transform:scale(1.2)!important}
            .handle{width:14px;height:14px}
            .handle.nw,.handle.ne,.handle.sw,.handle.se{width:14px;height:14px}
            .handle.n,.handle.s,.handle.w,.handle.e{width:12px;height:12px}
            .quick-toolbar{top:-45px;font-size:12px}
            .quick-btn{padding:6px 10px;font-size:12px}
            .notificacao{bottom:10px;right:10px;left:10px;max-width:none;padding:12px 15px;font-size:0.8rem}
            .modal-login .login-box{width:95%;padding:20px;margin:10px}
            .login-input{padding:15px;font-size:1rem;border-radius:10px}
            .login-btn{padding:15px;font-size:1rem;border-radius:10px}
            .close-modal{font-size:1.5rem;top:10px;right:15px;padding:10px}
            .edit-hint{bottom:10px;left:10px;font-size:0.7rem}
            .car-text{font-size:clamp(9px,1.5vw,11px)}
        }
        
        @media (max-width:480px){
            .header h1{font-size:clamp(1.1rem,5vw,1.6rem)}
            .estacionamento-container{height:calc(100vh - 250px);min-height:350px}
            .vaga{width:clamp(50px,14vw,70px);height:clamp(35px,10vw,50px)}
            .controles{grid-template-columns:1fr;gap:6px;padding:8px}
            .btn{padding:15px 10px;font-size:0.9rem}
            .stats{grid-template-columns:repeat(2,1fr);gap:6px}
            .stat-box{padding:6px}
            .stat-number{font-size:clamp(0.8rem,4vw,1.1rem)}
            .admin-btn{font-size:0.6rem;padding:6px 8px}
        }

        @media (orientation:landscape) and (max-width:768px){
            .estacionamento-container{height:calc(100vh - 200px);min-height:300px}
            .header{padding:8px;padding-top:12px}
            .controles{padding:6px}
            .btn{padding:8px 6px;font-size:0.7rem}
        }

        @media (max-height:600px) and (max-width:768px){
            .estacionamento-container{height:calc(100vh - 180px);min-height:250px}
            .header{padding:5px;padding-top:8px}
            .header h1{font-size:1rem}
            .stats{margin-top:5px}
            .stat-box{padding:4px}
        }

        @media (hover:none) and (pointer:coarse){
            .vaga:hover{transform:none!important}
            .btn:hover{transform:none!important}
            .vaga:active{transform:scale(1.2)!important;transition:transform 0.1s}
            .btn:active{transform:scale(0.95)!important;transition:transform 0.1s}
        }
    </style>
</head>
<body>
    <div class="modal-login" id="modal-login">
        <div class="login-box">
            <button class="close-modal" onclick="fecharModalLogin()">√ó</button>
            <h2>üîê Login Administrador</h2>
            <input type="text" class="login-input" id="username" placeholder="Usu√°rio">
            <input type="password" class="login-input" id="password" placeholder="Senha">
            <button class="login-btn" onclick="fazerLoginAdmin()">Entrar como Admin</button>
        </div>
    </div>

    <div class="status-firebase" id="status-firebase">
        <div class="indicador-firebase"></div>
        <span id="texto-firebase">Sistema Inicializado</span>
    </div>

    <div class="container">
        <div class="header">
            <div class="user-info">
                <span id="user-name">Visualizador P√∫blico</span>
                <span class="user-badge" id="user-badge">VIEWER</span>
                <button class="admin-login-btn" id="admin-login-btn" onclick="mostrarModalLogin()">Login Admin</button>
                <button class="logout-btn" id="logout-btn" onclick="logout()" style="display:none;">Sair</button>
            </div>
            
            <h1>üöó SMAMUS - Sistema de Estacionamento</h1>
            <p><strong>√öltima atualiza√ß√£o:</strong> <span id="ultima-atualizacao">Agora</span></p>
            
            <div class="stats">
                <div class="stat-box"><span class="stat-number" id="total-vagas">62</span><span>Total</span></div>
                <div class="stat-box"><span class="stat-number" id="vagas-livres">62</span><span>Livres</span></div>
                <div class="stat-box"><span class="stat-number" id="vagas-ocupadas">0</span><span>Ocupadas</span></div>
                <div class="stat-box"><span class="stat-number" id="taxa-ocupacao">0%</span><span>Ocupa√ß√£o</span></div>
            </div>
        </div>

        <div class="admin-panel" id="admin-panel">
            <h3>üîß Painel de Administra√ß√£o</h3>
            <div class="admin-controls">
                <button class="admin-btn" id="btn-edit-mode" onclick="toggleEditMode()">‚úèÔ∏è Edi√ß√£o</button>
                <button class="admin-btn" onclick="adicionarNovaVaga()">‚ûï Nova Vaga</button>
                <button class="admin-btn" onclick="carregarPlantaBaixa()">üñºÔ∏è Planta</button>
                <button class="admin-btn" id="btn-edit-planta" onclick="toggleEditPlanta()">üìê Ajustar Planta</button>
                <button class="admin-btn" onclick="exportarLayout()">üì§ Exportar</button>
                <button class="admin-btn" onclick="importarLayout()">üì• Importar</button>
                <button class="admin-btn" id="btn-multi-select" onclick="toggleSelecaoMultipla()">üî≤ Multi</button>
            </div>
        </div>

        <div class="estacionamento-wrapper">
            <div class="zoom-controls" id="zoom-controls">
                <h4>üîç Zoom - Arraste para mover</h4>
                <div>
                    <button class="zoom-btn" onclick="ajustarZoom('container',0.1)">üîç+</button>
                    <button class="zoom-btn" onclick="ajustarZoom('container',-0.1)">üîç-</button>
                    <button class="zoom-btn" onclick="resetarZoom('container')">‚ü≤</button>
                </div>
                <div style="margin-top:8px;">
                    <button class="zoom-btn" onclick="ajustarZoom('planta',0.1)">üñºÔ∏è+</button>
                    <button class="zoom-btn" onclick="ajustarZoom('planta',-0.1)">üñºÔ∏è-</button>
                    <button class="zoom-btn" onclick="resetarZoom('planta')">‚ü≤üñºÔ∏è</button>
                </div>
                <div style="font-size:0.8em;color:#7f8c8d;margin-top:5px;text-align:center;">
                    Container: <span id="zoom-container">100%</span><br>
                    Planta: <span id="zoom-planta">100%</span>
                </div>
            </div>

            <div class="planta-controls" id="planta-controls">
                <h4>üìê Planta Baixa - Arraste para mover</h4>
                <button class="planta-btn" onclick="ajustarPlanta('cover')">üìè Cobrir √Årea</button>
                <button class="planta-btn" onclick="ajustarPlanta('contain')">üìê Ajustar</button>
                <button class="planta-btn" onclick="ajustarPlanta('fill')">üîÑ Preencher</button>
                <button class="planta-btn" onclick="centralizarPlanta()">‚åñ Centralizar</button>
                <button class="planta-btn" onclick="resetarPlanta()">‚ü≤ Reset</button>
            </div>

            <div class="estacionamento-container" id="mapa-estacionamento">
                <div class="planta-baixa" id="planta-baixa"></div>
            </div>
        </div>

        <div class="edit-controls" id="edit-controls">
            <div style="text-align:center;margin-bottom:15px;color:#2c3e50;font-weight:bold;">
                üîß Editando: <span id="vaga-selecionada">-</span>
            </div>
            
            <div id="multi-selection-info" style="display:none;background:#e67e22;color:white;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;">
                <span id="multi-count">0</span> vagas selecionadas
            </div>

            <div class="edit-section" id="multi-actions" style="display:none;">
                <h4>üî≤ A√ß√µes em Lote</h4>
                <button class="edit-btn multi" onclick="aplicarRotacaoMultipla(-90)">‚Ü∂ -90¬∞</button>
                <button class="edit-btn multi" onclick="aplicarRotacaoMultipla(90)">‚Ü∑ +90¬∞</button>
                <button class="edit-btn multi" onclick="redimensionarMultiplas('width',5)">üìè Largura +</button>
                <button class="edit-btn multi" onclick="redimensionarMultiplas('height',5)">üìè Altura +</button>
                <button class="edit-btn multi" onclick="alinharVagasMultiplas('horizontal')">‚ÜîÔ∏è Alinhar H</button>
                <button class="edit-btn multi" onclick="alinharVagasMultiplas('vertical')">‚ÜïÔ∏è Alinhar V</button>
                <button class="edit-btn delete" onclick="excluirVagasMultiplas()">üóëÔ∏è Excluir</button>
                <button class="edit-btn action" onclick="limparSelecaoMultipla()">‚ùå Limpar</button>
            </div>
            
            <div class="edit-section">
                <h4>üìç Posi√ß√£o (Use tamb√©m as setas do teclado)</h4>
                <div class="position-controls">
                    <button class="position-btn" onclick="moverVaga(-10,-10)">‚Üñ</button>
                    <button class="position-btn" onclick="moverVaga(0,-10)">‚Üë</button>
                    <button class="position-btn" onclick="moverVaga(10,-10)">‚Üó</button>
                    <button class="position-btn" onclick="moverVaga(-10,0)">‚Üê</button>
                    <button class="position-btn" onclick="centralizarVaga()">‚åñ</button>
                    <button class="position-btn" onclick="moverVaga(10,0)">‚Üí</button>
                    <button class="position-btn" onclick="moverVaga(-10,10)">‚Üô</button>
                    <button class="position-btn" onclick="moverVaga(0,10)">‚Üì</button>
                    <button class="position-btn" onclick="moverVaga(10,10)">‚Üò</button>
                </div>
            </div>
            
            <div class="edit-section">
                <h4>üîÑ Rota√ß√£o (Use 'R' e 'Shift+R')</h4>
                <button class="edit-btn rotate" onclick="rotacionarVaga(-90)">‚Ü∂ -90¬∞</button>
                <button class="edit-btn rotate" onclick="rotacionarVaga(90)">‚Ü∑ +90¬∞</button>
                <button class="edit-btn rotate" onclick="resetarRotacao()">‚ü≤ Reset</button>
            </div>
            
            <div class="edit-section">
                <h4>üìè Tamanho (Use +/- e Ctrl +/-)</h4>
                <div class="size-controls">
                    <button class="size-btn" onclick="redimensionarVaga('width',-5)">Largura -</button>
                    <button class="size-btn" onclick="redimensionarVaga('width',5)">Largura +</button>
                    <button class="size-btn" onclick="redimensionarVaga('height',-5)">Altura -</button>
                    <button class="size-btn" onclick="redimensionarVaga('height',5)">Altura +</button>
                </div>
                <button class="edit-btn resize" onclick="resetarTamanho()">üìè Padr√£o</button>
            </div>
            
            <div class="edit-section">
                <h4>üé® A√ß√µes (Use 'Delete' e 'Esc')</h4>
                <button class="edit-btn action" onclick="duplicarVaga()">üìã Duplicar</button>
                <button class="edit-btn action" onclick="renomearVaga()">‚úèÔ∏è Renomear</button>
                <button class="edit-btn delete" onclick="excluirVaga()">üóëÔ∏è Excluir</button>
            </div>
        </div>

        <div class="controles">
            <button class="btn btn-reset" onclick="resetarTodasVagas()" id="btn-reset" disabled>üîÑ Resetar</button>
            <button class="btn btn-ocupar" onclick="ocuparTodasVagas()" id="btn-ocupar" disabled>üöó Ocupar</button>
            <button class="btn btn-liberar" onclick="liberarTodasVagas()" id="btn-liberar" disabled>‚úÖ Liberar</button>
            <button class="btn btn-salvar" onclick="salvarEstadoLocal()">üíæ Salvar</button>
            <button class="btn btn-firebase" onclick="salvarNoFirebase()">üåê Firebase</button>
        </div>
    </div>

    <div class="edit-hint">
        üí° Clique para selecionar ‚Ä¢ Arraste para mover ‚Ä¢ Use handles para redimensionar ‚Ä¢ Scroll+Clique para rotacionar
    </div>

    <input type="file" id="import-input" accept=".json" style="display:none;" onchange="processarImportacao(event)">
    <input type="file" id="planta-input" accept="image/*" style="display:none;" onchange="processarPlantaBaixa(event)">

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyCRIgCndKlfXxR7NNnq_qGupgAWyLqzYzc",
            authDomain: "teste-dbacd.firebaseapp.com",
            databaseURL: "https://teste-dbacd-default-rtdb.firebaseio.com/",
            projectId: "teste-dbacd",
            storageBucket: "teste-dbacd.firebasestorage.app",
            messagingSenderId: "381642195685",
            appId: "1:381642195685:web:746eb4df7667813b0e4a0c"
        };

        var estadoVagas = {};
        var posicaoVagas = {};
        var firebaseConectado = false;
        var database = null;
        var totalVagas = 62;
        var usuarioAtual = 'viewer';
        var tipoUsuario = 'viewer';
        var modoEdicao = false;
        var proximoIdVaga = 63;
        var vagaSelecionada = null;
        var vagaArrastando = null;
        var handleArrastando = null;
        var rotacionandoVaga = false;
        var zoomContainer = 1;
        var zoomPlanta = 1;
        var selecaoMultipla = false;
        var vagasMultiplasSelecao = [];
        var editandoPlanta = false;
        var plantaConfig = {size: 'cover', posX: 50, posY: 50};
        var painelArrastando = null;
        var offsetPainelX = 0;
        var offsetPainelY = 0;

        var isArrastandoMultiplos = false;
        var posicoesIniciaisArrastar = [];
        var pontoInicialMouse = { x: 0, y: 0 };
        var dimensoesIniciaisResize = { width: 0, height: 0 };
        var anguloInicialRotacao = 0;

        function criarIconeCarro() {
            return `<svg class="car-icon" viewBox="0 0 120 70" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="carBodyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-opacity:1" />
                        <stop offset="50%" style="stop-opacity:0.9" />
                        <stop offset="100%" style="stop-opacity:0.7" />
                    </linearGradient>
                    <linearGradient id="carRoofGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-opacity:0.9" />
                        <stop offset="100%" style="stop-opacity:0.6" />
                    </linearGradient>
                </defs>
                
                <!-- Sombra do carro -->
                <ellipse cx="60" cy="65" rx="45" ry="8" fill="rgba(0,0,0,0.3)"/>
                
                <!-- Corpo principal -->
                <rect x="15" y="30" width="90" height="25" rx="12" fill="url(#carBodyGradient)" stroke="rgba(255,255,255,0.4)" stroke-width="1.5"/>
                
                <!-- Teto -->
                <rect x="30" y="18" width="60" height="18" rx="8" fill="url(#carRoofGradient)" stroke="rgba(255,255,255,0.4)" stroke-width="1"/>
                
                <!-- Para-choque dianteiro -->
                <rect x="8" y="35" width="10" height="15" rx="3" fill="url(#carBodyGradient)" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                
                <!-- Para-choque traseiro -->
                <rect x="102" y="35" width="10" height="15" rx="3" fill="url(#carBodyGradient)" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                
                <!-- Rodas -->
                <circle cx="30" cy="58" r="8" fill="#2c3e50" stroke="rgba(255,255,255,0.6)" stroke-width="1.5"/>
                <circle cx="90" cy="58" r="8" fill="#2c3e50" stroke="rgba(255,255,255,0.6)" stroke-width="1.5"/>
                
                <!-- Aros das rodas -->
                <circle cx="30" cy="58" r="5" fill="#34495e" stroke="rgba(255,255,255,0.4)" stroke-width="0.5"/>
                <circle cx="90" cy="58" r="5" fill="#34495e" stroke="rgba(255,255,255,0.4)" stroke-width="0.5"/>
                
                <!-- Detalhes dos aros -->
                <circle cx="30" cy="58" r="2" fill="#7f8c8d"/>
                <circle cx="90" cy="58" r="2" fill="#7f8c8d"/>
                
                <!-- Para-brisa -->
                <rect x="35" y="22" width="20" height="12" rx="3" fill="rgba(173,216,230,0.8)" stroke="rgba(255,255,255,0.9)" stroke-width="0.8"/>
                
                <!-- Janela traseira -->
                <rect x="65" y="22" width="20" height="12" rx="3" fill="rgba(173,216,230,0.8)" stroke="rgba(255,255,255,0.9)" stroke-width="0.8"/>
                
                <!-- Janelas laterais -->
                <rect x="32" y="25" width="8" height="8" rx="2" fill="rgba(173,216,230,0.7)" stroke="rgba(255,255,255,0.7)" stroke-width="0.5"/>
                <rect x="80" y="25" width="8" height="8" rx="2" fill="rgba(173,216,230,0.7)" stroke="rgba(255,255,255,0.7)" stroke-width="0.5"/>
                
                <!-- Far√≥is dianteiros -->
                <circle cx="12" cy="38" r="4" fill="rgba(255,255,255,0.95)" stroke="rgba(255,255,255,1)" stroke-width="1"/>
                <circle cx="12" cy="47" r="4" fill="rgba(255,255,255,0.95)" stroke="rgba(255,255,255,1)" stroke-width="1"/>
                
                <!-- Luzes internas dos far√≥is -->
                <circle cx="12" cy="38" r="2" fill="rgba(255,255,200,0.9)"/>
                <circle cx="12" cy="47" r="2" fill="rgba(255,255,200,0.9)"/>
                
                <!-- Lanternas traseiras -->
                <circle cx="108" cy="38" r="3" fill="rgba(255,80,80,0.9)" stroke="rgba(255,100,100,1)" stroke-width="0.8"/>
                <circle cx="108" cy="47" r="3" fill="rgba(255,80,80,0.9)" stroke="rgba(255,100,100,1)" stroke-width="0.8"/>
                
                <!-- Grade frontal -->
                <rect x="10" y="40" width="6" height="8" rx="1" fill="rgba(0,0,0,0.6)" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                <line x1="11" y1="42" x2="15" y2="42" stroke="rgba(255,255,255,0.4)" stroke-width="0.3"/>
                <line x1="11" y1="44" x2="15" y2="44" stroke="rgba(255,255,255,0.4)" stroke-width="0.3"/>
                <line x1="11" y1="46" x2="15" y2="46" stroke="rgba(255,255,255,0.4)" stroke-width="0.3"/>
                
                <!-- Ma√ßanetas -->
                <rect x="28" y="40" width="2" height="3" rx="1" fill="rgba(192,192,192,0.8)"/>
                <rect x="90" y="40" width="2" height="3" rx="1" fill="rgba(192,192,192,0.8)"/>
                
                <!-- Antena -->
                <line x1="45" y1="18" x2="45" y2="12" stroke="rgba(100,100,100,0.8)" stroke-width="1"/>
                <circle cx="45" cy="12" r="1" fill="rgba(100,100,100,0.8)"/>
            </svg>`;
        }
        
        function mostrarModalLogin() { document.getElementById('modal-login').classList.add('show'); }
        function fecharModalLogin() { document.getElementById('modal-login').classList.remove('show'); }
        
        function fazerLoginAdmin() {
            var u = document.getElementById('username').value.trim();
            var p = document.getElementById('password').value.trim();
            if (u === 'admin' && p === 'admin123') {
                usuarioAtual = 'admin';
                tipoUsuario = 'admin';
                fecharModalLogin();
                document.getElementById('user-name').textContent = 'Administrador';
                document.getElementById('user-badge').textContent = 'ADMIN';
                document.getElementById('user-badge').className = 'user-badge admin';
                document.getElementById('admin-login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'inline-block';
                document.getElementById('admin-panel').classList.add('show');
                habilitarControlesAdmin();
                aplicarModoVisualizacao();
                mostrarNotificacao('üîß Login realizado!', 'sucesso');
            } else {
                mostrarNotificacao('‚ùå Credenciais inv√°lidas', 'erro');
            }
        }

        function logout() {
            if (confirm('Sair do modo administrador?')) {
                usuarioAtual = 'viewer';
                tipoUsuario = 'viewer';
                modoEdicao = false;
                selecaoMultipla = false;
                editandoPlanta = false;
                document.getElementById('user-name').textContent = 'Visualizador P√∫blico';
                document.getElementById('user-badge').textContent = 'VIEWER';
                document.getElementById('user-badge').className = 'user-badge';
                document.getElementById('admin-login-btn').style.display = 'inline-block';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('admin-panel').classList.remove('show');
                document.getElementById('edit-controls').style.display = 'none';
                document.getElementById('zoom-controls').style.display = 'none';
                document.getElementById('planta-controls').style.display = 'none';
                document.getElementById('mapa-estacionamento').classList.remove('modo-edicao');
                document.getElementById('planta-baixa').classList.remove('ajustavel');
                limparSelecaoMultipla();
                desabilitarControlesAdmin();
                aplicarModoVisualizacao();
                mostrarNotificacao('üëã Logout realizado', 'info');
            }
        }

        function aplicarModoVisualizacao() {
            document.querySelectorAll('.vaga').forEach(vaga => {
                if (tipoUsuario === 'viewer') {
                    vaga.classList.add('viewer-mode');
                    vaga.style.cursor = 'default';
                } else {
                    vaga.classList.remove('viewer-mode');
                    vaga.style.cursor = modoEdicao ? 'move' : 'pointer';
                }
            });
        }

        function habilitarControlesAdmin() {
            ['btn-reset', 'btn-ocupar', 'btn-liberar'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
        }

        function desabilitarControlesAdmin() {
            ['btn-reset', 'btn-ocupar', 'btn-liberar'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = true;
            });
        }
        
        function toggleEditPlanta() {
            if (tipoUsuario !== 'admin') return;
            editandoPlanta = !editandoPlanta;
            var btn = document.getElementById('btn-edit-planta');
            var planta = document.getElementById('planta-baixa');
            if (editandoPlanta) {
                btn.classList.add('active');
                planta.classList.add('ajustavel');
                mostrarNotificacao('üìê Modo ajuste de planta ativado', 'info');
            } else {
                btn.classList.remove('active');
                planta.classList.remove('ajustavel');
                mostrarNotificacao('‚úÖ Ajuste de planta finalizado', 'info');
                salvarLocal();
                sincronizarLayoutCompleto();
            }
        }
        
        function ajustarZoom(tipo, incremento) {
            if (tipoUsuario !== 'admin') return;
            var container = document.getElementById('mapa-estacionamento');
            var planta = document.getElementById('planta-baixa');
            if (tipo === 'container') {
                zoomContainer = Math.max(0.3, Math.min(3, zoomContainer + incremento));
                container.style.transform = `scale(${zoomContainer})`;
                document.getElementById('zoom-container').textContent = `${Math.round(zoomContainer * 100)}%`;
            } else if (tipo === 'planta') {
                zoomPlanta = Math.max(0.3, Math.min(3, zoomPlanta + incremento));
                planta.style.transform = `scale(${zoomPlanta})`;
                document.getElementById('zoom-planta').textContent = `${Math.round(zoomPlanta * 100)}%`;
            }
        }

        function resetarZoom(tipo) {
            if (tipoUsuario !== 'admin') return;
            if (tipo === 'container') {
                zoomContainer = 1;
                document.getElementById('mapa-estacionamento').style.transform = 'scale(1)';
                document.getElementById('zoom-container').textContent = '100%';
            } else if (tipo === 'planta') {
                zoomPlanta = 1;
                document.getElementById('planta-baixa').style.transform = 'scale(1)';
                document.getElementById('zoom-planta').textContent = '100%';
            }
        }
        
        function toggleEditMode() {
            if (tipoUsuario !== 'admin') return;
            modoEdicao = !modoEdicao;
            var container = document.getElementById('mapa-estacionamento');
            var btn = document.getElementById('btn-edit-mode');
            if (modoEdicao) {
                container.classList.add('modo-edicao');
                btn.classList.add('active');
                btn.textContent = '‚úÖ Finalizar';
                if (window.innerWidth > 768) {
                    document.getElementById('zoom-controls').style.display = 'block';
                    document.getElementById('planta-controls').style.display = 'block';
                }
                mostrarNotificacao('‚úèÔ∏è Modo edi√ß√£o ativado! Clique nos carros para editar diretamente.', 'info');
            } else {
                container.classList.remove('modo-edicao');
                btn.classList.remove('active');
                btn.textContent = '‚úèÔ∏è Edi√ß√£o';
                document.getElementById('edit-controls').style.display = 'none';
                document.getElementById('zoom-controls').style.display = 'none';
                document.getElementById('planta-controls').style.display = 'none';
                if (vagaSelecionada) {
                    vagaSelecionada.classList.remove('selecionada');
                    vagaSelecionada = null;
                }
                limparSelecaoMultipla();
                salvarLocal();
                sincronizarLayoutCompleto();
                mostrarNotificacao('‚úÖ Modo edi√ß√£o finalizado', 'info');
            }
            aplicarModoVisualizacao();
        }

        function toggleSelecaoMultipla() {
            if (tipoUsuario !== 'admin') return;
            selecaoMultipla = !selecaoMultipla;
            var btn = document.getElementById('btn-multi-select');
            if (selecaoMultipla) {
                btn.classList.add('active');
                btn.textContent = '‚úÖ Multi';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üî≤ Multi';
                limparSelecaoMultipla();
            }
        }

        function limparSelecaoMultipla() {
            vagasMultiplasSelecao.forEach(vaga => vaga.classList.remove('multipla-selecionada'));
            vagasMultiplasSelecao = [];
            atualizarInterfaceSelecaoMultipla();
        }

        function adicionarVagaSelecaoMultipla(vaga) {
            if (!selecaoMultipla || tipoUsuario !== 'admin') return;
            const index = vagasMultiplasSelecao.indexOf(vaga);
            if (index > -1) {
                vagasMultiplasSelecao.splice(index, 1);
                vaga.classList.remove('multipla-selecionada');
            } else {
                vagasMultiplasSelecao.push(vaga);
                vaga.classList.add('multipla-selecionada');
            }
            atualizarInterfaceSelecaoMultipla();
        }
        
        function atualizarInterfaceSelecaoMultipla() {
            const count = vagasMultiplasSelecao.length;
            const multiInfo = document.getElementById('multi-selection-info');
            const multiActions = document.getElementById('multi-actions');
            if (count > 0) {
                multiInfo.style.display = 'block';
                multiActions.style.display = 'block';
                document.getElementById('multi-count').textContent = count;
                document.getElementById('edit-controls').classList.add('show');
            } else {
                multiInfo.style.display = 'none';
                multiActions.style.display = 'none';
                if (!vagaSelecionada) {
                    document.getElementById('edit-controls').classList.remove('show');
                }
            }
        }

        function aplicarRotacaoMultipla(graus) {
            if (vagasMultiplasSelecao.length === 0 || tipoUsuario !== 'admin') return;
            vagasMultiplasSelecao.forEach(vaga => rotacionarVagaIndividual(vaga, graus));
            sincronizarLayoutCompleto();
        }

        function redimensionarMultiplas(dimensao, valor) {
            if (vagasMultiplasSelecao.length === 0 || tipoUsuario !== 'admin') return;
            vagasMultiplasSelecao.forEach(vaga => redimensionarVagaIndividual(vaga, dimensao, valor));
            sincronizarLayoutCompleto();
        }

        function alinharVagasMultiplas(tipo) {
            if (vagasMultiplasSelecao.length < 2 || tipoUsuario !== 'admin') return;
            const referencia = vagasMultiplasSelecao[0];
            const refPos = posicaoVagas[referencia.id];
            vagasMultiplasSelecao.slice(1).forEach(vaga => {
                const vagaId = vaga.id;
                if (tipo === 'horizontal') {
                    posicaoVagas[vagaId].y = refPos.y;
                    vaga.style.top = `${refPos.y}px`;
                } else {
                    posicaoVagas[vagaId].x = refPos.x;
                    vaga.style.left = `${refPos.x}px`;
                }
            });
            sincronizarLayoutCompleto();
        }

        function excluirVagasMultiplas() {
            if (vagasMultiplasSelecao.length === 0 || tipoUsuario !== 'admin') return;
            if (confirm(`Excluir ${vagasMultiplasSelecao.length} vagas?`)) {
                excluirVagasSelecionadas();
            }
        }

        function selecionarVaga(vaga) {
            if (!modoEdicao || tipoUsuario !== 'admin') return;
            if (selecaoMultipla) {
                adicionarVagaSelecaoMultipla(vaga);
                return;
            }
            if (vagaSelecionada) vagaSelecionada.classList.remove('selecionada');
            vagaSelecionada = vaga;
            vaga.classList.add('selecionada');
            document.getElementById('edit-controls').classList.add('show');
            document.getElementById('vaga-selecionada').textContent = vaga.id;
        }

        function criarHandlesVaga(vaga) {
            const handles = document.createElement('div');
            handles.className = 'vaga-handles';
            
            const handleTypes = ['nw', 'n', 'ne', 'w', 'e', 'sw', 's', 'se', 'rotate'];
            handleTypes.forEach(type => {
                const handle = document.createElement('div');
                handle.className = `handle ${type}`;
                handle.addEventListener('mousedown', (e) => iniciarResize(e, type, vaga));
                handle.addEventListener('touchstart', (e) => iniciarResize(e, type, vaga), {passive: false});
                handles.appendChild(handle);
            });
                        const toolbar = document.createElement('div');
            toolbar.className = 'quick-toolbar';
            toolbar.innerHTML = `
                <button class="quick-btn duplicate" onclick="duplicarVagaRapida('${vaga.id}')">üìã</button>
                <button class="quick-btn" onclick="rotacionarVagaRapida('${vaga.id}', 90)">‚Ü∑</button>
                <button class="quick-btn" onclick="rotacionarVagaRapida('${vaga.id}', -90)">‚Ü∂</button>
                <button class="quick-btn delete" onclick="excluirVagaRapida('${vaga.id}')">üóëÔ∏è</button>
            `;
            handles.appendChild(toolbar);
            
            vaga.appendChild(handles);
        }

        function iniciarResize(e, handleType, vaga) {
            if (!modoEdicao || tipoUsuario !== 'admin') return;
            e.preventDefault();
            e.stopPropagation();
            
            handleArrastando = handleType;
            vagaArrastando = vaga;
            
            const containerRect = document.getElementById('mapa-estacionamento').getBoundingClientRect();
            pontoInicialMouse.x = (e.clientX || e.touches[0].clientX - containerRect.left) / zoomContainer;
            pontoInicialMouse.y = (e.clientY || e.touches[0].clientY - containerRect.top) / zoomContainer;
            
            dimensoesIniciaisResize.width = vaga.offsetWidth;
            dimensoesIniciaisResize.height = vaga.offsetHeight;
            anguloInicialRotacao = posicaoVagas[vaga.id].angle || 0;
            
            if (handleType === 'rotate') {
                rotacionandoVaga = true;
                vaga.style.cursor = 'crosshair';
            }
            
            document.body.style.cursor = handleType === 'rotate' ? 'crosshair' : `${handleType}-resize`;
        }

        function processarResize(e) {
            if (!handleArrastando || !vagaArrastando) return;
            
            const container = document.getElementById('mapa-estacionamento');
            const containerRect = container.getBoundingClientRect();
            const mouseX = ((e.clientX || e.touches[0].clientX) - containerRect.left) / zoomContainer;
            const mouseY = ((e.clientY || e.touches[0].clientY) - containerRect.top) / zoomContainer;
            
            const deltaX = mouseX - pontoInicialMouse.x;
            const deltaY = mouseY - pontoInicialMouse.y;
            
            const vaga = vagaArrastando;
            const vagaId = vaga.id;
            
            if (handleArrastando === 'rotate') {
                const centerX = posicaoVagas[vagaId].x + vaga.offsetWidth / 2;
                const centerY = posicaoVagas[vagaId].y + vaga.offsetHeight / 2;
                const angle = Math.atan2(mouseY - centerY, mouseX - centerX) * 180 / Math.PI;
                const novoAngulo = Math.round(angle / 15) * 15;
                
                posicaoVagas[vagaId].angle = novoAngulo;
                const transformProps = vaga.style.transform.replace(/rotate\([^)]*\)/, '').trim();
                vaga.style.transform = `${transformProps} rotate(${novoAngulo}deg)`;
                return;
            }
            
            let novaWidth = dimensoesIniciaisResize.width;
            let novaHeight = dimensoesIniciaisResize.height;
            let novoX = posicaoVagas[vagaId].x;
            let novoY = posicaoVagas[vagaId].y;
            
            switch (handleArrastando) {
                case 'se':
                    novaWidth = Math.max(20, dimensoesIniciaisResize.width + deltaX);
                    novaHeight = Math.max(20, dimensoesIniciaisResize.height + deltaY);
                    break;
                case 'sw':
                    novaWidth = Math.max(20, dimensoesIniciaisResize.width - deltaX);
                    novaHeight = Math.max(20, dimensoesIniciaisResize.height + deltaY);
                    novoX = posicaoVagas[vagaId].x + deltaX;
                    break;
                case 'ne':
                    novaWidth = Math.max(20, dimensoesIniciaisResize.width + deltaX);
                    novaHeight = Math.max(20, dimensoesIniciaisResize.height - deltaY);
                    novoY = posicaoVagas[vagaId].y + deltaY;
                    break;
                case 'nw':
                    novaWidth = Math.max(20, dimensoesIniciaisResize.width - deltaX);
                    novaHeight = Math.max(20, dimensoesIniciaisResize.height - deltaY);
                    novoX = posicaoVagas[vagaId].x + deltaX;
                    novoY = posicaoVagas[vagaId].y + deltaY;
                    break;
                case 'e':
                    novaWidth = Math.max(20, dimensoesIniciaisResize.width + deltaX);
                    break;
                case 'w':
                    novaWidth = Math.max(20, dimensoesIniciaisResize.width - deltaX);
                    novoX = posicaoVagas[vagaId].x + deltaX;
                    break;
                case 's':
                    novaHeight = Math.max(20, dimensoesIniciaisResize.height + deltaY);
                    break;
                case 'n':
                    novaHeight = Math.max(20, dimensoesIniciaisResize.height - deltaY);
                    novoY = posicaoVagas[vagaId].y + deltaY;
                    break;
            }
            
            novoX = Math.max(0, Math.min(novoX, container.offsetWidth - novaWidth));
            novoY = Math.max(0, Math.min(novoY, container.offsetHeight - novaHeight));
            
            vaga.style.width = `${novaWidth}px`;
            vaga.style.height = `${novaHeight}px`;
            vaga.style.left = `${novoX}px`;
            vaga.style.top = `${novoY}px`;
            
            posicaoVagas[vagaId].width = novaWidth;
            posicaoVagas[vagaId].height = novaHeight;
            posicaoVagas[vagaId].x = novoX;
            posicaoVagas[vagaId].y = novoY;
        }

        function finalizarResize() {
            if (handleArrastando) {
                handleArrastando = null;
                rotacionandoVaga = false;
                if (vagaArrastando) {
                    vagaArrastando.style.cursor = 'move';
                    vagaArrastando = null;
                }
                document.body.style.cursor = 'default';
                salvarLocal();
                sincronizarLayoutCompleto();
            }
        }

        function duplicarVagaRapida(vagaId) {
            const vaga = document.getElementById(vagaId);
            if (vaga) {
                vagaSelecionada = vaga;
                duplicarVaga();
            }
        }

        function rotacionarVagaRapida(vagaId, graus) {
            const vaga = document.getElementById(vagaId);
            if (vaga) {
                rotacionarVagaIndividual(vaga, graus);
                salvarLocal();
                sincronizarLayoutCompleto();
            }
        }

        function excluirVagaRapida(vagaId) {
            const vaga = document.getElementById(vagaId);
            if (vaga && confirm(`Excluir vaga ${vagaId}?`)) {
                vagaSelecionada = vaga;
                excluirVagasSelecionadas();
            }
        }

        function moverVaga(deltaX, deltaY) {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            moverVagaIndividual(vagaSelecionada, deltaX, deltaY);
        }

        function rotacionarVaga(graus) {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            rotacionarVagaIndividual(vagaSelecionada, graus);
        }
        
        function redimensionarVaga(dimensao, valor) {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            redimensionarVagaIndividual(vagaSelecionada, dimensao, valor);
        }

        function excluirVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            if (confirm(`Excluir vaga ${vagaSelecionada.id}?`)) {
                excluirVagasSelecionadas();
            }
        }
        
        function iniciarArraste(e) {
            if (!modoEdicao || tipoUsuario !== 'admin') return;
            const vagaClicada = e.target.closest('.vaga');
            if (!vagaClicada || handleArrastando) return;

            if (e.target.classList.contains('handle') || e.target.classList.contains('quick-btn')) {
                return;
            }

            e.preventDefault();
            e.stopPropagation();

            if (e.shiftKey || (e.type === 'wheel' && e.ctrlKey)) {
                const graus = e.deltaY > 0 ? 15 : -15;
                rotacionarVagaIndividual(vagaClicada, graus);
                salvarLocal();
                sincronizarLayoutCompleto();
                return;
            }

            if (selecaoMultipla && (e.ctrlKey || e.metaKey)) {
                adicionarVagaSelecaoMultipla(vagaClicada);
                return;
            }

            if (selecaoMultipla && vagaClicada.classList.contains('multipla-selecionada')) {
                isArrastandoMultiplos = true;
                vagaArrastando = vagaClicada;
                posicoesIniciaisArrastar = vagasMultiplasSelecao.map(v => ({
                    el: v, x: posicaoVagas[v.id].x, y: posicaoVagas[v.id].y
                }));
            } else {
                isArrastandoMultiplos = false;
                limparSelecaoMultipla();
                selecionarVaga(vagaClicada);
                vagaArrastando = vagaClicada;
                posicoesIniciaisArrastar = [{ el: vagaArrastando, x: posicaoVagas[vagaArrastando.id].x, y: posicaoVagas[vagaArrastando.id].y }];
            }

            const containerRect = document.getElementById('mapa-estacionamento').getBoundingClientRect();
            pontoInicialMouse.x = ((e.clientX || e.touches[0].clientX) - containerRect.left) / zoomContainer;
            pontoInicialMouse.y = ((e.clientY || e.touches[0].clientY) - containerRect.top) / zoomContainer;

            (isArrastandoMultiplos ? vagasMultiplasSelecao : [vagaArrastando]).forEach(v => {
                v.classList.add('arrastando');
                v.style.pointerEvents = 'none';
            });
            document.body.style.cursor = 'move';
        }

        function arrastar(e) {
            if (painelArrastando) { arrastarPainel(e); return; }
            if (handleArrastando) { processarResize(e); return; }
            if (!vagaArrastando) return;

            var container = document.getElementById('mapa-estacionamento');
            var containerRect = container.getBoundingClientRect();
            const mouseX = ((e.clientX || e.touches[0].clientX) - containerRect.left) / zoomContainer;
            const mouseY = ((e.clientY || e.touches[0].clientY) - containerRect.top) / zoomContainer;
            const deltaX = mouseX - pontoInicialMouse.x;
            const deltaY = mouseY - pontoInicialMouse.y;

            posicoesIniciaisArrastar.forEach(posInicial => {
                const vagaEl = posInicial.el;
                let novoX = posInicial.x + deltaX;
                let novoY = posInicial.y + deltaY;

                novoX = Math.max(0, Math.min(novoX, container.offsetWidth - vagaEl.offsetWidth));
                novoY = Math.max(0, Math.min(novoY, container.offsetHeight - vagaEl.offsetHeight));

                vagaEl.style.left = `${novoX}px`;
                vagaEl.style.top = `${novoY}px`;
                posicaoVagas[vagaEl.id].x = novoX;
                posicaoVagas[vagaEl.id].y = novoY;
            });
        }

        function finalizarArraste() {
            if (vagaArrastando) {
                const alvos = isArrastandoMultiplos ? vagasMultiplasSelecao : [vagaArrastando];
                alvos.forEach(v => {
                    v.classList.remove('arrastando');
                    v.style.pointerEvents = 'auto';
                });
                document.body.style.cursor = 'default';
                vagaArrastando = null;
                isArrastandoMultiplos = false;
                posicoesIniciaisArrastar = [];
                salvarLocal();
                sincronizarLayoutCompleto();
            }
            if (painelArrastando) finalizarArrastePainel();
            if (handleArrastando) finalizarResize();
        }

        function lidarComTeclado(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            const alvos = vagasMultiplasSelecao.length > 0 ? vagasMultiplasSelecao : (vagaSelecionada ? [vagaSelecionada] : []);
            if (!modoEdicao || alvos.length === 0) return;

            const teclasInterceptadas = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Delete', 'Escape', '+', '-'];
            if (teclasInterceptadas.includes(e.key) || e.key.toLowerCase() === 'r') {
                e.preventDefault();
            } else {
                return;
            }
            
            const passo = e.shiftKey ? 10 : 1;
            let acaoRealizada = true;

            switch (e.key) {
                case 'ArrowUp': alvos.forEach(v => moverVagaIndividual(v, 0, -passo)); break;
                case 'ArrowDown': alvos.forEach(v => moverVagaIndividual(v, 0, passo)); break;
                case 'ArrowLeft': alvos.forEach(v => moverVagaIndividual(v, -passo, 0)); break;
                case 'ArrowRight': alvos.forEach(v => moverVagaIndividual(v, passo, 0)); break;
                case 'r': case 'R':
                    const graus = e.shiftKey ? -90 : 90;
                    alvos.forEach(v => rotacionarVagaIndividual(v, graus));
                    break;
                case '+':
                    const dimAumento = e.ctrlKey ? 'height' : 'width';
                    alvos.forEach(v => redimensionarVagaIndividual(v, dimAumento, passo));
                    break;
                case '-':
                    const dimReducao = e.ctrlKey ? 'height' : 'width';
                    alvos.forEach(v => redimensionarVagaIndividual(v, dimReducao, -passo));
                    break;
                case 'Delete':
                    if (confirm(`Excluir ${alvos.length} vaga(s) selecionada(s)?`)) {
                        excluirVagasSelecionadas();
                    }
                    break;
                case 'Escape':
                    limparSelecaoMultipla();
                    if (vagaSelecionada) {
                        vagaSelecionada.classList.remove('selecionada');
                        vagaSelecionada = null;
                    }
                    document.getElementById('edit-controls').classList.remove('show');
                    break;
                default:
                    acaoRealizada = false;
                    break;
            }
            
            if (acaoRealizada) {
                salvarLocal();
                sincronizarLayoutCompleto();
            }
        }

        function moverVagaIndividual(vaga, dx, dy) {
            const id = vaga.id;
            const container = document.getElementById('mapa-estacionamento');
            let novoX = (posicaoVagas[id].x || 0) + dx;
            let novoY = (posicaoVagas[id].y || 0) + dy;
            novoX = Math.max(0, Math.min(novoX, container.offsetWidth - vaga.offsetWidth));
            novoY = Math.max(0, Math.min(novoY, container.offsetHeight - vaga.offsetHeight));
            posicaoVagas[id].x = novoX;
            posicaoVagas[id].y = novoY;
            vaga.style.left = `${novoX}px`;
            vaga.style.top = `${novoY}px`;
        }

        function rotacionarVagaIndividual(vaga, graus) {
            const id = vaga.id;
            const novoAngulo = ((posicaoVagas[id].angle || 0) + graus) % 360;
            posicaoVagas[id].angle = novoAngulo;
            const transformProps = vaga.style.transform.replace(/rotate\([^)]*\)/, '').trim();
            vaga.style.transform = `${transformProps} rotate(${novoAngulo}deg)`;
        }

        function redimensionarVagaIndividual(vaga, dimensao, valor) {
            const id = vaga.id;
            if (!posicaoVagas[id].width) posicaoVagas[id].width = vaga.offsetWidth;
            if (!posicaoVagas[id].height) posicaoVagas[id].height = vaga.offsetHeight;

            if (dimensao === 'width') {
                posicaoVagas[id].width = Math.max(20, posicaoVagas[id].width + valor);
                vaga.style.width = `${posicaoVagas[id].width}px`;
            } else {
                posicaoVagas[id].height = Math.max(20, posicaoVagas[id].height + valor);
                vaga.style.height = `${posicaoVagas[id].height}px`;
            }
        }

        function excluirVagasSelecionadas() {
            const alvos = vagasMultiplasSelecao.length > 0 ? vagasMultiplasSelecao : (vagaSelecionada ? [vagaSelecionada] : []);
            if (alvos.length === 0) return;
            alvos.forEach(vaga => {
                delete estadoVagas[vaga.id];
                delete posicaoVagas[vaga.id];
                vaga.remove();
                totalVagas--;
            });
            limparSelecaoMultipla();
            if (vagaSelecionada) vagaSelecionada = null;
            document.getElementById('edit-controls').classList.remove('show');
            atualizarEstatisticas();
            sincronizarLayoutCompleto();
        }

        function inicializarVagas() {
            var posicoesDefault = [
                {id: 'V01', x: 50, y: 50}, {id: 'V02', x: 100, y: 50}, {id: 'V03', x: 150, y: 50},
                {id: 'V04', x: 200, y: 50}, {id: 'V05', x: 250, y: 50}, {id: 'V06', x: 300, y: 50},
                {id: 'V07', x: 350, y: 50}, {id: 'V08', x: 400, y: 50}, {id: 'V09', x: 450, y: 50},
                {id: 'V10', x: 500, y: 50}, {id: 'V11', x: 50, y: 150}, {id: 'V12', x: 100, y: 150},
                {id: 'V13', x: 150, y: 150}, {id: 'V14', x: 200, y: 150}, {id: 'V15', x: 250, y: 150},
                {id: 'V16', x: 300, y: 150}, {id: 'V17', x: 350, y: 150}, {id: 'V18', x: 400, y: 150},
                {id: 'V19', x: 450, y: 150}, {id: 'V20', x: 500, y: 150}, {id: 'V21', x: 50, y: 250},
                {id: 'V22', x: 100, y: 250}, {id: 'V23', x: 150, y: 250}, {id: 'V24', x: 200, y: 250},
                {id: 'V25', x: 250, y: 250}, {id: 'V26', x: 300, y: 250}, {id: 'V27', x: 350, y: 250},
                {id: 'V28', x: 400, y: 250}, {id: 'V29', x: 450, y: 250}, {id: 'V30', x: 500, y: 250},
                {id: 'V31', x: 50, y: 350}, {id: 'V32', x: 100, y: 350}, {id: 'V33', x: 150, y: 350},
                {id: 'V34', x: 200, y: 350}, {id: 'V35', x: 250, y: 350}, {id: 'V36', x: 300, y: 350},
                {id: 'V37', x: 350, y: 350}, {id: 'V38', x: 400, y: 350}, {id: 'V39', x: 450, y: 350},
                {id: 'V40', x: 500, y: 350}, {id: 'V41', x: 50, y: 450}, {id: 'V42', x: 100, y: 450},
                {id: 'V43', x: 150, y: 450}, {id: 'V44', x: 200, y: 450}, {id: 'V45', x: 250, y: 450},
                {id: 'V46', x: 300, y: 450}, {id: 'V47', x: 350, y: 450}, {id: 'V48', x: 400, y: 450},
                {id: 'V49', x: 450, y: 450}, {id: 'V50', x: 500, y: 450}, {id: 'V51', x: 50, y: 550},
                {id: 'V52', x: 100, y: 550}, {id: 'V53', x: 150, y: 550}, {id: 'V54', x: 200, y: 550},
                {id: 'V55', x: 250, y: 550}, {id: 'V56', x: 300, y: 550}, {id: 'V57', x: 350, y: 550},
                {id: 'V58', x: 400, y: 550}, {id: 'V59', x: 450, y: 550}, {id: 'V60', x: 500, y: 550},
                {id: 'V61', x: 275, y: 650}, {id: 'V62', x: 325, y: 650}
            ];
            
            totalVagas = 0;
            proximoIdVaga = 1;
            document.getElementById('mapa-estacionamento').innerHTML = '<div class="planta-baixa" id="planta-baixa"></div>';
            
            var posicoesParaUsar = Object.keys(posicaoVagas).length > 0 ? posicaoVagas : {};
            if (Object.keys(posicoesParaUsar).length === 0) {
                posicoesDefault.forEach(p => { 
                    posicoesParaUsar[p.id] = { 
                        x: p.x, 
                        y: p.y, 
                        width: null, 
                        height: null, 
                        angle: 0 
                    }; 
                });
            }

            Object.keys(posicoesParaUsar).forEach(id => {
                criarVaga(id, posicoesParaUsar[id]);
            });

            atualizarEstatisticas();
            aplicarModoVisualizacao();
        }

        function criarVaga(id, posicao) {
            var vaga = document.createElement('div');
            vaga.className = 'vaga livre';
            vaga.id = id;
            vaga.innerHTML = criarIconeCarro() + `<div class="car-text">${id}</div>`;
            vaga.style.left = `${posicao.x}px`;
            vaga.style.top = `${posicao.y}px`;
            
            if (posicao.width) vaga.style.width = `${posicao.width}px`;
            if (posicao.height) vaga.style.height = `${posicao.height}px`;
            if (posicao.angle) vaga.style.transform = `rotate(${posicao.angle}deg)`;

            vaga.addEventListener('click', function(e) {
                if (modoEdicao && tipoUsuario === 'admin') {
                    selecionarVaga(vaga);
                } else if (tipoUsuario === 'admin') {
                    alternarStatusVaga(id);
                }
            });

            vaga.addEventListener('mousedown', iniciarArraste);
            vaga.addEventListener('touchstart', iniciarArraste, {passive: false});
            vaga.addEventListener('wheel', iniciarArraste, {passive: false});

            criarHandlesVaga(vaga);

            document.getElementById('mapa-estacionamento').appendChild(vaga);
            
            estadoVagas[id] = estadoVagas[id] || 'livre';
            posicaoVagas[id] = posicao;
            totalVagas++;
            proximoIdVaga = Math.max(proximoIdVaga, parseInt(id.replace(/\D/g, '')) + 1);
        }

        function alternarStatusVaga(id) {
            if (tipoUsuario !== 'admin') return;
            var vaga = document.getElementById(id);
            if (!vaga) return;
            
            estadoVagas[id] = estadoVagas[id] === 'livre' ? 'ocupada' : 'livre';
            vaga.className = `vaga ${estadoVagas[id]}`;
            atualizarEstatisticas();
            salvarLocal();
            sincronizarEstadoFirebase();
        }

        function atualizarEstatisticas() {
            var livres = Object.values(estadoVagas).filter(status => status === 'livre').length;
            var ocupadas = totalVagas - livres;
            var taxa = totalVagas > 0 ? Math.round((ocupadas / totalVagas) * 100) : 0;
            
            document.getElementById('total-vagas').textContent = totalVagas;
            document.getElementById('vagas-livres').textContent = livres;
            document.getElementById('vagas-ocupadas').textContent = ocupadas;
            document.getElementById('taxa-ocupacao').textContent = `${taxa}%`;
            document.getElementById('ultima-atualizacao').textContent = new Date().toLocaleTimeString('pt-BR');
        }

        function resetarTodasVagas() {
            if (tipoUsuario !== 'admin') return;
            if (confirm('Resetar todas as vagas para LIVRE?')) {
                Object.keys(estadoVagas).forEach(id => {
                    estadoVagas[id] = 'livre';
                    var vaga = document.getElementById(id);
                    if (vaga) vaga.className = 'vaga livre';
                });
                atualizarEstatisticas();
                salvarLocal();
                sincronizarEstadoFirebase();
                mostrarNotificacao('üîÑ Todas as vagas foram resetadas', 'sucesso');
            }
        }

        function ocuparTodasVagas() {
            if (tipoUsuario !== 'admin') return;
            if (confirm('Ocupar todas as vagas?')) {
                Object.keys(estadoVagas).forEach(id => {
                    estadoVagas[id] = 'ocupada';
                    var vaga = document.getElementById(id);
                    if (vaga) vaga.className = 'vaga ocupada';
                });
                atualizarEstatisticas();
                salvarLocal();
                sincronizarEstadoFirebase();
                mostrarNotificacao('üöó Todas as vagas foram ocupadas', 'sucesso');
            }
        }

        function liberarTodasVagas() {
            if (tipoUsuario !== 'admin') return;
            if (confirm('Liberar todas as vagas?')) {
                Object.keys(estadoVagas).forEach(id => {
                    estadoVagas[id] = 'livre';
                    var vaga = document.getElementById(id);
                    if (vaga) vaga.className = 'vaga livre';
                });
                atualizarEstatisticas();
                salvarLocal();
                sincronizarEstadoFirebase();
                mostrarNotificacao('‚úÖ Todas as vagas foram liberadas', 'sucesso');
            }
        }

        function adicionarNovaVaga() {
            if (tipoUsuario !== 'admin') return;
            var novoId = `V${proximoIdVaga.toString().padStart(2, '0')}`;
            var container = document.getElementById('mapa-estacionamento');
            var novaPosicao = {
                x: Math.random() * (container.offsetWidth - 50),
                y: Math.random() * (container.offsetHeight - 75),
                width: null,
                height: null,
                angle: 0
            };
            criarVaga(novoId, novaPosicao);
            atualizarEstatisticas();
            salvarLocal();
            sincronizarLayoutCompleto();
            mostrarNotificacao(`‚ûï Vaga ${novoId} adicionada`, 'sucesso');
        }

        function duplicarVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var novoId = `V${proximoIdVaga.toString().padStart(2, '0')}`;
            var posOriginal = posicaoVagas[vagaSelecionada.id];
            var novaPosicao = {
                x: posOriginal.x + 60,
                y: posOriginal.y + 20,
                width: posOriginal.width,
                height: posOriginal.height,
                angle: posOriginal.angle || 0
            };
            criarVaga(novoId, novaPosicao);
            atualizarEstatisticas();
            salvarLocal();
            sincronizarLayoutCompleto();
            mostrarNotificacao(`üìã Vaga ${novoId} duplicada`, 'sucesso');
        }

        function renomearVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var novoNome = prompt('Novo nome da vaga:', vagaSelecionada.id);
            if (novoNome && novoNome !== vagaSelecionada.id && !document.getElementById(novoNome)) {
                var antigoId = vagaSelecionada.id;
                estadoVagas[novoNome] = estadoVagas[antigoId];
                posicaoVagas[novoNome] = posicaoVagas[antigoId];
                delete estadoVagas[antigoId];
                delete posicaoVagas[antigoId];
                vagaSelecionada.id = novoNome;
                vagaSelecionada.querySelector('.car-text').textContent = novoNome;
                document.getElementById('vaga-selecionada').textContent = novoNome;
                salvarLocal();
                sincronizarLayoutCompleto();
                mostrarNotificacao(`‚úèÔ∏è Vaga renomeada para ${novoNome}`, 'sucesso');
            }
        }

        function centralizarVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var container = document.getElementById('mapa-estacionamento');
            var novoX = (container.offsetWidth - vagaSelecionada.offsetWidth) / 2;
            var novoY = (container.offsetHeight - vagaSelecionada.offsetHeight) / 2;
            posicaoVagas[vagaSelecionada.id].x = novoX;
            posicaoVagas[vagaSelecionada.id].y = novoY;
            vagaSelecionada.style.left = `${novoX}px`;
            vagaSelecionada.style.top = `${novoY}px`;
            salvarLocal();
            sincronizarLayoutCompleto();
        }

        function resetarRotacao() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            posicaoVagas[vagaSelecionada.id].angle = 0;
            vagaSelecionada.style.transform = vagaSelecionada.style.transform.replace(/rotate\([^)]*\)/, '');
            salvarLocal();
            sincronizarLayoutCompleto();
        }

        function resetarTamanho() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            posicaoVagas[vagaSelecionada.id].width = null;
            posicaoVagas[vagaSelecionada.id].height = null;
            vagaSelecionada.style.width = '';
            vagaSelecionada.style.height = '';
            salvarLocal();
            sincronizarLayoutCompleto();
        }

        function carregarPlantaBaixa() {
            if (tipoUsuario !== 'admin') return;
            document.getElementById('planta-input').click();
        }

        function processarPlantaBaixa(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                var planta = document.getElementById('planta-baixa');
                planta.style.backgroundImage = `url(${e.target.result})`;
                salvarLocal();
                mostrarNotificacao('üñºÔ∏è Planta baixa carregada', 'sucesso');
            };
            reader.readAsDataURL(file);
        }

        function ajustarPlanta(modo) {
            if (tipoUsuario !== 'admin') return;
            var planta = document.getElementById('planta-baixa');
            plantaConfig.size = modo;
            planta.style.backgroundSize = modo;
            salvarLocal();
        }

        function centralizarPlanta() {
            if (tipoUsuario !== 'admin') return;
            var planta = document.getElementById('planta-baixa');
            plantaConfig.posX = 50;
            plantaConfig.posY = 50;
            planta.style.backgroundPosition = '50% 50%';
            salvarLocal();
        }

        function resetarPlanta() {
            if (tipoUsuario !== 'admin') return;
            var planta = document.getElementById('planta-baixa');
            plantaConfig = {size: 'cover', posX: 50, posY: 50};
            planta.style.backgroundSize = 'cover';
            planta.style.backgroundPosition = '50% 50%';
            salvarLocal();
        }

        function exportarLayout() {
            if (tipoUsuario !== 'admin') return;
            var dados = {
                vagas: posicaoVagas,
                estados: estadoVagas,
                planta: plantaConfig,
                plantaImagem: document.getElementById('planta-baixa').style.backgroundImage,
                totalVagas: totalVagas,
                proximoId: proximoIdVaga
            };
            var blob = new Blob([JSON.stringify(dados, null, 2)], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = `layout-estacionamento-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            mostrarNotificacao('üì§ Layout exportado', 'sucesso');
        }

        function importarLayout() {
            if (tipoUsuario !== 'admin') return;
            document.getElementById('import-input').click();
        }

        function processarImportacao(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var dados = JSON.parse(e.target.result);
                    posicaoVagas = dados.vagas || {};
                    estadoVagas = dados.estados || {};
                    plantaConfig = dados.planta || {size: 'cover', posX: 50, posY: 50};
                    totalVagas = dados.totalVagas || 0;
                    proximoIdVaga = dados.proximoId || 1;
                    
                    if (dados.plantaImagem) {
                        document.getElementById('planta-baixa').style.backgroundImage = dados.plantaImagem;
                    }
                    
                    inicializarVagas();
                    salvarLocal();
                    sincronizarLayoutCompleto();
                    mostrarNotificacao('üì• Layout importado com sucesso', 'sucesso');
                } catch (error) {
                    mostrarNotificacao('‚ùå Erro ao importar layout', 'erro');
                }
            };
            reader.readAsText(file);
        }

        function salvarEstadoLocal() {
            salvarLocal();
            mostrarNotificacao('üíæ Estado salvo localmente', 'sucesso');
        }

        function salvarLocal() {
            try {
                localStorage.setItem('estacionamento-estados', JSON.stringify(estadoVagas));
                localStorage.setItem('estacionamento-posicoes', JSON.stringify(posicaoVagas));
                localStorage.setItem('estacionamento-planta', JSON.stringify(plantaConfig));
                localStorage.setItem('estacionamento-planta-img', document.getElementById('planta-baixa').style.backgroundImage);
                localStorage.setItem('estacionamento-total', totalVagas.toString());
                localStorage.setItem('estacionamento-proximo-id', proximoIdVaga.toString());
            } catch (error) {
                console.error('Erro ao salvar localmente:', error);
            }
        }

        function carregarLocal() {
            try {
                var estados = localStorage.getItem('estacionamento-estados');
                var posicoes = localStorage.getItem('estacionamento-posicoes');
                var planta = localStorage.getItem('estacionamento-planta');
                var plantaImg = localStorage.getItem('estacionamento-planta-img');
                var total = localStorage.getItem('estacionamento-total');
                var proximoId = localStorage.getItem('estacionamento-proximo-id');
                
                if (estados) estadoVagas = JSON.parse(estados);
                if (posicoes) posicaoVagas = JSON.parse(posicoes);
                if (planta) plantaConfig = JSON.parse(planta);
                if (plantaImg) document.getElementById('planta-baixa').style.backgroundImage = plantaImg;
                if (total) totalVagas = parseInt(total);
                if (proximoId) proximoIdVaga = parseInt(proximoId);
            } catch (error) {
                console.error('Erro ao carregar dados locais:', error);
            }
        }

        function inicializarFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseConectado = true;
                atualizarStatusFirebase('conectado', 'Firebase Conectado');
                
                database.ref('estacionamento/estados').on('value', function(snapshot) {
                    if (snapshot.exists()) {
                        var dadosRemoto = snapshot.val();
                        Object.keys(dadosRemoto).forEach(id => {
                            if (estadoVagas[id] !== dadosRemoto[id]) {
                                estadoVagas[id] = dadosRemoto[id];
                                var vaga = document.getElementById(id);
                                if (vaga) vaga.className = `vaga ${dadosRemoto[id]}`;
                            }
                        });
                        atualizarEstatisticas();
                    }
                });
                
                database.ref('estacionamento/layout').on('value', function(snapshot) {
                    if (snapshot.exists()) {
                        var layout = snapshot.val();
                        if (layout.posicoes && Object.keys(layout.posicoes).length > 0) {
                            posicaoVagas = layout.posicoes;
                            if (layout.planta) plantaConfig = layout.planta;
                            if (layout.plantaImg) {
                                document.getElementById('planta-baixa').style.backgroundImage = layout.plantaImg;
                            }
                            inicializarVagas();
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro Firebase:', error);
                firebaseConectado = false;
                atualizarStatusFirebase('desconectado', 'Firebase Desconectado');
            }
        }

        function atualizarStatusFirebase(status, texto) {
            var statusEl = document.getElementById('status-firebase');
            var textoEl = document.getElementById('texto-firebase');
            statusEl.className = `status-firebase ${status}`;
            textoEl.textContent = texto;
        }

        function sincronizarEstadoFirebase() {
            if (!firebaseConectado || !database) return;
            try {
                database.ref('estacionamento/estados').set(estadoVagas);
            } catch (error) {
                console.error('Erro ao sincronizar estados:', error);
            }
        }

        function sincronizarLayoutCompleto() {
            if (!firebaseConectado || !database) return;
            try {
                var layoutData = {
                    posicoes: posicaoVagas,
                    planta: plantaConfig,
                    plantaImg: document.getElementById('planta-baixa').style.backgroundImage,
                    totalVagas: totalVagas,
                    proximoId: proximoIdVaga
                };
                database.ref('estacionamento/layout').set(layoutData);
            } catch (error) {
                console.error('Erro ao sincronizar layout:', error);
            }
        }

        function salvarNoFirebase() {
            if (!firebaseConectado || !database) {
                mostrarNotificacao('‚ùå Firebase n√£o conectado', 'erro');
                return;
            }
            try {
                sincronizarEstadoFirebase();
                sincronizarLayoutCompleto();
                mostrarNotificacao('üåê Dados salvos no Firebase', 'sucesso');
            } catch (error) {
                mostrarNotificacao('‚ùå Erro ao salvar no Firebase', 'erro');
            }
        }

        function mostrarNotificacao(mensagem, tipo = 'info') {
            var notif = document.createElement('div');
            notif.className = `notificacao ${tipo}`;
            notif.textContent = mensagem;
            document.body.appendChild(notif);
            
            setTimeout(() => notif.classList.add('mostrar'), 100);
            setTimeout(() => {
                notif.classList.remove('mostrar');
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function iniciarArrastePainel(e) {
            if (e.target.tagName === 'H4') {
                painelArrastando = e.target.closest('.zoom-controls, .planta-controls');
                if (painelArrastando) {
                    painelArrastando.classList.add('dragging');
                    var rect = painelArrastando.getBoundingClientRect();
                    offsetPainelX = e.clientX - rect.left;
                    offsetPainelY = e.clientY - rect.top;
                    e.preventDefault();
                }
            }
        }

        function arrastarPainel(e) {
            if (!painelArrastando) return;
            var novoX = e.clientX - offsetPainelX;
            var novoY = e.clientY - offsetPainelY;
            novoX = Math.max(0, Math.min(novoX, window.innerWidth - painelArrastando.offsetWidth));
            novoY = Math.max(0, Math.min(novoY, window.innerHeight - painelArrastando.offsetHeight));
            painelArrastando.style.left = `${novoX}px`;
            painelArrastando.style.top = `${novoY}px`;
        }

        function finalizarArrastePainel() {
            if (painelArrastando) {
                painelArrastando.classList.remove('dragging');
                painelArrastando = null;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            carregarLocal();
            inicializarVagas();
            inicializarFirebase();
            
            document.addEventListener('mousemove', arrastar);
            document.addEventListener('mouseup', finalizarArraste);
            document.addEventListener('touchmove', arrastar, {passive: false});
            document.addEventListener('touchend', finalizarArraste);
            document.addEventListener('keydown', lidarComTeclado);
            
            document.getElementById('zoom-controls').addEventListener('mousedown', iniciarArrastePainel);
            document.getElementById('planta-controls').addEventListener('mousedown', iniciarArrastePainel);
            
            setInterval(() => {
                if (firebaseConectado) {
                    atualizarStatusFirebase('conectado', `Conectado - ${new Date().toLocaleTimeString('pt-BR')}`);
                }
            }, 30000);
        });
    </script>
</body>
</html>

          
