<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes">
<title>Estacionamento</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
body{margin:0;font-family:sans-serif;background:#667eea}
.container{max-width:1200px;margin:0 auto;background:#fff;border-radius:12px;box-shadow:0 4px 20px #0002;overflow:hidden}
.header{background:#2c3e50;color:#fff;padding:24px 12px 12px;text-align:center;position:relative}
.user-info{position:absolute;top:10px;right:10px;background:#fff3;padding:6px 12px;border-radius:16px}
.user-badge{background:#27ae60;color:#fff;padding:2px 8px;border-radius:8px;font-size:12px;margin-left:4px}
.user-badge.admin{background:#f39c12}
.admin-login-btn,.logout-btn{background:#3498db;color:#fff;border:none;padding:4px 10px;border-radius:10px;cursor:pointer;font-size:12px}
.logout-btn{background:#e74c3c}
.stats{display:flex;gap:12px;justify-content:center;margin-top:12px}
.stat-box{background:#fff2;padding:8px 16px;border-radius:8px}
.estacionamento-wrapper{background:#f8f9fa;padding:8px;overflow-x:auto}
.estacionamento-container{position:relative;width:1200px;height:800px;background:#e8e8e8;border-radius:12px;border:2px solid #34495e;overflow:visible;touch-action:pan-x pan-y pinch-zoom;transition:transform .2s}
.planta-baixa{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-repeat:no-repeat;background-position:center;opacity:.8;z-index:1}
.vaga{position:absolute;width:38px;height:62px;border:2px solid #2c3e50;background:#27ae60cc;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;color:#fff;border-radius:4px;cursor:pointer;transition:.2s;z-index:2;user-select:none}
.vaga.ocupada{background:#e74c3ccc}
.vaga.selecionada{border:3px solid #9b59b6;background:#9b59b6cc}
.vaga.arrastando{z-index:10;transform:scale(1.15);opacity:.85}
.vaga.viewer-mode{cursor:default}
.admin-panel{background:#e67e22;color:#fff;padding:10px;text-align:center;display:none}
.admin-panel.show{display:block}
.admin-controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
.admin-btn{padding:6px 12px;background:#fff2;color:#e67e22;border:1px solid #fff;border-radius:12px;cursor:pointer;font-size:12px}
.edit-controls{position:fixed;top:50%;right:10px;transform:translateY(-50%);background:#fff;padding:12px 12px 4px;border-radius:12px;box-shadow:0 4px 20px #0002;display:none;z-index:100}
.edit-controls.show{display:block}
.edit-btn{width:100%;padding:6px;margin:3px 0;border:none;border-radius:8px;cursor:pointer;font-size:12px}
.edit-btn.delete{background:#e74c3c;color:#fff}
.edit-btn.action{background:#3498db;color:#fff}
.edit-btn.rotate{background:#f39c12;color:#fff}
.size-controls{display:flex;gap:4px}
.size-btn{padding:4px 8px;background:#95a5a6;color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:12px}
.position-controls{display:flex;gap:4px;flex-wrap:wrap}
.position-btn{padding:4px 8px;background:#2c3e50;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:12px}
.controles{padding:10px;background:#ecf0f1;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.btn{padding:8px 16px;border:none;border-radius:12px;cursor:pointer;font-size:12px}
.btn-reset{background:#7f8c8d;color:#fff}
.btn-ocupar{background:#e74c3c;color:#fff}
.btn-liberar{background:#27ae60;color:#fff}
.btn-salvar{background:#3498db;color:#fff}
.btn-firebase{background:#ff9800;color:#fff}
.notificacao{position:fixed;bottom:20px;right:20px;background:#2c3e50;color:#fff;padding:10px 16px;border-radius:10px;z-index:1000;max-width:320px;transform:translateX(400px);transition:.3s}
.notificacao.mostrar{transform:translateX(0)}
.mobile-zoom-controls{position:fixed;bottom:15px;right:15px;background:#fff9;padding:6px 8px;border-radius:10px;display:none;flex-direction:column;gap:4px;z-index:100}
.mobile-zoom-btn{width:34px;height:34px;border:none;border-radius:8px;background:#3498db;color:#fff;font-size:18px;cursor:pointer}
.zoom-indicator{position:fixed;top:14px;left:50%;transform:translateX(-50%);background:#000b;color:#fff;padding:4px 12px;border-radius:16px;font-size:12px;z-index:100;opacity:0;transition:.3s}
.zoom-indicator.show{opacity:1}
@media (max-width:1024px){
  .container{max-width:100vw}
  .estacionamento-wrapper{overflow-x:auto}
  .estacionamento-container{width:1200px;min-width:1200px;height:800px;min-height:800px;}
}
@media (max-width:768px){
  .estacionamento-container{width:1000px;min-width:1000px;height:700px;min-height:700px;}
  .mobile-zoom-controls{display:flex}
}
</style>
</head>
<body>
<div class="modal-login" id="modal-login">
  <div class="login-box">
    <button class="close-modal" onclick="fecharModalLogin()">√ó</button>
    <h2>üîê Login Administrador</h2>
    <input type="text" class="login-input" id="username" placeholder="Usu√°rio">
    <input type="password" class="login-input" id="password" placeholder="Senha">
    <button class="login-btn" onclick="fazerLoginAdmin()">Entrar como Admin</button>
  </div>
</div>
<div class="status-firebase" id="status-firebase">
  <div class="indicador-firebase"></div>
  <span id="texto-firebase">Sistema Inicializado</span>
</div>
<div class="container">
  <div class="header">
    <div class="user-info">
      <span id="user-name">Visualizador P√∫blico</span>
      <span class="user-badge" id="user-badge">VIEWER</span>
      <button class="admin-login-btn" id="admin-login-btn" onclick="mostrarModalLogin()">Login Admin</button>
      <button class="logout-btn" id="logout-btn" onclick="logout()" style="display:none;">Sair</button>
    </div>
    <h1>üöó Estacionamento</h1>
    <p><strong>√öltima atualiza√ß√£o:</strong> <span id="ultima-atualizacao">Agora</span></p>
    <div class="stats">
      <div class="stat-box"><span class="stat-number" id="total-vagas">62</span> Total</div>
      <div class="stat-box"><span class="stat-number" id="vagas-livres">62</span> Livres</div>
      <div class="stat-box"><span class="stat-number" id="vagas-ocupadas">0</span> Ocupadas</div>
      <div class="stat-box"><span class="stat-number" id="taxa-ocupacao">0%</span> Ocupa√ß√£o</div>
    </div>
  </div>
  <div class="admin-panel" id="admin-panel">
    <div class="admin-controls">
      <button class="admin-btn" id="btn-edit-mode" onclick="toggleEditMode()">‚úèÔ∏è Edi√ß√£o</button>
      <button class="admin-btn" onclick="adicionarNovaVaga()">‚ûï Nova Vaga</button>
      <button class="admin-btn" onclick="carregarPlantaBaixa()">üñºÔ∏è Planta</button>
      <button class="admin-btn" onclick="exportarLayout()">üì§ Exportar</button>
      <button class="admin-btn" onclick="importarLayout()">üì• Importar</button>
    </div>
  </div>
  <div class="estacionamento-wrapper">
    <div class="zoom-indicator" id="zoom-indicator">Zoom: 100%</div>
    <div class="mobile-zoom-controls" id="mobile-zoom-controls">
      <button class="mobile-zoom-btn" onclick="ajustarZoomMobile(0.2)">+</button>
      <button class="mobile-zoom-btn" onclick="ajustarZoomMobile(-0.2)">-</button>
      <button class="mobile-zoom-btn" onclick="resetarZoomMobile()">‚ü≤</button>
    </div>
    <div class="estacionamento-container" id="mapa-estacionamento">
      <div class="planta-baixa" id="planta-baixa"></div>
    </div>
  </div>
  <div class="edit-controls" id="edit-controls">
    <div style="text-align:center;margin-bottom:8px;color:#2c3e50;font-weight:bold;">
      üîß Editando: <span id="vaga-selecionada">-</span>
    </div>
    <div class="position-controls">
      <button class="position-btn" onclick="moverVaga(-10,-10)">‚Üñ</button>
      <button class="position-btn" onclick="moverVaga(0,-10)">‚Üë</button>
      <button class="position-btn" onclick="moverVaga(10,-10)">‚Üó</button>
      <button class="position-btn" onclick="moverVaga(-10,0)">‚Üê</button>
      <button class="position-btn" onclick="centralizarVaga()">‚åñ</button>
      <button class="position-btn" onclick="moverVaga(10,0)">‚Üí</button>
      <button class="position-btn" onclick="moverVaga(-10,10)">‚Üô</button>
      <button class="position-btn" onclick="moverVaga(0,10)">‚Üì</button>
      <button class="position-btn" onclick="moverVaga(10,10)">‚Üò</button>
    </div>
    <button class="edit-btn rotate" onclick="rotacionarVaga(-90)">‚Ü∂ -90¬∞</button>
    <button class="edit-btn rotate" onclick="rotacionarVaga(90)">‚Ü∑ +90¬∞</button>
    <button class="edit-btn action" onclick="duplicarVaga()">üìã Duplicar</button>
    <button class="edit-btn action" onclick="renomearVaga()">‚úèÔ∏è Renomear</button>
    <button class="edit-btn delete" onclick="excluirVaga()">üóëÔ∏è Excluir</button>
  </div>
  <div class="controles">
    <button class="btn btn-reset" onclick="resetarTodasVagas()" id="btn-reset" disabled>üîÑ Resetar</button>
    <button class="btn btn-ocupar" onclick="ocuparTodasVagas()" id="btn-ocupar" disabled>üöó Ocupar</button>
    <button class="btn btn-liberar" onclick="liberarTodasVagas()" id="btn-liberar" disabled>‚úÖ Liberar</button>
    <button class="btn btn-salvar" onclick="salvarEstadoLocal()">üíæ Salvar</button>
    <button class="btn btn-firebase" onclick="salvarNoFirebase()">üåê Firebase</button>
  </div>
</div>
<input type="file" id="import-input" accept=".json" style="display:none;" onchange="processarImportacao(event)">
<input type="file" id="planta-input" accept="image/*" style="display:none;" onchange="processarPlantaBaixa(event)">
<script>
// --- CONFIG E VARI√ÅVEIS GLOBAIS ---
var firebaseConfig = {apiKey:"AIzaSyCRIgCndKlfXxR7NNnq_qGupgAWyLqzYzc",authDomain:"teste-dbacd.firebaseapp.com",databaseURL:"https://teste-dbacd-default-rtdb.firebaseio.com/",projectId:"teste-dbacd",storageBucket:"teste-dbacd.firebasestorage.app",messagingSenderId:"381642195685",appId:"1:381642195685:web:746eb4df7667813b0e4a0c"};
var estadoVagas={},posicaoVagas={},firebaseConectado=false,database=null,totalVagas=62,usuarioAtual='viewer',tipoUsuario='viewer',modoEdicao=false,proximoIdVaga=63,vagaSelecionada=null,vagaArrastando=null,offsetX=0,offsetY=0,zoomMobile=1,isMobile=window.innerWidth<=1024,plantaConfig={size:'cover',posX:50,posY:50},touchStartDistance=0,touchStartZoom=1;
// --- FUN√á√ïES DE INTERFACE E LOGIN ---
function mostrarModalLogin(){document.getElementById('modal-login').classList.add('show')}
function fecharModalLogin(){document.getElementById('modal-login').classList.remove('show')}
function fazerLoginAdmin(){var u=document.getElementById('username').value.trim(),p=document.getElementById('password').value.trim();if(u==='admin'&&p==='admin123'){usuarioAtual=tipoUsuario='admin';fecharModalLogin();document.getElementById('user-name').textContent='Administrador';document.getElementById('user-badge').textContent='ADMIN';document.getElementById('user-badge').className='user-badge admin';document.getElementById('admin-login-btn').style.display='none';document.getElementById('logout-btn').style.display='inline-block';document.getElementById('admin-panel').classList.add('show');habilitarControlesAdmin();aplicarModoVisualizacao();mostrarNotificacao('üîß Login realizado!','sucesso');}else{mostrarNotificacao('‚ùå Credenciais inv√°lidas','erro');}}
function logout(){if(confirm('Sair do modo administrador?')){usuarioAtual=tipoUsuario='viewer';modoEdicao=false;document.getElementById('user-name').textContent='Visualizador P√∫blico';document.getElementById('user-badge').textContent='VIEWER';document.getElementById('user-badge').className='user-badge';document.getElementById('admin-login-btn').style.display='inline-block';document.getElementById('logout-btn').style.display='none';document.getElementById('admin-panel').classList.remove('show');document.getElementById('edit-controls').style.display='none';aplicarModoVisualizacao();mostrarNotificacao('üëã Logout realizado','info');}}
function habilitarControlesAdmin(){['btn-reset','btn-ocupar','btn-liberar'].forEach(function(id){var btn=document.getElementById(id);if(btn){btn.disabled=false;btn.style.opacity='1';}});}
function desabilitarControlesAdmin(){['btn-reset','btn-ocupar','btn-liberar'].forEach(function(id){var btn=document.getElementById(id);if(btn){btn.disabled=true;btn.style.opacity='0.3';}});}
function aplicarModoVisualizacao(){document.querySelectorAll('.vaga').forEach(function(v){if(tipoUsuario==='viewer'){v.classList.add('viewer-mode');v.style.cursor='default';}else{v.classList.remove('viewer-mode');v.style.cursor='pointer';}});}
// --- FUN√á√ïES DE VAGAS ---
function criarVaga(id,x,y){var v=document.createElement('div');v.className='vaga livre';v.id=id;v.textContent=id;v.style.left=x+'px';v.style.top=y+'px';posicaoVagas[id]={x:x,y:y,width:38,height:62,angle:0};estadoVagas[id]='livre';v.addEventListener('click',function(e){if(tipoUsuario==='admin'){if(modoEdicao){selecionarVaga(v);}else{alternarStatusVaga(v);}}e.stopPropagation();});if(tipoUsuario==='admin'){v.addEventListener('mousedown',iniciarArraste);}document.getElementById('mapa-estacionamento').appendChild(v);return v;}
function alternarStatusVaga(v){if(tipoUsuario!=='admin')return;var id=v.id,estado=estadoVagas[id]==='livre'?'ocupada':'livre';estadoVagas[id]=estado;v.classList.remove('livre','ocupada');v.classList.add(estado);}
function selecionarVaga(v){if(!modoEdicao||tipoUsuario!=='admin')return;if(vagaSelecionada)vagaSelecionada.classList.remove('selecionada');vagaSelecionada=v;v.classList.add('selecionada');document.getElementById('edit-controls').style.display='block';document.getElementById('vaga-selecionada').textContent=v.id;}
function moverVaga(dx,dy){if(!vagaSelecionada||tipoUsuario!=='admin')return;var id=vagaSelecionada.id,nx=(posicaoVagas[id].x||0)+dx,ny=(posicaoVagas[id].y||0)+dy;posicaoVagas[id].x=nx;posicaoVagas[id].y=ny;vagaSelecionada.style.left=nx+'px';vagaSelecionada.style.top=ny+'px';}
function centralizarVaga(){if(!vagaSelecionada||tipoUsuario!=='admin')return;var c=document.getElementById('mapa-estacionamento'),id=vagaSelecionada.id;var cx=(c.offsetWidth-38)/2,cy=(c.offsetHeight-62)/2;posicaoVagas[id].x=cx;posicaoVagas[id].y=cy;vagaSelecionada.style.left=cx+'px';vagaSelecionada.style.top=cy+'px';}
function rotacionarVaga(g){if(!vagaSelecionada||tipoUsuario!=='admin')return;var id=vagaSelecionada.id,a=((posicaoVagas[id].angle||0)+g)%360;posicaoVagas[id].angle=a;vagaSelecionada.style.transform='rotate('+a+'deg)';}
function duplicarVaga(){if(!vagaSelecionada||tipoUsuario!=='admin')return;var nid='V'+(proximoIdVaga<10?'0'+proximoIdVaga:proximoIdVaga);proximoIdVaga++;var nv=criarVaga(nid,parseInt(vagaSelecionada.style.left)+50,parseInt(vagaSelecionada.style.top)+50);posicaoVagas[nid]=Object.assign({},posicaoVagas[vagaSelecionada.id]);posicaoVagas[nid].x+=50;posicaoVagas[nid].y+=50;totalVagas++;}
function renomearVaga(){if(!vagaSelecionada||tipoUsuario!=='admin')return;var nn=prompt('Novo nome:',vagaSelecionada.id);if(nn&&nn!==vagaSelecionada.id&&!document.getElementById(nn)){var old=vagaSelecionada.id;estadoVagas[nn]=estadoVagas[old];posicaoVagas[nn]=posicaoVagas[old];delete estadoVagas[old];delete posicaoVagas[old];vagaSelecionada.id=nn;vagaSelecionada.textContent=nn;document.getElementById('vaga-selecionada').textContent=nn;}}
function excluirVaga(){if(!vagaSelecionada||tipoUsuario!=='admin')return;if(confirm('Excluir vaga '+vagaSelecionada.id+'?')){var id=vagaSelecionada.id;delete estadoVagas[id];delete posicaoVagas[id];vagaSelecionada.remove();vagaSelecionada=null;totalVagas--;document.getElementById('edit-controls').style.display='none';}}
function adicionarNovaVaga(){if(tipoUsuario!=='admin')return;var nid='V'+(proximoIdVaga<10?'0'+proximoIdVaga:proximoIdVaga);proximoIdVaga++;var nv=criarVaga(nid,100,100);totalVagas++;if(modoEdicao)selecionarVaga(nv);}
function iniciarArraste(e){if(!modoEdicao||tipoUsuario!=='admin')return;vagaArrastando=e.target;selecionarVaga(vagaArrastando);vagaArrastando.classList.add('arrastando');var rect=vagaArrastando.getBoundingClientRect(),cRect=document.getElementById('mapa-estacionamento').getBoundingClientRect();offsetX=e.clientX-rect.left;offsetY=e.clientY-rect.top;e.preventDefault();e.stopPropagation();document.body.style.cursor='move';vagaArrastando.style.pointerEvents='none';}
function arrastar(e){if(!vagaArrastando||!modoEdicao||tipoUsuario!=='admin')return;var cRect=document.getElementById('mapa-estacionamento').getBoundingClientRect(),x=e.clientX-cRect.left-offsetX,y=e.clientY-cRect.top-offsetY;x=Math.max(0,Math.min(x,cRect.width-38));y=Math.max(0,Math.min(y,cRect.height-62));vagaArrastando.style.left=x+'px';vagaArrastando.style.top=y+'px';posicaoVagas[vagaArrastando.id].x=x;posicaoVagas[vagaArrastando.id].y=y;}
function finalizarArraste(){if(vagaArrastando&&tipoUsuario==='admin'){vagaArrastando.classList.remove('arrastando');vagaArrastando.style.pointerEvents='auto';document.body.style.cursor='default';vagaArrastando=null;}}
function resetarTodasVagas(){if(tipoUsuario!=='admin')return;if(confirm('Resetar todas as vagas para LIVRE?')){for(var id in estadoVagas){estadoVagas[id]='livre';var v=document.getElementById(id);if(v){v.classList.remove('ocupada');v.classList.add('livre');}}}}
function ocuparTodasVagas(){if(tipoUsuario!=='admin')return;if(confirm('Ocupar todas as vagas?')){for(var id in estadoVagas){estadoVagas[id]='ocupada';var v=document.getElementById(id);if(v){v.classList.remove('livre');v.classList.add('ocupada');}}}}
function liberarTodasVagas(){if(tipoUsuario!=='admin')return;if(confirm('Liberar todas as vagas?')){for(var id in estadoVagas){estadoVagas[id]='livre';var v=document.getElementById(id);if(v){v.classList.remove('ocupada');v.classList.add('livre');}}}}
// --- FUN√á√ïES DE PLANTA BAIXA E LAYOUT ---
function carregarPlantaBaixa(){if(tipoUsuario!=='admin')return;document.getElementById('planta-input').click();}
function processarPlantaBaixa(event){if(tipoUsuario!=='admin')return;var f=event.target.files[0];if(!f)return;if(f.size>10*1024*1024){mostrarNotificacao('‚ùå Arquivo muito grande','erro');return;}var r=new FileReader();r.onload=function(e){var img=e.target.result;document.getElementById('planta-baixa').style.backgroundImage='url('+img+')';plantaConfig={size:'cover',posX:50,posY:50,imagem:img};};r.readAsDataURL(f);event.target.value='';}
function exportarLayout(){if(tipoUsuario!=='admin')return;var d={timestamp:new Date().toISOString(),vagas:estadoVagas,posicoes:posicaoVagas,plantaBaixa:document.getElementById('planta-baixa').style.backgroundImage,plantaConfig:plantaConfig,totalVagas:totalVagas,proximoId:proximoIdVaga};var b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download='layout_'+new Date().toISOString().slice(0,16).replace('T','_')+'.json';a.click();URL.revokeObjectURL(u);}
function importarLayout(){if(tipoUsuario!=='admin')return;document.getElementById('import-input').click();}
function processarImportacao(event){if(tipoUsuario!=='admin')return;var f=event.target.files[0];if(!f)return;var r=new FileReader();r.onload=function(e){try{var d=JSON.parse(e.target.result);if(confirm('Importar layout?')){document.querySelectorAll('.vaga').forEach(function(v){v.remove();});if(d.vagas)estadoVagas=d.vagas;if(d.posicoes)posicaoVagas=d.posicoes;if(d.totalVagas)totalVagas=d.totalVagas;if(d.proximoId)proximoIdVaga=d.proximoId;if(d.plantaBaixa)document.getElementById('planta-baixa').style.backgroundImage=d.plantaBaixa;if(d.plantaConfig){plantaConfig=d.plantaConfig;var p=document.getElementById('planta-baixa');p.style.backgroundSize=plantaConfig.size;p.style.backgroundPosition=plantaConfig.posX+'% '+plantaConfig.posY+'%';}for(var id in posicaoVagas){var pos=posicaoVagas[id],v=criarVaga(id,pos.x,pos.y);if(pos.width)v.style.width=pos.width+'px';if(pos.height)v.style.height=pos.height+'px';if(pos.angle)v.style.transform='rotate('+pos.angle+'deg)';if(estadoVagas[id]){v.classList.remove('livre','ocupada');v.classList.add(estadoVagas[id]);}}}}catch(e){mostrarNotificacao('‚ùå Erro ao importar','erro');}};r.readAsText(f);event.target.value='';}
// --- FUN√á√ïES DE ZOOM MOBILE ---
function ajustarZoomMobile(i){zoomMobile=Math.max(0.4,Math.min(3,zoomMobile+i));aplicarZoomMobile();mostrarIndicadorZoom();}
function resetarZoomMobile(){zoomMobile=1;aplicarZoomMobile();mostrarIndicadorZoom();}
function aplicarZoomMobile(){if(isMobile){var c=document.getElementById('mapa-estacionamento');c.style.transform='scale('+zoomMobile+')';c.style.transformOrigin='center center';}}
function mostrarIndicadorZoom(){var ind=document.getElementById('zoom-indicator');ind.textContent='Zoom: '+Math.round(zoomMobile*100)+'%';ind.classList.add('show');setTimeout(function(){ind.classList.remove('show');},1200);}
function inicializarGestosTouch(){if(!isMobile)return;var c=document.getElementById('mapa-estacionamento');c.addEventListener('touchstart',function(e){if(e.touches.length===2){var t1=e.touches[0],t2=e.touches[1];touchStartDistance=Math.sqrt(Math.pow(t2.clientX-t1.clientX,2)+Math.pow(t2.clientY-t1.clientY,2));touchStartZoom=zoomMobile;e.preventDefault();}});c.addEventListener('touchmove',function(e){if(e.touches.length===2){var t1=e.touches[0],t2=e.touches[1],cd=Math.sqrt(Math.pow(t2.clientX-t1.clientX,2)+Math.pow(t2.clientY-t1.clientY,2)),s=cd/touchStartDistance;zoomMobile=Math.max(0.4,Math.min(3,touchStartZoom*s));aplicarZoomMobile();e.preventDefault();}});c.addEventListener('touchend',function(e){if(e.touches.length<2){mostrarIndicadorZoom();}});}
// --- FUN√á√ïES DE SINCRONIZA√á√ÉO E INICIALIZA√á√ÉO ---
function mostrarNotificacao(msg,tipo){var n=document.createElement('div');n.className='notificacao '+(tipo||'info');n.textContent=msg;document.body.appendChild(n);setTimeout(function(){n.classList.add('mostrar');},100);setTimeout(function(){n.classList.remove('mostrar');setTimeout(function(){if(n.parentNode)document.body.removeChild(n);},300);},2300);}
function atualizarEstatisticas(){var l=0,o=0;for(var id in estadoVagas){if(estadoVagas[id]==='livre')l++;else o++;}var t=totalVagas>0?Math.round((o/totalVagas)*100):0;document.getElementById('total-vagas').textContent=totalVagas;document.getElementById('vagas-livres').textContent=l;document.getElementById('vagas-ocupadas').textContent=o;document.getElementById('taxa-ocupacao').textContent=t+'%';document.getElementById('ultima-atualizacao').textContent=new Date().toLocaleTimeString();}
function carregarLocal(){var e=localStorage.getItem('estadoVagas'),p=localStorage.getItem('posicaoVagas'),t=localStorage.getItem('totalVagas'),n=localStorage.getItem('proximoIdVaga'),pl=localStorage.getItem('plantaConfig');if(e)estadoVagas=JSON.parse(e);if(p)posicaoVagas=JSON.parse(p);if(t)totalVagas=parseInt(t);if(n)proximoIdVaga=parseInt(n);if(pl){plantaConfig=JSON.parse(pl);var planta=document.getElementById('planta-baixa');if(plantaConfig.imagem)planta.style.backgroundImage='url('+plantaConfig.imagem+')';planta.style.backgroundSize=plantaConfig.size||'cover';planta.style.backgroundPosition=(plantaConfig.posX||50)+'% '+(plantaConfig.posY||50)+'%';}}
function salvarEstadoLocal(){localStorage.setItem('estadoVagas',JSON.stringify(estadoVagas));localStorage.setItem('posicaoVagas',JSON.stringify(posicaoVagas));localStorage.setItem('plantaConfig',JSON.stringify(plantaConfig));localStorage.setItem('totalVagas',totalVagas);localStorage.setItem('proximoIdVaga',proximoIdVaga);}
function inicializarVagas(){var posicoes=[{id:'V01',x:50,y:50},{id:'V02',x:100,y:50},{id:'V03',x:150,y:50},{id:'V04',x:200,y:50},{id:'V05',x:250,y:50},{id:'V06',x:300,y:50},{id:'V07',x:350,y:50},{id:'V08',x:400,y:50},{id:'V09',x:450,y:50},{id:'V10',x:500,y:50},{id:'V11',x:50,y:150},{id:'V12',x:100,y:150},{id:'V13',x:150,y:150},{id:'V14',x:200,y:150},{id:'V15',x:250,y:150},{id:'V16',x:300,y:150},{id:'V17',x:350,y:150},{id:'V18',x:400,y:150},{id:'V19',x:450,y:150},{id:'V20',x:500,y:150}];if(Object.keys(posicaoVagas).length>0){for(var id in posicaoVagas){var pos=posicaoVagas[id],v=criarVaga(id,pos.x,pos.y);if(pos.width)v.style.width=pos.width+'px';if(pos.height)v.style.height=pos.height+'px';if(pos.angle)v.style.transform='rotate('+pos.angle+'deg)';if(estadoVagas[id]){v.classList.remove('livre','ocupada');v.classList.add(estadoVagas[id]);}}}else{posicoes.forEach(function(pos){criarVaga(pos.id,pos.x,pos.y);});}atualizarEstatisticas();aplicarModoVisualizacao();}
function inicializarFirebase(){try{firebase.initializeApp(firebaseConfig);database=firebase.database();firebaseConectado=true;document.getElementById('status-firebase').className='status-firebase conectado';document.getElementById('texto-firebase').textContent='Firebase Conectado';}catch(e){firebaseConectado=false;document.getElementById('status-firebase').className='status-firebase desconectado';document.getElementById('texto-firebase').textContent='Firebase Desconectado';}}
// --- INICIALIZA√á√ÉO ---
document.addEventListener('DOMContentLoaded',function(){
  carregarLocal();
  inicializarVagas();
  inicializarFirebase();
  document.addEventListener('mousemove',arrastar);
  document.addEventListener('mouseup',finalizarArraste);
  if(isMobile){document.getElementById('mobile-zoom-controls').style.display='flex';aplicarZoomMobile();inicializarGestosTouch();}
  document.getElementById('mapa-estacionamento').addEventListener('click',function(){if(vagaSelecionada&&modoEdicao&&tipoUsuario==='admin'){vagaSelecionada.classList.remove('selecionada');vagaSelecionada=null;document.getElementById('edit-controls').style.display='none';}});
});
function toggleEditMode(){if(tipoUsuario!=='admin')return;modoEdicao=!modoEdicao;var c=document.getElementById('mapa-estacionamento'),btn=document.getElementById('btn-edit-mode');if(modoEdicao){c.classList.add('modo-edicao');btn.classList.add('active');btn.textContent='‚úÖ Finalizar';mostrarNotificacao('‚úèÔ∏è Modo edi√ß√£o ativado','info');}else{c.classList.remove('modo-edicao');btn.classList.remove('active');btn.textContent='‚úèÔ∏è Edi√ß√£o';document.getElementById('edit-controls').style.display='none';if(vagaSelecionada){vagaSelecionada.classList.remove('selecionada');vagaSelecionada=null;}}}
</script>
</body>
</html>
