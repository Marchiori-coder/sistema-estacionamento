<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Estacionamento</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--p:clamp(10px,2vw,30px);--f:clamp(0.8rem,1.5vw,1rem);--r:clamp(8px,1vw,15px)}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:var(--p);font-size:var(--f)}
        .modal-login{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;z-index:10000}
        .modal-login.show{display:flex!important}
        .login-box{background:white;padding:30px;border-radius:var(--r);text-align:center;max-width:400px;width:90%}
        .login-input{width:100%;padding:12px;margin:8px 0;border:2px solid #ecf0f1;border-radius:8px;font-size:var(--f)}
        .login-btn{width:100%;padding:12px;background:#3498db;color:white;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
        .close-modal{position:absolute;top:15px;right:20px;background:none;border:none;font-size:2rem;cursor:pointer;color:#7f8c8d}
        .container{max-width:min(1600px,95vw);margin:0 auto;background:white;border-radius:var(--r);box-shadow:0 10px 30px rgba(0,0,0,0.2);overflow:hidden}
        .header{background:linear-gradient(135deg,#2c3e50,#3498db);color:white;padding:var(--p);text-align:center;position:relative;padding-top:clamp(60px,8vw,100px)}
        .header h1{font-size:clamp(1.5rem,4vw,2.5rem);margin-bottom:10px}
        .user-info{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.25);padding:10px 20px;border-radius:25px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .user-badge{background:#27ae60;color:white;padding:6px 12px;border-radius:15px;font-size:0.8rem;font-weight:bold}
        .user-badge.admin{background:#f39c12}
        .admin-login-btn,.logout-btn{background:#3498db;color:white;border:none;padding:8px 15px;border-radius:15px;cursor:pointer;font-size:0.8rem;font-weight:bold}
        .logout-btn{background:#e74c3c}
        .status-firebase{position:fixed;top:var(--p);left:var(--p);padding:10px 15px;border-radius:20px;color:white;font-weight:bold;z-index:1000;display:flex;align-items:center;gap:8px;font-size:0.8rem}
        .status-firebase.conectado{background:#27ae60}
        .status-firebase.desconectado{background:#e74c3c}
        .indicador-firebase{width:10px;height:10px;border-radius:50%;background:white;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .admin-panel{background:linear-gradient(135deg,#f39c12,#e67e22);color:white;padding:20px;text-align:center;display:none}
        .admin-panel.show{display:block!important}
        .admin-controls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
        .admin-btn{padding:10px 15px;background:rgba(255,255,255,0.2);color:white;border:2px solid white;border-radius:20px;cursor:pointer;font-weight:bold;font-size:0.8rem}
        .admin-btn:hover,.admin-btn.active{background:white;color:#f39c12}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:15px;margin-top:20px}
        .stat-box{background:rgba(255,255,255,0.2);padding:15px;border-radius:10px;text-align:center}
        .stat-number{font-size:clamp(1.2rem,3vw,1.8rem);font-weight:bold;display:block}
        .estacionamento-wrapper{padding:var(--p);background:#f8f9fa;min-height:70vh;position:relative}
        .estacionamento-container{position:relative;width:100%;max-width:1600px;height:clamp(800px,90vh,1600px);margin:0 auto;background:#e8e8e8;border-radius:var(--r);border:3px solid #34495e;overflow:auto;transform-origin:top left;transition:transform 0.3s;-webkit-overflow-scrolling:touch}
        .planta-baixa{position:absolute;top:0;left:0;width:100%;height:100%;background-size:cover;background-repeat:no-repeat;background-position:center;opacity:0.8;z-index:1;transform-origin:center;transition:all 0.3s}
        .planta-baixa.ajustavel{border:2px dashed #3498db;opacity:0.9}
        .zoom-controls,.planta-controls{position:absolute;background:rgba(255,255,255,0.95);padding:15px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,0.2);z-index:150;display:none;cursor:move;user-select:none}
        .zoom-controls{top:20px;left:20px}
        .planta-controls{top:20px;right:20px}
        .zoom-controls.dragging,.planta-controls.dragging{z-index:200;box-shadow:0 8px 25px rgba(0,0,0,0.4);transform:scale(1.05)}
        .zoom-controls h4,.planta-controls h4{color:#34495e;margin-bottom:10px;font-size:0.8rem;cursor:move;padding:5px;background:rgba(52,73,94,0.1);border-radius:5px;text-align:center}
        .zoom-btn,.planta-btn{padding:8px 12px;margin:2px;color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
        .zoom-btn{background:#3498db}
        .planta-btn{background:#e67e22;display:block;width:100%;margin-bottom:5px}
        .vaga{position:absolute;width:clamp(25px,4vw,45px);height:clamp(40px,6vw,75px);border:2px solid #2c3e50;background:rgba(39,174,96,0.9);display:flex!important;justify-content:center;align-items:center;font-size:clamp(6px,1.2vw,10px);font-weight:bold;color:white;border-radius:4px;cursor:pointer;transition:all 0.3s;z-index:10;user-select:none}
        .vaga:hover{transform:scale(1.1);z-index:100}
        .vaga.viewer-mode{cursor:default!important}
        .vaga.viewer-mode:hover{transform:none!important}
        .livre{background:rgba(39,174,96,0.9)!important}
        .ocupada{background:rgba(231,76,60,0.9)!important}
        .modo-edicao .vaga{cursor:move!important;border:3px dashed #f39c12!important;background:rgba(243,156,18,0.8)!important}
        .vaga.selecionada{border:4px solid #9b59b6!important;background:rgba(155,89,182,0.9)!important;z-index:1000!important}
        .vaga.multipla-selecionada{border:4px solid #e67e22!important;background:rgba(230,126,34,0.9)!important;z-index:999!important}
        .vaga.arrastando{z-index:1001!important;transform:scale(1.2)!important;opacity:0.8;box-shadow:0 8px 20px rgba(0,0,0,0.3)}
        .edit-controls{position:fixed;top:50%;right:20px;transform:translateY(-50%);background:white;padding:20px;border-radius:15px;box-shadow:0 15px 40px rgba(0,0,0,0.3);display:none;z-index:1000;min-width:280px;max-height:85vh;overflow-y:auto}
        .edit-controls.show{display:block!important}
        .edit-section{margin-bottom:20px}
        .edit-section h4{color:#34495e;margin-bottom:10px;font-size:0.8rem}
        .edit-btn{width:100%;padding:10px;margin:5px 0;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.8rem}
        .edit-btn.rotate{background:#3498db;color:white}
        .edit-btn.resize{background:#e67e22;color:white}
        .edit-btn.action{background:#9b59b6;color:white}
        .edit-btn.delete{background:#e74c3c;color:white}
        .edit-btn.multi{background:#27ae60;color:white}
        .size-controls{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .size-btn{padding:8px;background:#95a5a6;color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.8rem}
        .position-controls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
        .position-btn{padding:6px;background:#2c3e50;color:white;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem}
        .controles{padding:30px;background:#ecf0f1;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;justify-items:center}
        .btn{padding:12px 20px;border:none;border-radius:20px;cursor:pointer;font-weight:bold;font-size:0.8rem;transition:all 0.3s;min-width:120px}
        .btn:hover{transform:translateY(-2px)}
        .btn:disabled{opacity:0.3;cursor:not-allowed}
        .btn-reset{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:white}
        .btn-ocupar{background:linear-gradient(135deg,#e74c3c,#c0392b);color:white}
        .btn-liberar{background:linear-gradient(135deg,#27ae60,#2ecc71);color:white}
        .btn-salvar{background:linear-gradient(135deg,#3498db,#2980b9);color:white}
        .btn-firebase{background:linear-gradient(135deg,#ff9800,#f57c00);color:white}
        .notificacao{position:fixed;bottom:20px;right:20px;background:#2c3e50;color:white;padding:15px 20px;border-radius:10px;z-index:1000;max-width:min(350px,90vw);transform:translateX(400px);transition:transform 0.3s}
        .notificacao.mostrar{transform:translateX(0)}
        .notificacao.sucesso{background:#27ae60}
        .notificacao.erro{background:#e74c3c}
        .notificacao.info{background:#3498db}
        
        @media (max-width:768px){
            .user-info{position:static;margin-bottom:15px;justify-content:center}
            .header{padding-top:20px}
            .status-firebase{position:relative;margin-bottom:10px;align-self:flex-start}
            .edit-controls{position:fixed;top:0;right:0;left:0;bottom:0;transform:none;max-height:100vh;border-radius:0}
            .estacionamento-container{height:clamp(400px,60vh,600px);overflow:auto;-webkit-overflow-scrolling:touch;min-width:800px; transform-origin: top left;}
            .estacionamento-wrapper{overflow-x:auto;-webkit-overflow-scrolling:touch;padding:10px}
            .zoom-controls,.planta-controls{display:none!important}
            .controles{grid-template-columns:repeat(2,1fr);gap:10px;padding:15px}
            .vaga{width:clamp(30px,8vw,50px);height:clamp(50px,10vw,80px);font-size:clamp(8px,2vw,12px)}
            .admin-panel{padding:10px}
            .admin-controls{gap:5px}
            .admin-btn{padding:8px 12px;font-size:0.7rem}
        }
        
        @media (max-width:480px){
            .estacionamento-container{height:clamp(350px,50vh,500px);min-width:1000px}
            .vaga{width:clamp(35px,10vw,55px);height:clamp(55px,12vw,85px);font-size:clamp(9px,2.5vw,14px)}
            .controles{grid-template-columns:1fr;gap:8px;padding:10px}
            .btn{min-width:100px;padding:10px 15px;font-size:0.7rem}
            .header h1{font-size:clamp(1.2rem,5vw,1.8rem)}
            .stats{grid-template-columns:repeat(2,1fr);gap:10px}
            .stat-box{padding:10px}
            .stat-number{font-size:clamp(1rem,4vw,1.4rem)}
        }
    </style>
</head>
<body>
    <div class="modal-login" id="modal-login">
        <div class="login-box">
            <button class="close-modal" onclick="fecharModalLogin()">×</button>
            <h2>🔐 Login Administrador</h2>
            <input type="text" class="login-input" id="username" placeholder="Usuário">
            <input type="password" class="login-input" id="password" placeholder="Senha">
            <button class="login-btn" onclick="fazerLoginAdmin()">Entrar como Admin</button>
        </div>
    </div>

    <div class="status-firebase" id="status-firebase">
        <div class="indicador-firebase"></div>
        <span id="texto-firebase">Sistema Inicializado</span>
    </div>

    <div class="container">
        <div class="header">
            <div class="user-info">
                <span id="user-name">Visualizador Público</span>
                <span class="user-badge" id="user-badge">VIEWER</span>
                <button class="admin-login-btn" id="admin-login-btn" onclick="mostrarModalLogin()">Login Admin</button>
                <button class="logout-btn" id="logout-btn" onclick="logout()" style="display:none;">Sair</button>
            </div>
            
            <h1>🚗 SMAMUS - Sistema de Estacionamento</h1>
            <p><strong>Última atualização:</strong> <span id="ultima-atualizacao">Agora</span></p>
            
            <div class="stats">
                <div class="stat-box"><span class="stat-number" id="total-vagas">62</span><span>Total</span></div>
                <div class="stat-box"><span class="stat-number" id="vagas-livres">62</span><span>Livres</span></div>
                <div class="stat-box"><span class="stat-number" id="vagas-ocupadas">0</span><span>Ocupadas</span></div>
                <div class="stat-box"><span class="stat-number" id="taxa-ocupacao">0%</span><span>Ocupação</span></div>
            </div>
        </div>

        <div class="admin-panel" id="admin-panel">
            <h3>🔧 Painel de Administração</h3>
            <div class="admin-controls">
                <button class="admin-btn" id="btn-edit-mode" onclick="toggleEditMode()">✏️ Edição</button>
                <button class="admin-btn" onclick="adicionarNovaVaga()">➕ Nova Vaga</button>
                <button class="admin-btn" onclick="carregarPlantaBaixa()">🖼️ Planta</button>
                <button class="admin-btn" id="btn-edit-planta" onclick="toggleEditPlanta()">📐 Ajustar Planta</button>
                <button class="admin-btn" onclick="exportarLayout()">📤 Exportar</button>
                <button class="admin-btn" onclick="importarLayout()">📥 Importar</button>
                <button class="admin-btn" id="btn-multi-select" onclick="toggleSelecaoMultipla()">🔲 Multi</button>
            </div>
        </div>

        <div class="estacionamento-wrapper">
            <div class="zoom-controls" id="zoom-controls">
                <h4>🔍 Zoom - Arraste para mover</h4>
                <div>
                    <button class="zoom-btn" onclick="ajustarZoom('container',0.1)">🔍+</button>
                    <button class="zoom-btn" onclick="ajustarZoom('container',-0.1)">🔍-</button>
                    <button class="zoom-btn" onclick="resetarZoom('container')">⟲</button>
                </div>
                <div style="margin-top:8px;">
                    <button class="zoom-btn" onclick="ajustarZoom('planta',0.1)">🖼️+</button>
                    <button class="zoom-btn" onclick="ajustarZoom('planta',-0.1)">🖼️-</button>
                    <button class="zoom-btn" onclick="resetarZoom('planta')">⟲🖼️</button>
                </div>
                <div style="font-size:0.8em;color:#7f8c8d;margin-top:5px;text-align:center;">
                    Container: <span id="zoom-container">100%</span><br>
                    Planta: <span id="zoom-planta">100%</span>
                </div>
            </div>

            <div class="planta-controls" id="planta-controls">
                <h4>📐 Planta Baixa - Arraste para mover</h4>
                <button class="planta-btn" onclick="ajustarPlanta('cover')">📏 Cobrir Área</button>
                <button class="planta-btn" onclick="ajustarPlanta('contain')">📐 Ajustar</button>
                <button class="planta-btn" onclick="ajustarPlanta('fill')">🔄 Preencher</button>
                <button class="planta-btn" onclick="centralizarPlanta()">⌖ Centralizar</button>
                <button class="planta-btn" onclick="resetarPlanta()">⟲ Reset</button>
            </div>

            <div class="estacionamento-container" id="mapa-estacionamento">
                <div class="planta-baixa" id="planta-baixa"></div>
            </div>
        </div>

        <div class="edit-controls" id="edit-controls">
            <div style="text-align:center;margin-bottom:15px;color:#2c3e50;font-weight:bold;">
                🔧 Editando: <span id="vaga-selecionada">-</span>
            </div>
            
            <div id="multi-selection-info" style="display:none;background:#e67e22;color:white;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;">
                <span id="multi-count">0</span> vagas selecionadas
            </div>

            <div class="edit-section" id="multi-actions" style="display:none;">
                <h4>🔲 Ações em Lote</h4>
                <button class="edit-btn multi" onclick="aplicarRotacaoMultipla(-90)">↶ -90°</button>
                <button class="edit-btn multi" onclick="aplicarRotacaoMultipla(90)">↷ +90°</button>
                <button class="edit-btn multi" onclick="redimensionarMultiplas('width',5)">📏 Largura +</button>
                <button class="edit-btn multi" onclick="redimensionarMultiplas('height',5)">📏 Altura +</button>
                <button class="edit-btn multi" onclick="alinharVagasMultiplas('horizontal')">↔️ Alinhar H</button>
                <button class="edit-btn multi" onclick="alinharVagasMultiplas('vertical')">↕️ Alinhar V</button>
                <button class="edit-btn delete" onclick="excluirVagasMultiplas()">🗑️ Excluir</button>
                <button class="edit-btn action" onclick="limparSelecaoMultipla()">❌ Limpar</button>
            </div>
            
            <div class="edit-section">
                <h4>📍 Posição (Use também as setas do teclado)</h4>
                <div class="position-controls">
                    <button class="position-btn" onclick="moverVaga(-10,-10)">↖</button>
                    <button class="position-btn" onclick="moverVaga(0,-10)">↑</button>
                    <button class="position-btn" onclick="moverVaga(10,-10)">↗</button>
                    <button class="position-btn" onclick="moverVaga(-10,0)">←</button>
                    <button class="position-btn" onclick="centralizarVaga()">⌖</button>
                    <button class="position-btn" onclick="moverVaga(10,0)">→</button>
                    <button class="position-btn" onclick="moverVaga(-10,10)">↙</button>
                    <button class="position-btn" onclick="moverVaga(0,10)">↓</button>
                    <button class="position-btn" onclick="moverVaga(10,10)">↘</button>
                </div>
            </div>
            
            <div class="edit-section">
                <h4>🔄 Rotação (Use 'R' e 'Shift+R')</h4>
                <button class="edit-btn rotate" onclick="rotacionarVaga(-90)">↶ -90°</button>
                <button class="edit-btn rotate" onclick="rotacionarVaga(90)">↷ +90°</button>
                <button class="edit-btn rotate" onclick="resetarRotacao()">⟲ Reset</button>
            </div>
            
            <div class="edit-section">
                <h4>📏 Tamanho (Use +/- e Ctrl +/-)</h4>
                <div class="size-controls">
                    <button class="size-btn" onclick="redimensionarVaga('width',-5)">Largura -</button>
                    <button class="size-btn" onclick="redimensionarVaga('width',5)">Largura +</button>
                    <button class="size-btn" onclick="redimensionarVaga('height',-5)">Altura -</button>
                    <button class="size-btn" onclick="redimensionarVaga('height',5)">Altura +</button>
                </div>
                <button class="edit-btn resize" onclick="resetarTamanho()">📏 Padrão</button>
            </div>
            
            <div class="edit-section">
                <h4>🎨 Ações (Use 'Delete' e 'Esc')</h4>
                <button class="edit-btn action" onclick="duplicarVaga()">📋 Duplicar</button>
                <button class="edit-btn action" onclick="renomearVaga()">✏️ Renomear</button>
                <button class="edit-btn delete" onclick="excluirVaga()">🗑️ Excluir</button>
            </div>
        </div>

        <div class="controles">
            <button class="btn btn-reset" onclick="resetarTodasVagas()" id="btn-reset" disabled>🔄 Resetar</button>
            <button class="btn btn-ocupar" onclick="ocuparTodasVagas()" id="btn-ocupar" disabled>🚗 Ocupar</button>
            <button class="btn btn-liberar" onclick="liberarTodasVagas()" id="btn-liberar" disabled>✅ Liberar</button>
            <button class="btn btn-salvar" onclick="salvarEstadoLocal()">💾 Salvar</button>
            <button class="btn btn-firebase" onclick="salvarNoFirebase()">🌐 Firebase</button>
        </div>
    </div>

    <input type="file" id="import-input" accept=".json" style="display:none;" onchange="processarImportacao(event)">
    <input type="file" id="planta-input" accept="image/*" style="display:none;" onchange="processarPlantaBaixa(event)">

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyCRIgCndKlfXxR7NNnq_qGupgAWyLqzYzc",
            authDomain: "teste-dbacd.firebaseapp.com",
            databaseURL: "https://teste-dbacd-default-rtdb.firebaseio.com/",
            projectId: "teste-dbacd",
            storageBucket: "teste-dbacd.firebasestorage.app",
            messagingSenderId: "381642195685",
            appId: "1:381642195685:web:746eb4df7667813b0e4a0c"
        };

        var estadoVagas = {};
        var posicaoVagas = {};
        var firebaseConectado = false;
        var database = null;
        var totalVagas = 62;
        var usuarioAtual = 'viewer';
        var tipoUsuario = 'viewer';
        var modoEdicao = false;
        var proximoIdVaga = 63;
        var vagaSelecionada = null;
        var vagaArrastando = null;
        var zoomContainer = 1;
        var zoomPlanta = 1;
        var selecaoMultipla = false;
        var vagasMultiplasSelecao = [];
        var editandoPlanta = false;
        var plantaConfig = {size: 'cover', posX: 50, posY: 50};
        var painelArrastando = null;
        var offsetPainelX = 0;
        var offsetPainelY = 0;

        var isArrastandoMultiplos = false;
        var posicoesIniciaisArrastar = [];
        var pontoInicialMouse = { x: 0, y: 0 };
        
        function mostrarModalLogin() { document.getElementById('modal-login').classList.add('show'); }
        function fecharModalLogin() { document.getElementById('modal-login').classList.remove('show'); }
        
        function fazerLoginAdmin() {
            var u = document.getElementById('username').value.trim();
            var p = document.getElementById('password').value.trim();
            if (u === 'admin' && p === 'admin123') {
                usuarioAtual = 'admin';
                tipoUsuario = 'admin';
                fecharModalLogin();
                document.getElementById('user-name').textContent = 'Administrador';
                document.getElementById('user-badge').textContent = 'ADMIN';
                document.getElementById('user-badge').className = 'user-badge admin';
                document.getElementById('admin-login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'inline-block';
                document.getElementById('admin-panel').classList.add('show');
                habilitarControlesAdmin();
                aplicarModoVisualizacao();
                mostrarNotificacao('🔧 Login realizado!', 'sucesso');
            } else {
                mostrarNotificacao('❌ Credenciais inválidas', 'erro');
            }
        }

        function logout() {
            if (confirm('Sair do modo administrador?')) {
                usuarioAtual = 'viewer';
                tipoUsuario = 'viewer';
                modoEdicao = false;
                selecaoMultipla = false;
                editandoPlanta = false;
                document.getElementById('user-name').textContent = 'Visualizador Público';
                document.getElementById('user-badge').textContent = 'VIEWER';
                document.getElementById('user-badge').className = 'user-badge';
                document.getElementById('admin-login-btn').style.display = 'inline-block';
                document.getElementById('logout-btn').style.display = 'none';
                document.getElementById('admin-panel').classList.remove('show');
                document.getElementById('edit-controls').style.display = 'none';
                document.getElementById('zoom-controls').style.display = 'none';
                document.getElementById('planta-controls').style.display = 'none';
                document.getElementById('mapa-estacionamento').classList.remove('modo-edicao');
                document.getElementById('planta-baixa').classList.remove('ajustavel');
                limparSelecaoMultipla();
                desabilitarControlesAdmin();
                aplicarModoVisualizacao();
                mostrarNotificacao('👋 Logout realizado', 'info');
            }
        }

        function aplicarModoVisualizacao() {
            document.querySelectorAll('.vaga').forEach(vaga => {
                if (tipoUsuario === 'viewer') {
                    vaga.classList.add('viewer-mode');
                    vaga.style.cursor = 'default';
                } else {
                    vaga.classList.remove('viewer-mode');
                    vaga.style.cursor = modoEdicao ? 'move' : 'pointer';
                }
            });
        }

        function habilitarControlesAdmin() {
            ['btn-reset', 'btn-ocupar', 'btn-liberar'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
        }

        function desabilitarControlesAdmin() {
            ['btn-reset', 'btn-ocupar', 'btn-liberar'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = true;
            });
        }
        
        function toggleEditPlanta() {
            if (tipoUsuario !== 'admin') return;
            editandoPlanta = !editandoPlanta;
            var btn = document.getElementById('btn-edit-planta');
            var planta = document.getElementById('planta-baixa');
            if (editandoPlanta) {
                btn.classList.add('active');
                planta.classList.add('ajustavel');
                mostrarNotificacao('📐 Modo ajuste de planta ativado', 'info');
            } else {
                btn.classList.remove('active');
                planta.classList.remove('ajustavel');
                mostrarNotificacao('✅ Ajuste de planta finalizado', 'info');
                salvarLocal();
                sincronizarLayoutCompleto();
            }
        }
        
        function ajustarZoom(tipo, incremento) {
            if (tipoUsuario !== 'admin') return;
            var container = document.getElementById('mapa-estacionamento');
            var planta = document.getElementById('planta-baixa');
            if (tipo === 'container') {
                zoomContainer = Math.max(0.3, Math.min(3, zoomContainer + incremento));
                container.style.transform = `scale(${zoomContainer})`;
                document.getElementById('zoom-container').textContent = `${Math.round(zoomContainer * 100)}%`;
            } else if (tipo === 'planta') {
                zoomPlanta = Math.max(0.3, Math.min(3, zoomPlanta + incremento));
                planta.style.transform = `scale(${zoomPlanta})`;
                document.getElementById('zoom-planta').textContent = `${Math.round(zoomPlanta * 100)}%`;
            }
        }

        function resetarZoom(tipo) {
            if (tipoUsuario !== 'admin') return;
            if (tipo === 'container') {
                zoomContainer = 1;
                document.getElementById('mapa-estacionamento').style.transform = 'scale(1)';
                document.getElementById('zoom-container').textContent = '100%';
            } else if (tipo === 'planta') {
                zoomPlanta = 1;
                document.getElementById('planta-baixa').style.transform = 'scale(1)';
                document.getElementById('zoom-planta').textContent = '100%';
            }
        }
        
        function toggleEditMode() {
            if (tipoUsuario !== 'admin') return;
            modoEdicao = !modoEdicao;
            var container = document.getElementById('mapa-estacionamento');
            var btn = document.getElementById('btn-edit-mode');
            if (modoEdicao) {
                container.classList.add('modo-edicao');
                btn.classList.add('active');
                btn.textContent = '✅ Finalizar';
                if (window.innerWidth > 768) {
                    document.getElementById('zoom-controls').style.display = 'block';
                    document.getElementById('planta-controls').style.display = 'block';
                }
                mostrarNotificacao('✏️ Modo edição ativado! Use o teclado para ajustes finos.', 'info');
            } else {
                container.classList.remove('modo-edicao');
                btn.classList.remove('active');
                btn.textContent = '✏️ Edição';
                document.getElementById('edit-controls').style.display = 'none';
                document.getElementById('zoom-controls').style.display = 'none';
                document.getElementById('planta-controls').style.display = 'none';
                if (vagaSelecionada) {
                    vagaSelecionada.classList.remove('selecionada');
                    vagaSelecionada = null;
                }
                limparSelecaoMultipla();
                salvarLocal();
                sincronizarLayoutCompleto();
                mostrarNotificacao('✅ Modo edição finalizado', 'info');
            }
            aplicarModoVisualizacao();
        }

        function toggleSelecaoMultipla() {
            if (tipoUsuario !== 'admin') return;
            selecaoMultipla = !selecaoMultipla;
            var btn = document.getElementById('btn-multi-select');
            if (selecaoMultipla) {
                btn.classList.add('active');
                btn.textContent = '✅ Multi';
            } else {
                btn.classList.remove('active');
                btn.textContent = '🔲 Multi';
                limparSelecaoMultipla();
            }
        }

        function limparSelecaoMultipla() {
            vagasMultiplasSelecao.forEach(vaga => vaga.classList.remove('multipla-selecionada'));
            vagasMultiplasSelecao = [];
            atualizarInterfaceSelecaoMultipla();
        }

        function adicionarVagaSelecaoMultipla(vaga) {
            if (!selecaoMultipla || tipoUsuario !== 'admin') return;
            const index = vagasMultiplasSelecao.indexOf(vaga);
            if (index > -1) {
                vagasMultiplasSelecao.splice(index, 1);
                vaga.classList.remove('multipla-selecionada');
            } else {
                vagasMultiplasSelecao.push(vaga);
                vaga.classList.add('multipla-selecionada');
            }
            atualizarInterfaceSelecaoMultipla();
        }
        
        function atualizarInterfaceSelecaoMultipla() {
            const count = vagasMultiplasSelecao.length;
            const multiInfo = document.getElementById('multi-selection-info');
            const multiActions = document.getElementById('multi-actions');
            if (count > 0) {
                multiInfo.style.display = 'block';
                multiActions.style.display = 'block';
                document.getElementById('multi-count').textContent = count;
                document.getElementById('edit-controls').classList.add('show');
            } else {
                multiInfo.style.display = 'none';
                multiActions.style.display = 'none';
                if (!vagaSelecionada) {
                    document.getElementById('edit-controls').classList.remove('show');
                }
            }
        }

        function aplicarRotacaoMultipla(graus) {
            if (vagasMultiplasSelecao.length === 0 || tipoUsuario !== 'admin') return;
            vagasMultiplasSelecao.forEach(vaga => rotacionarVagaIndividual(vaga, graus));
            sincronizarLayoutCompleto();
        }

        function redimensionarMultiplas(dimensao, valor) {
            if (vagasMultiplasSelecao.length === 0 || tipoUsuario !== 'admin') return;
            vagasMultiplasSelecao.forEach(vaga => redimensionarVagaIndividual(vaga, dimensao, valor));
            sincronizarLayoutCompleto();
        }

        function alinharVagasMultiplas(tipo) {
            if (vagasMultiplasSelecao.length < 2 || tipoUsuario !== 'admin') return;
            const referencia = vagasMultiplasSelecao[0];
            const refPos = posicaoVagas[referencia.id];
            vagasMultiplasSelecao.slice(1).forEach(vaga => {
                const vagaId = vaga.id;
                if (tipo === 'horizontal') {
                    posicaoVagas[vagaId].y = refPos.y;
                    vaga.style.top = `${refPos.y}px`;
                } else {
                    posicaoVagas[vagaId].x = refPos.x;
                    vaga.style.left = `${refPos.x}px`;
                }
            });
            sincronizarLayoutCompleto();
        }

        function excluirVagasMultiplas() {
            if (vagasMultiplasSelecao.length === 0 || tipoUsuario !== 'admin') return;
            if (confirm(`Excluir ${vagasMultiplasSelecao.length} vagas?`)) {
                excluirVagasSelecionadas();
            }
        }

        function selecionarVaga(vaga) {
            if (!modoEdicao || tipoUsuario !== 'admin') return;
            if (selecaoMultipla) {
                adicionarVagaSelecaoMultipla(vaga);
                return;
            }
            if (vagaSelecionada) vagaSelecionada.classList.remove('selecionada');
            vagaSelecionada = vaga;
            vaga.classList.add('selecionada');
            document.getElementById('edit-controls').classList.add('show');
            document.getElementById('vaga-selecionada').textContent = vaga.id;
        }

        function moverVaga(deltaX, deltaY) {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            moverVagaIndividual(vagaSelecionada, deltaX, deltaY);
        }

        function rotacionarVaga(graus) {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            rotacionarVagaIndividual(vagaSelecionada, graus);
        }
        
        function redimensionarVaga(dimensao, valor) {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            redimensionarVagaIndividual(vagaSelecionada, dimensao, valor);
        }

        function excluirVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            if (confirm(`Excluir vaga ${vagaSelecionada.id}?`)) {
                excluirVagasSelecionadas();
            }
        }
        
        function iniciarArraste(e) {
            if (!modoEdicao || tipoUsuario !== 'admin') return;
            const vagaClicada = e.target.closest('.vaga');
            if (!vagaClicada) return;

            e.preventDefault();
            e.stopPropagation();

            if (selecaoMultipla && (e.ctrlKey || e.metaKey)) {
                adicionarVagaSelecaoMultipla(vagaClicada);
                return;
            }

            if (selecaoMultipla && vagaClicada.classList.contains('multipla-selecionada')) {
                isArrastandoMultiplos = true;
                vagaArrastando = vagaClicada;
                posicoesIniciaisArrastar = vagasMultiplasSelecao.map(v => ({
                    el: v, x: posicaoVagas[v.id].x, y: posicaoVagas[v.id].y
                }));
            } else {
                isArrastandoMultiplos = false;
                limparSelecaoMultipla();
                selecionarVaga(vagaClicada);
                vagaArrastando = vagaClicada;
                posicoesIniciaisArrastar = [{ el: vagaArrastando, x: posicaoVagas[vagaArrastando.id].x, y: posicaoVagas[vagaArrastando.id].y }];
            }

            const containerRect = document.getElementById('mapa-estacionamento').getBoundingClientRect();
            pontoInicialMouse.x = (e.clientX - containerRect.left) / zoomContainer;
            pontoInicialMouse.y = (e.clientY - containerRect.top) / zoomContainer;

            (isArrastandoMultiplos ? vagasMultiplasSelecao : [vagaArrastando]).forEach(v => {
                v.classList.add('arrastando');
                v.style.pointerEvents = 'none';
            });
            document.body.style.cursor = 'move';
        }

        function arrastar(e) {
            if (painelArrastando) { arrastarPainel(e); return; }
            if (!vagaArrastando) return;

            var container = document.getElementById('mapa-estacionamento');
            var containerRect = container.getBoundingClientRect();
            const mouseX = (e.clientX - containerRect.left) / zoomContainer;
            const mouseY = (e.clientY - containerRect.top) / zoomContainer;
            const deltaX = mouseX - pontoInicialMouse.x;
            const deltaY = mouseY - pontoInicialMouse.y;

            posicoesIniciaisArrastar.forEach(posInicial => {
                const vagaEl = posInicial.el;
                let novoX = posInicial.x + deltaX;
                let novoY = posInicial.y + deltaY;

                novoX = Math.max(0, Math.min(novoX, container.offsetWidth - vagaEl.offsetWidth));
                novoY = Math.max(0, Math.min(novoY, container.offsetHeight - vagaEl.offsetHeight));

                vagaEl.style.left = `${novoX}px`;
                vagaEl.style.top = `${novoY}px`;
                posicaoVagas[vagaEl.id].x = novoX;
                posicaoVagas[vagaEl.id].y = novoY;
            });
        }

        function finalizarArraste() {
            if (vagaArrastando) {
                const alvos = isArrastandoMultiplos ? vagasMultiplasSelecao : [vagaArrastando];
                alvos.forEach(v => {
                    v.classList.remove('arrastando');
                    v.style.pointerEvents = 'auto';
                });
                document.body.style.cursor = 'default';
                vagaArrastando = null;
                isArrastandoMultiplos = false;
                posicoesIniciaisArrastar = [];
                salvarLocal();
                sincronizarLayoutCompleto();
            }
            if (painelArrastando) finalizarArrastePainel();
        }

        function lidarComTeclado(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            const alvos = vagasMultiplasSelecao.length > 0 ? vagasMultiplasSelecao : (vagaSelecionada ? [vagaSelecionada] : []);
            if (!modoEdicao || alvos.length === 0) return;

            const teclasInterceptadas = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Delete', 'Escape', '+', '-'];
            if (teclasInterceptadas.includes(e.key) || e.key.toLowerCase() === 'r') {
                e.preventDefault();
            } else {
                return;
            }
            
            const passo = e.shiftKey ? 10 : 1;
            let acaoRealizada = true;

            switch (e.key) {
                case 'ArrowUp': alvos.forEach(v => moverVagaIndividual(v, 0, -passo)); break;
                case 'ArrowDown': alvos.forEach(v => moverVagaIndividual(v, 0, passo)); break;
                case 'ArrowLeft': alvos.forEach(v => moverVagaIndividual(v, -passo, 0)); break;
                case 'ArrowRight': alvos.forEach(v => moverVagaIndividual(v, passo, 0)); break;
                case 'r': case 'R':
                    const graus = e.shiftKey ? -90 : 90;
                    alvos.forEach(v => rotacionarVagaIndividual(v, graus));
                    break;
                case '+':
                    const dimAumento = e.ctrlKey ? 'height' : 'width';
                    alvos.forEach(v => redimensionarVagaIndividual(v, dimAumento, passo));
                    break;
                case '-':
                    const dimReducao = e.ctrlKey ? 'height' : 'width';
                    alvos.forEach(v => redimensionarVagaIndividual(v, dimReducao, -passo));
                    break;
                case 'Delete':
                    if (confirm(`Excluir ${alvos.length} vaga(s) selecionada(s)?`)) {
                        excluirVagasSelecionadas();
                    }
                    break;
                case 'Escape':
                    limparSelecaoMultipla();
                    if (vagaSelecionada) {
                        vagaSelecionada.classList.remove('selecionada');
                        vagaSelecionada = null;
                    }
                    document.getElementById('edit-controls').classList.remove('show');
                    break;
                default:
                    acaoRealizada = false;
                    break;
            }
            
            if (acaoRealizada) {
                salvarLocal();
                sincronizarLayoutCompleto();
            }
        }

        function moverVagaIndividual(vaga, dx, dy) {
            const id = vaga.id;
            const container = document.getElementById('mapa-estacionamento');
            let novoX = (posicaoVagas[id].x || 0) + dx;
            let novoY = (posicaoVagas[id].y || 0) + dy;
            novoX = Math.max(0, Math.min(novoX, container.offsetWidth - vaga.offsetWidth));
            novoY = Math.max(0, Math.min(novoY, container.offsetHeight - vaga.offsetHeight));
            posicaoVagas[id].x = novoX;
            posicaoVagas[id].y = novoY;
            vaga.style.left = `${novoX}px`;
            vaga.style.top = `${novoY}px`;
        }

        function rotacionarVagaIndividual(vaga, graus) {
            const id = vaga.id;
            const novoAngulo = ((posicaoVagas[id].angle || 0) + graus) % 360;
            posicaoVagas[id].angle = novoAngulo;
            const transformProps = vaga.style.transform.replace(/rotate\([^)]*\)/, '').trim();
            vaga.style.transform = `${transformProps} rotate(${novoAngulo}deg)`;
        }

        function redimensionarVagaIndividual(vaga, dimensao, valor) {
            const id = vaga.id;
            if (!posicaoVagas[id].width) posicaoVagas[id].width = vaga.offsetWidth;
            if (!posicaoVagas[id].height) posicaoVagas[id].height = vaga.offsetHeight;

            if (dimensao === 'width') {
                posicaoVagas[id].width = Math.max(20, posicaoVagas[id].width + valor);
                vaga.style.width = `${posicaoVagas[id].width}px`;
            } else {
                posicaoVagas[id].height = Math.max(20, posicaoVagas[id].height + valor);
                vaga.style.height = `${posicaoVagas[id].height}px`;
            }
        }

        function excluirVagasSelecionadas() {
            const alvos = vagasMultiplasSelecao.length > 0 ? vagasMultiplasSelecao : (vagaSelecionada ? [vagaSelecionada] : []);
            if (alvos.length === 0) return;
            alvos.forEach(vaga => {
                delete estadoVagas[vaga.id];
                delete posicaoVagas[vaga.id];
                vaga.remove();
                totalVagas--;
            });
            limparSelecaoMultipla();
            if (vagaSelecionada) vagaSelecionada = null;
            document.getElementById('edit-controls').classList.remove('show');
            atualizarEstatisticas();
            sincronizarLayoutCompleto();
        }

        function inicializarVagas() {
            var posicoesDefault = [
                {id: 'V01', x: 50, y: 50}, {id: 'V02', x: 100, y: 50}, {id: 'V03', x: 150, y: 50},
                {id: 'V04', x: 200, y: 50}, {id: 'V05', x: 250, y: 50}, {id: 'V06', x: 300, y: 50},
                {id: 'V07', x: 350, y: 50}, {id: 'V08', x: 400, y: 50}, {id: 'V09', x: 450, y: 50},
                {id: 'V10', x: 500, y: 50}, {id: 'V11', x: 50, y: 150}, {id: 'V12', x: 100, y: 150},
                {id: 'V13', x: 150, y: 150}, {id: 'V14', x: 200, y: 150}, {id: 'V15', x: 250, y: 150},
                {id: 'V16', x: 300, y: 150}, {id: 'V17', x: 350, y: 150}, {id: 'V18', x: 400, y: 150},
                {id: 'V19', x: 450, y: 150}, {id: 'V20', x: 500, y: 150}, {id: 'V21', x: 50, y: 250},
                {id: 'V22', x: 100, y: 250}, {id: 'V23', x: 150, y: 250}, {id: 'V24', x: 200, y: 250},
                {id: 'V25', x: 250, y: 250}, {id: 'V26', x: 300, y: 250}, {id: 'V27', x: 350, y: 250},
                {id: 'V28', x: 400, y: 250}, {id: 'V29', x: 450, y: 250}, {id: 'V30', x: 500, y: 250},
                {id: 'V31', x: 50, y: 350}, {id: 'V32', x: 100, y: 350}, {id: 'V33', x: 150, y: 350},
                {id: 'V34', x: 200, y: 350}, {id: 'V35', x: 250, y: 350}, {id: 'V36', x: 300, y: 350},
                {id: 'V37', x: 350, y: 350}, {id: 'V38', x: 400, y: 350}, {id: 'V39', x: 450, y: 350},
                {id: 'V40', x: 500, y: 350}, {id: 'V41', x: 50, y: 450}, {id: 'V42', x: 100, y: 450},
                {id: 'V43', x: 150, y: 450}, {id: 'V44', x: 200, y: 450}, {id: 'V45', x: 250, y: 450},
                {id: 'V46', x: 300, y: 450}, {id: 'V47', x: 350, y: 450}, {id: 'V48', x: 400, y: 450},
                {id: 'V49', x: 450, y: 450}, {id: 'V50', x: 500, y: 450}, {id: 'V51', x: 50, y: 550},
                {id: 'V52', x: 100, y: 550}, {id: 'V53', x: 150, y: 550}, {id: 'V54', x: 200, y: 550},
                {id: 'V55', x: 250, y: 550}, {id: 'V56', x: 300, y: 550}, {id: 'V57', x: 350, y: 550},
                {id: 'V58', x: 400, y: 550}, {id: 'V59', x: 450, y: 550}, {id: 'V60', x: 500, y: 550},
                {id: 'V61', x: 275, y: 650}, {id: 'V62', x: 325, y: 650}
            ];
            
            totalVagas = 0;
            proximoIdVaga = 1;
            document.getElementById('mapa-estacionamento').innerHTML = '<div class="planta-baixa" id="planta-baixa"></div>';
            
            var posicoesParaUsar = Object.keys(posicaoVagas).length > 0 ? posicaoVagas : {};
            if (Object.keys(posicoesParaUsar).length === 0) {
                posicoesDefault.forEach(p => { posicoesParaUsar[p.id] = { x: p.x, y: p.y }; });
            }

            for (const vagaId in posicoesParaUsar) {
                if (posicoesParaUsar.hasOwnProperty(vagaId)) {
                    totalVagas++;
                    const numId = parseInt(vagaId.replace(/\D/g, ''), 10);
                    if (!isNaN(numId) && numId >= proximoIdVaga) {
                        proximoIdVaga = numId + 1;
                    }
                    const pos = posicoesParaUsar[vagaId];
                    const vaga = criarVaga(vagaId, pos.x, pos.y);
                    if (pos.width) vaga.style.width = `${pos.width}px`;
                    if (pos.height) vaga.style.height = `${pos.height}px`;
                    if (pos.angle) vaga.style.transform = `rotate(${pos.angle}deg)`;
                    
                    if (estadoVagas[vagaId]) {
                        vaga.classList.remove('livre', 'ocupada');
                        vaga.classList.add(estadoVagas[vagaId]);
                    }
                }
            }
            
            atualizarEstatisticas();
            aplicarModoVisualizacao();
        }

        function criarVaga(id, x, y) {
            var vaga = document.createElement('div');
            vaga.id = id;
            vaga.className = 'vaga livre';
            vaga.textContent = id;
            vaga.style.left = `${x}px`;
            vaga.style.top = `${y}px`;
            
            vaga.addEventListener('click', function() {
                if (modoEdicao) {
                    selecionarVaga(this);
                } else if (tipoUsuario === 'admin') {
                    if (this.classList.contains('livre')) {
                        this.classList.remove('livre');
                        this.classList.add('ocupada');
                        estadoVagas[id] = 'ocupada';
                    } else {
                        this.classList.remove('ocupada');
                        this.classList.add('livre');
                        estadoVagas[id] = 'livre';
                    }
                    atualizarEstatisticas();
                    sincronizarEstadoVaga(id, estadoVagas[id]);
                }
            });

            vaga.addEventListener('mousedown', iniciarArraste);
            document.getElementById('mapa-estacionamento').appendChild(vaga);
            
            if (!posicaoVagas[id]) posicaoVagas[id] = {};
            posicaoVagas[id].x = x;
            posicaoVagas[id].y = y;
            if (!estadoVagas[id]) estadoVagas[id] = 'livre';

            return vaga;
        }

        function adicionarNovaVaga() {
            if (tipoUsuario !== 'admin') return;
            var novoId = 'V' + String(proximoIdVaga).padStart(2, '0');
            criarVaga(novoId, 50, 50);
            proximoIdVaga++;
            totalVagas++;
            atualizarEstatisticas();
            sincronizarLayoutCompleto();
        }
        
        function duplicarVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var pos = posicaoVagas[vagaSelecionada.id];
            var novoId = 'V' + String(proximoIdVaga).padStart(2, '0');
            var vagaDuplicada = criarVaga(novoId, pos.x + 20, pos.y + 20);
            
            posicaoVagas[novoId] = { ...pos, x: pos.x + 20, y: pos.y + 20 };
            if (pos.width) vagaDuplicada.style.width = `${pos.width}px`;
            if (pos.height) vagaDuplicada.style.height = `${pos.height}px`;
            if (pos.angle) vagaDuplicada.style.transform = `rotate(${pos.angle}deg)`;
            
            proximoIdVaga++;
            totalVagas++;
            atualizarEstatisticas();
            sincronizarLayoutCompleto();
        }

        function renomearVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            var novoNome = prompt("Digite o novo nome para a vaga:", vagaSelecionada.id);
            if (novoNome && novoNome.trim() !== "" && !document.getElementById(novoNome.trim())) {
                var antigoId = vagaSelecionada.id;
                var novoId = novoNome.trim();

                posicaoVagas[novoId] = posicaoVagas[antigoId];
                estadoVagas[novoId] = estadoVagas[antigoId];
                delete posicaoVagas[antigoId];
                delete estadoVagas[antigoId];

                vagaSelecionada.id = novoId;
                vagaSelecionada.textContent = novoId;
                document.getElementById('vaga-selecionada').textContent = novoId;

                sincronizarLayoutCompleto();
                mostrarNotificacao(`Vaga ${antigoId} renomeada para ${novoId}`, 'sucesso');
            } else {
                mostrarNotificacao('Nome inválido ou já existente.', 'erro');
            }
        }
        
        function centralizarVaga() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            const container = document.getElementById('mapa-estacionamento');
            const vaga = vagaSelecionada;
            const novoX = (container.offsetWidth - vaga.offsetWidth) / 2;
            const novoY = (container.offsetHeight - vaga.offsetHeight) / 2;
            moverVagaIndividual(vaga, novoX - posicaoVagas[vaga.id].x, novoY - posicaoVagas[vaga.id].y);
            salvarLocal();
            sincronizarLayoutCompleto();
        }

        function resetarRotacao() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            const id = vagaSelecionada.id;
            posicaoVagas[id].angle = 0;
            vagaSelecionada.style.transform = '';
            salvarLocal();
            sincronizarLayoutCompleto();
        }

        function resetarTamanho() {
            if (!vagaSelecionada || tipoUsuario !== 'admin') return;
            const id = vagaSelecionada.id;
            delete posicaoVagas[id].width;
            delete posicaoVagas[id].height;
            vagaSelecionada.style.width = '';
            vagaSelecionada.style.height = '';
            salvarLocal();
            sincronizarLayoutCompleto();
        }

        function atualizarEstatisticas() {
            var vagasLivres = 0;
            var vagasOcupadas = 0;
            
            Object.values(estadoVagas).forEach(estado => {
                if (estado === 'livre') vagasLivres++;
                else vagasOcupadas++;
            });

            document.getElementById('total-vagas').textContent = totalVagas;
            document.getElementById('vagas-livres').textContent = vagasLivres;
            document.getElementById('vagas-ocupadas').textContent = vagasOcupadas;
            var taxa = totalVagas > 0 ? (vagasOcupadas / totalVagas * 100).toFixed(0) : 0;
            document.getElementById('taxa-ocupacao').textContent = `${taxa}%`;
        }
        
        function resetarTodasVagas() { if(confirm('Resetar todas as vagas para o estado inicial?')) { Object.keys(estadoVagas).forEach(id => { estadoVagas[id] = 'livre'; document.getElementById(id)?.classList.remove('ocupada'); document.getElementById(id)?.classList.add('livre'); }); atualizarEstatisticas(); sincronizarEstadoCompleto(); } }
        function ocuparTodasVagas() { if(confirm('Ocupar todas as vagas?')) { Object.keys(estadoVagas).forEach(id => { estadoVagas[id] = 'ocupada'; document.getElementById(id)?.classList.remove('livre'); document.getElementById(id)?.classList.add('ocupada'); }); atualizarEstatisticas(); sincronizarEstadoCompleto(); } }
        function liberarTodasVagas() { if(confirm('Liberar todas as vagas?')) { Object.keys(estadoVagas).forEach(id => { estadoVagas[id] = 'livre'; document.getElementById(id)?.classList.remove('ocupada'); document.getElementById(id)?.classList.add('livre'); }); atualizarEstatisticas(); sincronizarEstadoCompleto(); } }
        function salvarEstadoLocal() { salvarLocal(); }

        function salvarLocal() {
            var dados = {
                estadoVagas: estadoVagas,
                posicaoVagas: posicaoVagas,
                plantaConfig: plantaConfig,
                proximoIdVaga: proximoIdVaga
            };
            localStorage.setItem('dadosEstacionamento', JSON.stringify(dados));
            mostrarNotificacao('💾 Dados salvos localmente!', 'info');
        }

        function carregarLocal() {
            var dadosSalvos = localStorage.getItem('dadosEstacionamento');
            if (dadosSalvos) {
                var dados = JSON.parse(dadosSalvos);
                estadoVagas = dados.estadoVagas || {};
                posicaoVagas = dados.posicaoVagas || {};
                plantaConfig = dados.plantaConfig || {size: 'cover', posX: 50, posY: 50};
                proximoIdVaga = dados.proximoIdVaga || 63;
                aplicarConfigPlanta();
            }
        }
        
        function salvarNoFirebase() {
            if (!firebaseConectado || tipoUsuario !== 'admin') {
                mostrarNotificacao('❌ Conexão com Firebase ou permissão ausente.', 'erro');
                return;
            }
            if (confirm('Salvar o estado atual no Firebase? Isso sobrescreverá os dados existentes.')) {
                sincronizarLayoutCompleto();
                sincronizarEstadoCompleto();
                mostrarNotificacao('🌐 Enviando dados para o Firebase...', 'info');
            }
        }

        function inicializarFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                firebaseConectado = true;
                
                var statusEl = document.getElementById('status-firebase');
                statusEl.classList.remove('desconectado');
                statusEl.classList.add('conectado');
                document.getElementById('texto-firebase').textContent = 'Firebase Conectado';

                carregarDoFirebase();

                database.ref('estadoVagas').on('value', (snapshot) => {
                    const dados = snapshot.val();
                    if (dados) {
                        estadoVagas = dados;
                        Object.keys(estadoVagas).forEach(id => {
                            var vaga = document.getElementById(id);
                            if (vaga) {
                                vaga.classList.remove('livre', 'ocupada');
                                vaga.classList.add(estadoVagas[id]);
                            }
                        });
                        atualizarEstatisticas();
                        document.getElementById('ultima-atualizacao').textContent = new Date().toLocaleTimeString();
                    }
                });

                database.ref('layout').on('value', (snapshot) => {
                    const dados = snapshot.val();
                    if (dados) {
                        posicaoVagas = dados.posicaoVagas || {};
                        plantaConfig = dados.plantaConfig || {size: 'cover', posX: 50, posY: 50};
                        proximoIdVaga = dados.proximoIdVaga || 63;
                        inicializarVagas();
                        aplicarConfigPlanta();
                        mostrarNotificacao('🔄 Layout atualizado do Firebase!', 'info');
                    }
                });

            } catch (e) {
                console.error("Erro Firebase:", e);
                var statusEl = document.getElementById('status-firebase');
                statusEl.classList.remove('conectado');
                statusEl.classList.add('desconectado');
                document.getElementById('texto-firebase').textContent = 'Erro Firebase';
            }
        }

        function carregarDoFirebase() {
            if (!firebaseConectado) return;
            database.ref('/').once('value').then((snapshot) => {
                const dados = snapshot.val();
                if (dados) {
                    estadoVagas = dados.estadoVagas || {};
                    posicaoVagas = dados.layout?.posicaoVagas || {};
                    plantaConfig = dados.layout?.plantaConfig || {size: 'cover', posX: 50, posY: 50};
                    proximoIdVaga = dados.layout?.proximoIdVaga || 63;
                    inicializarVagas();
                    aplicarConfigPlanta();
                    mostrarNotificacao('✅ Dados carregados do Firebase', 'sucesso');
                } else {
                    mostrarNotificacao('ℹ️ Nenhum dado encontrado no Firebase. Usando dados locais.', 'info');
                }
            });
        }
        
        function sincronizarEstadoVaga(vagaId, estado) { if (firebaseConectado) database.ref('estadoVagas/' + vagaId).set(estado); }
        function sincronizarEstadoCompleto() { if (firebaseConectado) database.ref('estadoVagas').set(estadoVagas); }
        function sincronizarLayoutCompleto() { if (firebaseConectado && tipoUsuario === 'admin') { database.ref('layout').set({ posicaoVagas, plantaConfig, proximoIdVaga }); } }
        
        function mostrarNotificacao(mensagem, tipo = 'info') {
            var el = document.createElement('div');
            el.className = `notificacao ${tipo}`;
            el.textContent = mensagem;
            document.body.appendChild(el);
            setTimeout(() => { el.classList.add('mostrar'); }, 10);
            setTimeout(() => { el.classList.remove('mostrar'); setTimeout(() => el.remove(), 300); }, 3000);
        }

        function exportarLayout() {
            const dados = { posicaoVagas, plantaConfig, proximoIdVaga };
            const blob = new Blob([JSON.stringify(dados, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'layout_estacionamento.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importarLayout() { document.getElementById('import-input').click(); }
        
        function processarImportacao(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const dados = JSON.parse(e.target.result);
                        posicaoVagas = dados.posicaoVagas || {};
                        plantaConfig = dados.plantaConfig || {size: 'cover', posX: 50, posY: 50};
                        proximoIdVaga = dados.proximoIdVaga || 63;
                        inicializarVagas();
                        aplicarConfigPlanta();
                        mostrarNotificacao('✅ Layout importado com sucesso!', 'sucesso');
                    } catch (error) {
                        mostrarNotificacao('❌ Erro ao ler o arquivo JSON.', 'erro');
                    }
                };
                reader.readAsText(file);
            }
        }

        function carregarPlantaBaixa() { document.getElementById('planta-input').click(); }
        
        function processarPlantaBaixa(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const plantaEl = document.getElementById('planta-baixa');
                    plantaEl.style.backgroundImage = `url('${e.target.result}')`;
                    plantaConfig.url = e.target.result;
                    salvarLocal();
                    sincronizarLayoutCompleto();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function aplicarConfigPlanta() {
            const plantaEl = document.getElementById('planta-baixa');
            if (plantaConfig.url) plantaEl.style.backgroundImage = `url('${plantaConfig.url}')`;
            plantaEl.style.backgroundSize = plantaConfig.size || 'cover';
            plantaEl.style.backgroundPosition = `${plantaConfig.posX || 50}% ${plantaConfig.posY || 50}%`;
        }

        function ajustarPlanta(tipo) { plantaConfig.size = tipo; aplicarConfigPlanta(); }
        function centralizarPlanta() { plantaConfig.posX = 50; plantaConfig.posY = 50; aplicarConfigPlanta(); }
        function resetarPlanta() { plantaConfig = {size: 'cover', posX: 50, posY: 50, url: plantaConfig.url}; aplicarConfigPlanta(); }
        
        function iniciarArrastePainel(e, painelId) {
            if (!modoEdicao) return;
            painelArrastando = document.getElementById(painelId);
            painelArrastando.classList.add('dragging');
            const rect = painelArrastando.getBoundingClientRect();
            offsetPainelX = e.clientX - rect.left;
            offsetPainelY = e.clientY - rect.top;
        }

        function arrastarPainel(e) {
            if (!painelArrastando) return;
            e.preventDefault();
            let x = e.clientX - offsetPainelX;
            let y = e.clientY - offsetPainelY;
            painelArrastando.style.left = `${x}px`;
            painelArrastando.style.top = `${y}px`;
        }

        function finalizarArrastePainel() {
            if (painelArrastando) {
                painelArrastando.classList.remove('dragging');
                painelArrastando = null;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            carregarLocal();
            inicializarVagas();
            inicializarFirebase();
            document.addEventListener('mousemove', arrastar);
            document.addEventListener('mouseup', finalizarArraste);
            document.addEventListener('keydown', lidarComTeclado);
            
            document.querySelector('#zoom-controls h4').addEventListener('mousedown', (e) => iniciarArrastePainel(e, 'zoom-controls'));
            document.querySelector('#planta-controls h4').addEventListener('mousedown', (e) => iniciarArrastePainel(e, 'planta-controls'));
            
            const planta = document.getElementById('planta-baixa');
            let isDraggingPlanta = false;
            let startX, startY;
            planta.addEventListener('mousedown', (e) => {
                if (editandoPlanta) {
                    isDraggingPlanta = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    planta.style.cursor = 'grabbing';
                }
            });
            document.addEventListener('mousemove', (e) => {
                if (isDraggingPlanta) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    plantaConfig.posX += dx * 0.1;
                    plantaConfig.posY += dy * 0.1;
                    plantaConfig.posX = Math.max(0, Math.min(100, plantaConfig.posX));
                    plantaConfig.posY = Math.max(0, Math.min(100, plantaConfig.posY));
                    aplicarConfigPlanta();
                    startX = e.clientX;
                    startY = e.clientY;
                }
            });
            document.addEventListener('mouseup', () => {
                if (isDraggingPlanta) {
                    isDraggingPlanta = false;
                    planta.style.cursor = 'default';
                }
            });
        });

    </script>
</body>
</html>
